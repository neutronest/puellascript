# PuellaScript

[![Build Status](https://travis-ci.org/TerrorJack/puellascript.svg)](https://travis-ci.org/TerrorJack/puellascript)

A proof-of-concept Haskell to WebAssembly compiler. The design goal is to implement:

* A framework to interface with GHC & Cabal and extract IRs
* A backend to translate STG/Cmm to WebAssembly binary code
* An rts written in WebAssembly to provide storage management, essential primops and FFI
* A packaging tool to group output into ECMAScript 6 modules and interact with foreign JavaScript toolchains like `npm`, `webpack`, etc

Currently we can extract multiple IRs from a set of target modules by invoking `ghc --make` and using hooks. It is not Cabal-aware yet. The next target is to retrieve STG/Cmm for wired-in packages, after which we can start delivering a working example.

This project works with GHC HEAD. [haddock docs](https://terrorjack.github.io/puellascript/haddock) is available (not always in sync though).

## Building

When using `cabal` to build, make sure to specify a package database other than the global/user package database (for example, a sandbox). The `Setup.hs` script assumes `puellascript` is installed to a `SpecificPackageDB` and that package database will be used for booting.

This project depends solely on ghc boot libraries, so you can also use `ghc Setup.hs && ./Setup ...` to do the job.

`stack ghci` is broken for now, use `cabal` for interactive development.

## Booting

Run `boot.sh` to boot. The boot directory is hard-coded to `$PWD/.boot`. This requires `ghc`, `ghc-pkg` and `phc` (our wrapper program of `ghc`) present on `$PATH`.

The booting process will create a fresh package database and install `rts`, `ghc-prim`, `integer-gmp` and `base`. The source code is ported from ghc repository. All C source files and `foreign import`s are stripped and replaced with dummy implementations. We don't need those anyway, since the real purpose is to retrieve STG/Cmm for wired-in packages, and lots of them won't be supported in the forseeable future.

This may fail on platforms other than x86-64 Linux, since we also pasted some headers generated by regular `configure` scripts of ghc.

## Credits

Thanks to [Joachim Breitner](https://github.com/nomeata) and his [veggies](https://github.com/nomeata/veggies) project for a good example of booting wired-in packages.
