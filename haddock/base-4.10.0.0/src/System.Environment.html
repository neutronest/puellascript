<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Safe #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Module      :  System.Environment</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow 2001</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Maintainer  :  libraries@haskell.org</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Stability   :  provisional</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Portability :  portable</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- Miscellaneous information about the system environment.</span><span>
</span><a name="line-15"></a><span class="hs-comment">--</span><span>
</span><a name="line-16"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Environment</span><span>
</span><a name="line-19"></a><span>    </span><span class="hs-special">(</span><span>
</span><a name="line-20"></a><span>      </span><a href="System.Environment.html#getArgs"><span class="hs-identifier hs-var">getArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>      </span><a href="System.Environment.html#getProgName"><span class="hs-identifier hs-var">getProgName</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>      </span><a href="System.Environment.ExecutablePath.html#getExecutablePath"><span class="hs-identifier hs-var">getExecutablePath</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>      </span><a href="System.Environment.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>      </span><a href="System.Environment.html#lookupEnv"><span class="hs-identifier hs-var">lookupEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>      </span><a href="System.Environment.html#setEnv"><span class="hs-identifier hs-var">setEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>      </span><a href="System.Environment.html#unsetEnv"><span class="hs-identifier hs-var">unsetEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>      </span><a href="System.Environment.html#withArgs"><span class="hs-identifier hs-var">withArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>      </span><a href="System.Environment.html#withProgName"><span class="hs-identifier hs-var">withProgName</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>      </span><a href="System.Environment.html#getEnvironment"><span class="hs-identifier hs-var">getEnvironment</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.html"><span class="hs-identifier">Foreign</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.C.html"><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">C</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="System.IO.Error.html"><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span></a><span> </span><span class="hs-special">(</span><a href="System.IO.Error.html#mkIOError"><span class="hs-identifier hs-var">mkIOError</span></a><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Exception.Base.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span class="hs-operator">.</span><span class="hs-identifier">Base</span></a><span> </span><span class="hs-special">(</span><a href="Control.Exception.Base.html#bracket_"><span class="hs-identifier hs-var">bracket_</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span class="hs-operator">.</span><span class="hs-identifier">Base</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bracket</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- import GHC.IO</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Exception.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Encoding.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Encoding</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Encoding.html#getFileSystemEncoding"><span class="hs-identifier hs-var">getFileSystemEncoding</span></a><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.Foreign.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Foreign</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-44"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Environment</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Windows</span><span>
</span><a name="line-47"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="System.Posix.Internals.html"><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Posix</span><span class="hs-operator">.</span><span class="hs-identifier">Internals</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#withFilePath"><span class="hs-identifier hs-var">withFilePath</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="System.Environment.ExecutablePath.html"><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Environment</span><span class="hs-operator">.</span><span class="hs-identifier">ExecutablePath</span></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-54"></a><span class="hs-cpp"># if defined(i386_HOST_ARCH)</span><span>
</span><a name="line-55"></a><span class="hs-cpp">#  define WINDOWS_CCONV stdcall</span><span>
</span><a name="line-56"></a><span class="hs-cpp"># elif defined(x86_64_HOST_ARCH)</span><span>
</span><a name="line-57"></a><span class="hs-cpp">#  define WINDOWS_CCONV ccall</span><span>
</span><a name="line-58"></a><span class="hs-cpp"># else</span><span>
</span><a name="line-59"></a><span class="hs-cpp">#  error Unknown mingw32 arch</span><span>
</span><a name="line-60"></a><span class="hs-cpp"># endif</span><span>
</span><a name="line-61"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-cpp">#include &quot;HsBaseConfig.h&quot;</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- getArgs, getProgName, getEnv</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">{-
Note [Ignore hs_init argv]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Ignore the arguments to hs_init on Windows for the sake of Unicode compat

Instead on Windows we get the list of arguments from getCommandLineW and
filter out arguments which the RTS would not have passed along.

This is done to ensure we get the arguments in proper Unicode Encoding which
the RTS at this moment does not seem provide. The filtering has to match the
one done by the RTS to avoid inconsistencies like #13287.
-}</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-identifier">getWin32ProgArgv_certainly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">String</span><span class="hs-special">]</span><span>
</span><a name="line-84"></a><span class="hs-identifier">getWin32ProgArgv_certainly</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>        </span><span class="hs-identifier">mb_argv</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getWin32ProgArgv</span><span>
</span><a name="line-86"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">mb_argv</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-87"></a><span>          </span><span class="hs-comment">-- see Note [Ignore hs_init argv]</span><span>
</span><a name="line-88"></a><span>          </span><span class="hs-identifier">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-identifier">getFullArgs</span><span>
</span><a name="line-89"></a><span>          </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">argv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">argv</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-identifier">withWin32ProgArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">a</span><span>
</span><a name="line-92"></a><span class="hs-identifier">withWin32ProgArgv</span><span> </span><span class="hs-identifier">argv</span><span> </span><span class="hs-identifier">act</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bracket</span><span> </span><span class="hs-identifier">begin</span><span> </span><span class="hs-identifier">setWin32ProgArgv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">act</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-identifier">begin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-95"></a><span>          </span><span class="hs-identifier">mb_old_argv</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getWin32ProgArgv</span><span>
</span><a name="line-96"></a><span>          </span><span class="hs-identifier">setWin32ProgArgv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">argv</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>          </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">mb_old_argv</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-identifier">getWin32ProgArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span class="hs-identifier">getWin32ProgArgv</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">alloca</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">p_argc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">alloca</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">p_argv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-identifier">c_getWin32ProgArgv</span><span> </span><span class="hs-identifier">p_argc</span><span> </span><span class="hs-identifier">p_argv</span><span>
</span><a name="line-102"></a><span>        </span><span class="hs-identifier">argc</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">p_argc</span><span>
</span><a name="line-103"></a><span>        </span><span class="hs-identifier">argv_p</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">p_argv</span><span>
</span><a name="line-104"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">argv_p</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">nullPtr</span><span>
</span><a name="line-105"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-106"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-107"></a><span>          </span><span class="hs-identifier">argv_ps</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peekArray</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">argc</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">argv_p</span><span>
</span><a name="line-108"></a><span>          </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">mapM</span><span> </span><span class="hs-identifier">peekCWString</span><span> </span><span class="hs-identifier">argv_ps</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-identifier">setWin32ProgArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span class="hs-identifier">setWin32ProgArgv</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">c_setWin32ProgArgv</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">nullPtr</span><span>
</span><a name="line-112"></a><span class="hs-identifier">setWin32ProgArgv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">argv</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withMany</span><span> </span><span class="hs-identifier">withCWString</span><span> </span><span class="hs-identifier">argv</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">argv_ps</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">withArrayLen</span><span> </span><span class="hs-identifier">argv_ps</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">argc</span><span> </span><span class="hs-identifier">argv_p</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-identifier">c_setWin32ProgArgv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">argc</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">argv_p</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;getWin32ProgArgv&quot;</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-identifier">c_getWin32ProgArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CWString</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;setWin32ProgArgv&quot;</span><span>
</span><a name="line-119"></a><span>  </span><span class="hs-identifier">c_setWin32ProgArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CWString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-comment">-- See Note [Ignore hs_init argv]</span><span>
</span><a name="line-122"></a><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">String</span><span class="hs-special">]</span><span>
</span><a name="line-123"></a><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-124"></a><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-identifier">rest</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-string">&quot;--&quot;</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rest</span><span>
</span><a name="line-125"></a><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;+RTS&quot;</span><span class="hs-glyph">:</span><span class="hs-identifier">rest</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dropWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator">/=</span><span> </span><span class="hs-string">&quot;-RTS&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">rest</span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;--RTS&quot;</span><span class="hs-glyph">:</span><span class="hs-identifier">rest</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rest</span><span>
</span><a name="line-127"></a><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-RTS&quot;</span><span class="hs-glyph">:</span><span class="hs-identifier">rest</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-identifier">rest</span><span>
</span><a name="line-128"></a><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">arg</span><span class="hs-glyph">:</span><span class="hs-identifier">rest</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">arg</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">dropRTSArgs</span><span> </span><span class="hs-identifier">rest</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-comment">-- | Computation 'getArgs' returns a list of the program's command</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- line arguments (not including the program name).</span><span>
</span><a name="line-134"></a><span class="hs-identifier">getArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">[</span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">]</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-137"></a><span class="hs-identifier">getArgs</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">tail</span><span> </span><span class="hs-identifier">getWin32ProgArgv_certainly</span><span>
</span><a name="line-138"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-139"></a><a name="getArgs"><a href="System.Environment.html#getArgs"><span class="hs-identifier">getArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-140"></a><span>  </span><a href="Foreign.Marshal.Alloc.html#alloca"><span class="hs-identifier hs-var">alloca</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679333364"><a href="#local-6989586621679333364"><span class="hs-identifier">p_argc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-141"></a><span>  </span><a href="Foreign.Marshal.Alloc.html#alloca"><span class="hs-identifier hs-var">alloca</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679333365"><a href="#local-6989586621679333365"><span class="hs-identifier">p_argv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-142"></a><span>   </span><a href="System.Environment.html#getProgArgv"><span class="hs-identifier hs-var">getProgArgv</span></a><span> </span><a href="#local-6989586621679333364"><span class="hs-identifier hs-var">p_argc</span></a><span> </span><a href="#local-6989586621679333365"><span class="hs-identifier hs-var">p_argv</span></a><span>
</span><a name="line-143"></a><span>   </span><a name="local-6989586621679333366"><a href="#local-6989586621679333366"><span class="hs-identifier">p</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#liftM"><span class="hs-identifier hs-var">liftM</span></a><span class="hs-special">`</span><span> </span><a href="Foreign.Storable.html#peek"><span class="hs-identifier hs-var">peek</span></a><span> </span><a href="#local-6989586621679333364"><span class="hs-identifier hs-var">p_argc</span></a><span>
</span><a name="line-144"></a><span>   </span><a name="local-6989586621679333367"><a href="#local-6989586621679333367"><span class="hs-identifier">argv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.Storable.html#peek"><span class="hs-identifier hs-var">peek</span></a><span> </span><a href="#local-6989586621679333365"><span class="hs-identifier hs-var">p_argv</span></a><span>
</span><a name="line-145"></a><span>   </span><a name="local-6989586621679333368"><a href="#local-6989586621679333368"><span class="hs-identifier">enc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Encoding.html#getFileSystemEncoding"><span class="hs-identifier hs-var">getFileSystemEncoding</span></a><span>
</span><a name="line-146"></a><span>   </span><a href="Foreign.Marshal.Array.html#peekArray"><span class="hs-identifier hs-var">peekArray</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679333366"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Foreign.Marshal.Array.html#advancePtr"><span class="hs-identifier hs-var">advancePtr</span></a><span> </span><a href="#local-6989586621679333367"><span class="hs-identifier hs-var">argv</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Foreign.html#peekCString"><span class="hs-identifier hs-var">GHC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">peekCString</span></a><span> </span><a href="#local-6989586621679333368"><span class="hs-identifier hs-var">enc</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;getProgArgv&quot;</span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-identifier">getProgArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="Foreign.C.String.html#CString"><span class="hs-identifier hs-type">CString</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-comment">{-|
Computation 'getProgName' returns the name of the program as it was
invoked.

However, this is hard-to-impossible to implement on some non-Unix
OSes, so instead, for maximum portability, we just return the leafname
of the program as invoked. Even then there are some differences
between platforms: on Windows, for example, a program invoked as foo
is probably really @FOO.EXE@, and that is what 'getProgName' will return.
-}</span><span>
</span><a name="line-162"></a><span class="hs-identifier">getProgName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span>
</span><a name="line-163"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- Ignore the arguments to hs_init on Windows for the sake of Unicode compat</span><span>
</span><a name="line-165"></a><span class="hs-identifier">getProgName</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">basename</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">head</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">getWin32ProgArgv_certainly</span><span>
</span><a name="line-166"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-167"></a><a name="getProgName"><a href="System.Environment.html#getProgName"><span class="hs-identifier">getProgName</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-168"></a><span>  </span><a href="Foreign.Marshal.Alloc.html#alloca"><span class="hs-identifier hs-var">alloca</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679333369"><a href="#local-6989586621679333369"><span class="hs-identifier">p_argc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-169"></a><span>  </span><a href="Foreign.Marshal.Alloc.html#alloca"><span class="hs-identifier hs-var">alloca</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679333370"><a href="#local-6989586621679333370"><span class="hs-identifier">p_argv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-170"></a><span>     </span><a href="System.Environment.html#getProgArgv"><span class="hs-identifier hs-var">getProgArgv</span></a><span> </span><a href="#local-6989586621679333369"><span class="hs-identifier hs-var">p_argc</span></a><span> </span><a href="#local-6989586621679333370"><span class="hs-identifier hs-var">p_argv</span></a><span>
</span><a name="line-171"></a><span>     </span><a name="local-6989586621679333371"><a href="#local-6989586621679333371"><span class="hs-identifier">argv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.Storable.html#peek"><span class="hs-identifier hs-var">peek</span></a><span> </span><a href="#local-6989586621679333370"><span class="hs-identifier hs-var">p_argv</span></a><span>
</span><a name="line-172"></a><span>     </span><a href="System.Environment.html#unpackProgName"><span class="hs-identifier hs-var">unpackProgName</span></a><span> </span><a href="#local-6989586621679333371"><span class="hs-identifier hs-var">argv</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-identifier">unpackProgName</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="Foreign.C.Types.html#CChar"><span class="hs-identifier hs-type">CChar</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span>   </span><span class="hs-comment">-- argv[0]</span><span>
</span><a name="line-175"></a><a name="unpackProgName"><a href="System.Environment.html#unpackProgName"><span class="hs-identifier">unpackProgName</span></a></a><span> </span><a name="local-6989586621679333372"><a href="#local-6989586621679333372"><span class="hs-identifier">argv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-176"></a><span>  </span><a name="local-6989586621679333373"><a href="#local-6989586621679333373"><span class="hs-identifier">enc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Encoding.html#getFileSystemEncoding"><span class="hs-identifier hs-var">getFileSystemEncoding</span></a><span>
</span><a name="line-177"></a><span>  </span><a name="local-6989586621679333374"><a href="#local-6989586621679333374"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a><span> </span><a href="#local-6989586621679333372"><span class="hs-identifier hs-var">argv</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="GHC.Foreign.html#peekCString"><span class="hs-identifier hs-var">GHC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">peekCString</span></a><span> </span><a href="#local-6989586621679333373"><span class="hs-identifier hs-var">enc</span></a><span>
</span><a name="line-178"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="System.Environment.html#basename"><span class="hs-identifier hs-var">basename</span></a><span> </span><a href="#local-6989586621679333374"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">basename</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span>
</span><a name="line-182"></a><a name="basename"><a href="System.Environment.html#basename"><span class="hs-identifier">basename</span></a></a><span> </span><a name="local-6989586621679333375"><a href="#local-6989586621679333375"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679333376"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679333375"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679333375"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-183"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-184"></a><span>  </span><a name="local-6989586621679333376"><a href="#local-6989586621679333376"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679333378"><a href="#local-6989586621679333378"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679333378"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-185"></a><span>  </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679333379"><a href="#local-6989586621679333379"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679333380"><a href="#local-6989586621679333380"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679333381"><a href="#local-6989586621679333381"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679333377"><span class="hs-identifier hs-var">isPathSeparator</span></a><span> </span><a href="#local-6989586621679333380"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679333376"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679333381"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679333381"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-187"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679333376"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679333379"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621679333381"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span>  </span><span class="hs-identifier">isPathSeparator</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Char"><span class="hs-identifier hs-type">Char</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-190"></a><span>  </span><a name="local-6989586621679333377"><a href="#local-6989586621679333377"><span class="hs-identifier">isPathSeparator</span></a></a><span> </span><span class="hs-char">'/'</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-191"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-192"></a><span>  </span><span class="hs-identifier">isPathSeparator</span><span> </span><span class="hs-char">'\\'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-193"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-identifier">isPathSeparator</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">-- | Computation 'getEnv' @var@ returns the value</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- of the environment variable @var@. For the inverse, POSIX users</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- can use 'System.Posix.Env.putEnv'.</span><span>
</span><a name="line-200"></a><span class="hs-comment">--</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- This computation may fail with:</span><span>
</span><a name="line-202"></a><span class="hs-comment">--</span><span>
</span><a name="line-203"></a><span class="hs-comment">--  * 'System.IO.Error.isDoesNotExistError' if the environment variable</span><span>
</span><a name="line-204"></a><span class="hs-comment">--    does not exist.</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-identifier">getEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span>
</span><a name="line-207"></a><a name="getEnv"><a href="System.Environment.html#getEnv"><span class="hs-identifier">getEnv</span></a></a><span> </span><a name="local-6989586621679333382"><a href="#local-6989586621679333382"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Environment.html#lookupEnv"><span class="hs-identifier hs-var">lookupEnv</span></a><span> </span><a href="#local-6989586621679333382"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a><span> </span><a href="#local-6989586621679333383"><span class="hs-identifier hs-var">handleError</span></a><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span>
</span><a name="line-208"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-209"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-210"></a><span>    </span><span class="hs-identifier">handleError</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-identifier">err</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">c_GetLastError</span><span>
</span><a name="line-212"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">err</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">eRROR_ENVVAR_NOT_FOUND</span><span>
</span><a name="line-213"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">ioe_missingEnvVar</span><span> </span><span class="hs-identifier">name</span><span>
</span><a name="line-214"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">throwGetLastError</span><span> </span><span class="hs-string">&quot;getEnv&quot;</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-identifier">eRROR_ENVVAR_NOT_FOUND</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">DWORD</span><span>
</span><a name="line-217"></a><span class="hs-identifier">eRROR_ENVVAR_NOT_FOUND</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">203</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">WINDOWS_CCONV</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;windows.h GetLastError&quot;</span><span>
</span><a name="line-220"></a><span>  </span><span class="hs-identifier">c_GetLastError</span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">DWORD</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-223"></a><span>    </span><a name="local-6989586621679333383"><a href="#local-6989586621679333383"><span class="hs-identifier">handleError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Environment.html#ioe_missingEnvVar"><span class="hs-identifier hs-var">ioe_missingEnvVar</span></a><span> </span><a href="#local-6989586621679333382"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-224"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">-- | Return the value of the environment variable @var@, or @Nothing@ if</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- there is no such value.</span><span>
</span><a name="line-228"></a><span class="hs-comment">--</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- For POSIX users, this is equivalent to 'System.Posix.Env.getEnv'.</span><span>
</span><a name="line-230"></a><span class="hs-comment">--</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- @since 4.6.0.0</span><span>
</span><a name="line-232"></a><span class="hs-identifier">lookupEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-234"></a><span class="hs-identifier">lookupEnv</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withCWString</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">s</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">try_size</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-number">256</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-identifier">try_size</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">allocaArray</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">size</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">p_value</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-237"></a><span>      </span><span class="hs-identifier">res</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">c_GetEnvironmentVariable</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">p_value</span><span> </span><span class="hs-identifier">size</span><span>
</span><a name="line-238"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">res</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-240"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">res</span><span> </span><span class="hs-operator">&gt;</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">try_size</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">res</span><span> </span><span class="hs-comment">-- Rare: size increased between calls to GetEnvironmentVariable</span><span>
</span><a name="line-241"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekCWString</span><span> </span><span class="hs-identifier">p_value</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">Just</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">WINDOWS_CCONV</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;windows.h GetEnvironmentVariableW&quot;</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-identifier">c_GetEnvironmentVariable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">LPWSTR</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">LPWSTR</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DWORD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">DWORD</span><span>
</span><a name="line-245"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-246"></a><a name="lookupEnv"><a href="System.Environment.html#lookupEnv"><span class="hs-identifier">lookupEnv</span></a></a><span> </span><a name="local-6989586621679333384"><a href="#local-6989586621679333384"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-247"></a><span>    </span><a href="Foreign.C.String.html#withCString"><span class="hs-identifier hs-var">withCString</span></a><span> </span><a href="#local-6989586621679333384"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679333385"><a href="#local-6989586621679333385"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-248"></a><span>      </span><a name="local-6989586621679333386"><a href="#local-6989586621679333386"><span class="hs-identifier">litstring</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.Environment.html#c_getenv"><span class="hs-identifier hs-var">c_getenv</span></a><span> </span><a href="#local-6989586621679333385"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-249"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679333386"><span class="hs-identifier hs-var">litstring</span></a><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><a href="GHC.Ptr.html#nullPtr"><span class="hs-identifier hs-var">nullPtr</span></a><span>
</span><a name="line-250"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679333387"><a href="#local-6989586621679333387"><span class="hs-identifier">enc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Encoding.html#getFileSystemEncoding"><span class="hs-identifier hs-var">getFileSystemEncoding</span></a><span>
</span><a name="line-251"></a><span>                </span><a name="local-6989586621679333388"><a href="#local-6989586621679333388"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Foreign.html#peekCString"><span class="hs-identifier hs-var">GHC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">peekCString</span></a><span> </span><a href="#local-6989586621679333387"><span class="hs-identifier hs-var">enc</span></a><span> </span><a href="#local-6989586621679333386"><span class="hs-identifier hs-var">litstring</span></a><span>
</span><a name="line-252"></a><span>                </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679333388"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-253"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;getenv&quot;</span><span>
</span><a name="line-256"></a><span>   </span><span class="hs-identifier">c_getenv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.String.html#CString"><span class="hs-identifier hs-type">CString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="Foreign.C.Types.html#CChar"><span class="hs-identifier hs-type">CChar</span></a><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-identifier">ioe_missingEnvVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333363"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-260"></a><a name="ioe_missingEnvVar"><a href="System.Environment.html#ioe_missingEnvVar"><span class="hs-identifier">ioe_missingEnvVar</span></a></a><span> </span><a name="local-6989586621679333389"><a href="#local-6989586621679333389"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#NoSuchThing"><span class="hs-identifier hs-var">NoSuchThing</span></a><span> </span><span class="hs-string">&quot;getEnv&quot;</span><span>
</span><a name="line-261"></a><span>    </span><span class="hs-string">&quot;no environment variable&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679333389"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-comment">-- | @setEnv name value@ sets the specified environment variable to @value@.</span><span>
</span><a name="line-264"></a><span class="hs-comment">--</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- On Windows setting an environment variable to the /empty string/ removes</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- that environment variable from the environment.  For the sake of</span><span>
</span><a name="line-267"></a><span class="hs-comment">-- compatibility we adopt that behavior.  In particular</span><span>
</span><a name="line-268"></a><span class="hs-comment">--</span><span>
</span><a name="line-269"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-270"></a><span class="hs-comment">-- setEnv name \&quot;\&quot;</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-272"></a><span class="hs-comment">--</span><span>
</span><a name="line-273"></a><span class="hs-comment">-- has the same effect as</span><span>
</span><a name="line-274"></a><span class="hs-comment">--</span><span>
</span><a name="line-275"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-276"></a><span class="hs-comment">-- `unsetEnv` name</span><span>
</span><a name="line-277"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-278"></a><span class="hs-comment">--</span><span>
</span><a name="line-279"></a><span class="hs-comment">-- If you don't care about Windows support and want to set an environment</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- variable to the empty string use @System.Posix.Env.setEnv@ from the @unix@</span><span>
</span><a name="line-281"></a><span class="hs-comment">-- package instead.</span><span>
</span><a name="line-282"></a><span class="hs-comment">--</span><span>
</span><a name="line-283"></a><span class="hs-comment">-- Throws `Control.Exception.IOException` if @name@ is the empty string or</span><span>
</span><a name="line-284"></a><span class="hs-comment">-- contains an equals sign.</span><span>
</span><a name="line-285"></a><span class="hs-comment">--</span><span>
</span><a name="line-286"></a><span class="hs-comment">-- @since 4.7.0.0</span><span>
</span><a name="line-287"></a><span class="hs-identifier">setEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-288"></a><a name="setEnv"><a href="System.Environment.html#setEnv"><span class="hs-identifier">setEnv</span></a></a><span> </span><a name="local-6989586621679333390"><a href="#local-6989586621679333390"><span class="hs-identifier">key_</span></a></a><span> </span><a name="local-6989586621679333391"><a href="#local-6989586621679333391"><span class="hs-identifier">value_</span></a></a><span>
</span><a name="line-289"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621679333392"><span class="hs-identifier hs-var">key</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a><span> </span><span class="hs-special">(</span><a href="System.IO.Error.html#mkIOError"><span class="hs-identifier hs-var">mkIOError</span></a><span> </span><a href="GHC.IO.Exception.html#InvalidArgument"><span class="hs-identifier hs-var">InvalidArgument</span></a><span> </span><span class="hs-string">&quot;setEnv&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-char">'='</span><span> </span><span class="hs-special">`</span><a href="Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679333392"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a><span> </span><span class="hs-special">(</span><a href="System.IO.Error.html#mkIOError"><span class="hs-identifier hs-var">mkIOError</span></a><span> </span><a href="GHC.IO.Exception.html#InvalidArgument"><span class="hs-identifier hs-var">InvalidArgument</span></a><span> </span><span class="hs-string">&quot;setEnv&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621679333393"><span class="hs-identifier hs-var">value</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="System.Environment.html#unsetEnv"><span class="hs-identifier hs-var">unsetEnv</span></a><span> </span><a href="#local-6989586621679333392"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="System.Environment.html#setEnv_"><span class="hs-identifier hs-var">setEnv_</span></a><span> </span><a href="#local-6989586621679333392"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621679333393"><span class="hs-identifier hs-var">value</span></a><span>
</span><a name="line-293"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-294"></a><span>    </span><a name="local-6989586621679333392"><a href="#local-6989586621679333392"><span class="hs-identifier">key</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="GHC.List.html#takeWhile"><span class="hs-identifier hs-var">takeWhile</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-special">'</span><span class="hs-glyph">\</span><span class="hs-identifier">NUL'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679333390"><span class="hs-identifier hs-var">key_</span></a><span>
</span><a name="line-295"></a><span>    </span><a name="local-6989586621679333393"><a href="#local-6989586621679333393"><span class="hs-identifier">value</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.List.html#takeWhile"><span class="hs-identifier hs-var">takeWhile</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-special">'</span><span class="hs-glyph">\</span><span class="hs-identifier">NUL'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679333391"><span class="hs-identifier hs-var">value_</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-identifier">setEnv_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-299"></a><span class="hs-identifier">setEnv_</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-identifier">value</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withCWString</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">k</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">withCWString</span><span> </span><span class="hs-identifier">value</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">v</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-300"></a><span>  </span><span class="hs-identifier">success</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">c_SetEnvironmentVariable</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-identifier">unless</span><span> </span><span class="hs-identifier">success</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">throwGetLastError</span><span> </span><span class="hs-string">&quot;setEnv&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">WINDOWS_CCONV</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;windows.h SetEnvironmentVariableW&quot;</span><span>
</span><a name="line-304"></a><span>  </span><span class="hs-identifier">c_SetEnvironmentVariable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">LPTSTR</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">LPTSTR</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-305"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-comment">-- NOTE: The 'setenv()' function is not available on all systems, hence we use</span><span>
</span><a name="line-308"></a><span class="hs-comment">-- 'putenv()'.  This leaks memory, but so do common implementations of</span><span>
</span><a name="line-309"></a><span class="hs-comment">-- 'setenv()' (AFAIK).</span><span>
</span><a name="line-310"></a><a name="setEnv_"><a href="System.Environment.html#setEnv_"><span class="hs-identifier">setEnv_</span></a></a><span> </span><a name="local-6989586621679333394"><a href="#local-6989586621679333394"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679333395"><a href="#local-6989586621679333395"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Environment.html#putEnv"><span class="hs-identifier hs-var">putEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679333394"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot;=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621679333395"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-identifier">putEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-313"></a><a name="putEnv"><a href="System.Environment.html#putEnv"><span class="hs-identifier">putEnv</span></a></a><span> </span><a name="local-6989586621679333396"><a href="#local-6989586621679333396"><span class="hs-identifier">keyvalue</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-314"></a><span>  </span><a name="local-6989586621679333397"><a href="#local-6989586621679333397"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Encoding.html#getFileSystemEncoding"><span class="hs-identifier hs-var">getFileSystemEncoding</span></a><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="GHC.Foreign.html#newCString"><span class="hs-identifier hs-var">GHC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">newCString</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679333396"><span class="hs-identifier hs-var">keyvalue</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>  </span><span class="hs-comment">-- IMPORTANT: Do not free `s` after calling putenv!</span><span>
</span><a name="line-316"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-317"></a><span>  </span><span class="hs-comment">-- According to SUSv2, the string passed to putenv becomes part of the</span><span>
</span><a name="line-318"></a><span>  </span><span class="hs-comment">-- environment.</span><span>
</span><a name="line-319"></a><span>  </span><a href="Foreign.C.Error.html#throwErrnoIf_"><span class="hs-identifier hs-var">throwErrnoIf_</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;putenv&quot;</span><span> </span><span class="hs-special">(</span><a href="System.Environment.html#c_putenv"><span class="hs-identifier hs-var">c_putenv</span></a><span> </span><a href="#local-6989586621679333397"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;putenv&quot;</span><span> </span><span class="hs-identifier">c_putenv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.String.html#CString"><span class="hs-identifier hs-type">CString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-322"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-comment">-- | @unsetEnv name@ removes the specified environment variable from the</span><span>
</span><a name="line-325"></a><span class="hs-comment">-- environment of the current process.</span><span>
</span><a name="line-326"></a><span class="hs-comment">--</span><span>
</span><a name="line-327"></a><span class="hs-comment">-- Throws `Control.Exception.IOException` if @name@ is the empty string or</span><span>
</span><a name="line-328"></a><span class="hs-comment">-- contains an equals sign.</span><span>
</span><a name="line-329"></a><span class="hs-comment">--</span><span>
</span><a name="line-330"></a><span class="hs-comment">-- @since 4.7.0.0</span><span>
</span><a name="line-331"></a><span class="hs-identifier">unsetEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-333"></a><span class="hs-identifier">unsetEnv</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withCWString</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">k</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-334"></a><span>  </span><span class="hs-identifier">success</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">c_SetEnvironmentVariable</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">nullPtr</span><span>
</span><a name="line-335"></a><span>  </span><span class="hs-identifier">unless</span><span> </span><span class="hs-identifier">success</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-comment">-- We consider unsetting an environment variable that does not exist not as</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-comment">-- an error, hence we ignore eRROR_ENVVAR_NOT_FOUND.</span><span>
</span><a name="line-338"></a><span>    </span><span class="hs-identifier">err</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">c_GetLastError</span><span>
</span><a name="line-339"></a><span>    </span><span class="hs-identifier">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">err</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">eRROR_ENVVAR_NOT_FOUND</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-340"></a><span>      </span><span class="hs-identifier">throwGetLastError</span><span> </span><span class="hs-string">&quot;unsetEnv&quot;</span><span>
</span><a name="line-341"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-cpp">#ifdef HAVE_UNSETENV</span><span>
</span><a name="line-344"></a><a name="unsetEnv"><a href="System.Environment.html#unsetEnv"><span class="hs-identifier">unsetEnv</span></a></a><span> </span><a name="local-6989586621679333398"><a href="#local-6989586621679333398"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Posix.Internals.html#withFilePath"><span class="hs-identifier hs-var">withFilePath</span></a><span> </span><a href="#local-6989586621679333398"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-special">(</span><a href="Foreign.C.Error.html#throwErrnoIf_"><span class="hs-identifier hs-var">throwErrnoIf_</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;unsetEnv&quot;</span><span> </span><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="System.Environment.html#c_unsetenv"><span class="hs-identifier hs-var">c_unsetenv</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;__hsbase_unsetenv&quot;</span><span> </span><span class="hs-identifier">c_unsetenv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.String.html#CString"><span class="hs-identifier hs-type">CString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-346"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-347"></a><span class="hs-identifier">unsetEnv</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">setEnv_</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-348"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span class="hs-comment">{-|
'withArgs' @args act@ - while executing action @act@, have 'getArgs'
return @args@.
-}</span><span>
</span><a name="line-356"></a><span class="hs-identifier">withArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333362"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333362"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-357"></a><a name="withArgs"><a href="System.Environment.html#withArgs"><span class="hs-identifier">withArgs</span></a></a><span> </span><a name="local-6989586621679333399"><a href="#local-6989586621679333399"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621679333400"><a href="#local-6989586621679333400"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-358"></a><span>   </span><a name="local-6989586621679333401"><a href="#local-6989586621679333401"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.Environment.html#getProgName"><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Environment</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getProgName</span></a><span>
</span><a name="line-359"></a><span>   </span><a href="System.Environment.html#withArgv"><span class="hs-identifier hs-var">withArgv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679333401"><span class="hs-identifier hs-var">p</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679333399"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679333400"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-comment">{-|
'withProgName' @name act@ - while executing action @act@,
have 'getProgName' return @name@.
-}</span><span>
</span><a name="line-365"></a><span class="hs-identifier">withProgName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333361"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333361"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-366"></a><a name="withProgName"><a href="System.Environment.html#withProgName"><span class="hs-identifier">withProgName</span></a></a><span> </span><a name="local-6989586621679333402"><a href="#local-6989586621679333402"><span class="hs-identifier">nm</span></a></a><span> </span><a name="local-6989586621679333403"><a href="#local-6989586621679333403"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-367"></a><span>   </span><a name="local-6989586621679333404"><a href="#local-6989586621679333404"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.Environment.html#getArgs"><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Environment</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getArgs</span></a><span>
</span><a name="line-368"></a><span>   </span><a href="System.Environment.html#withArgv"><span class="hs-identifier hs-var">withArgv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679333402"><span class="hs-identifier hs-var">nm</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679333404"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679333403"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-comment">-- Worker routine which marshals and replaces an argv vector for</span><span>
</span><a name="line-371"></a><span class="hs-comment">-- the duration of an action.</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-identifier">withArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333360"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333360"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-376"></a><span class="hs-comment">-- We have to reflect the updated arguments in the RTS-side variables as</span><span>
</span><a name="line-377"></a><span class="hs-comment">-- well, because the RTS still consults them for error messages and the like.</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- If we don't do this then ghc-e005 fails.</span><span>
</span><a name="line-379"></a><span class="hs-identifier">withArgv</span><span> </span><span class="hs-identifier">new_args</span><span> </span><span class="hs-identifier">act</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withWin32ProgArgv</span><span> </span><span class="hs-identifier">new_args</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">withProgArgv</span><span> </span><span class="hs-identifier">new_args</span><span> </span><span class="hs-identifier">act</span><span>
</span><a name="line-380"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-381"></a><a name="withArgv"><a href="System.Environment.html#withArgv"><span class="hs-identifier">withArgv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Environment.html#withProgArgv"><span class="hs-identifier hs-var">withProgArgv</span></a><span>
</span><a name="line-382"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span class="hs-identifier">withProgArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333359"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679333359"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-385"></a><a name="withProgArgv"><a href="System.Environment.html#withProgArgv"><span class="hs-identifier">withProgArgv</span></a></a><span> </span><a name="local-6989586621679333405"><a href="#local-6989586621679333405"><span class="hs-identifier">new_args</span></a></a><span> </span><a name="local-6989586621679333406"><a href="#local-6989586621679333406"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-386"></a><span>  </span><a name="local-6989586621679333407"><a href="#local-6989586621679333407"><span class="hs-identifier">pName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.Environment.html#getProgName"><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Environment</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getProgName</span></a><span>
</span><a name="line-387"></a><span>  </span><a name="local-6989586621679333408"><a href="#local-6989586621679333408"><span class="hs-identifier">existing_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.Environment.html#getArgs"><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Environment</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getArgs</span></a><span>
</span><a name="line-388"></a><span>  </span><a href="Control.Exception.Base.html#bracket_"><span class="hs-identifier hs-var">bracket_</span></a><span> </span><span class="hs-special">(</span><a href="System.Environment.html#setProgArgv"><span class="hs-identifier hs-var">setProgArgv</span></a><span> </span><a href="#local-6989586621679333405"><span class="hs-identifier hs-var">new_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>           </span><span class="hs-special">(</span><a href="System.Environment.html#setProgArgv"><span class="hs-identifier hs-var">setProgArgv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679333407"><span class="hs-identifier hs-var">pName</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679333408"><span class="hs-identifier hs-var">existing_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>           </span><a href="#local-6989586621679333406"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span class="hs-identifier">setProgArgv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-393"></a><a name="setProgArgv"><a href="System.Environment.html#setProgArgv"><span class="hs-identifier">setProgArgv</span></a></a><span> </span><a name="local-6989586621679333409"><a href="#local-6989586621679333409"><span class="hs-identifier">argv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-394"></a><span>  </span><a name="local-6989586621679333410"><a href="#local-6989586621679333410"><span class="hs-identifier">enc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Encoding.html#getFileSystemEncoding"><span class="hs-identifier hs-var">getFileSystemEncoding</span></a><span>
</span><a name="line-395"></a><span>  </span><a href="GHC.Foreign.html#withCStringsLen"><span class="hs-identifier hs-var">GHC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">withCStringsLen</span></a><span> </span><a href="#local-6989586621679333410"><span class="hs-identifier hs-var">enc</span></a><span> </span><a href="#local-6989586621679333409"><span class="hs-identifier hs-var">argv</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679333411"><a href="#local-6989586621679333411"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621679333412"><a href="#local-6989586621679333412"><span class="hs-identifier">css</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-396"></a><span>    </span><a href="System.Environment.html#c_setProgArgv"><span class="hs-identifier hs-var">c_setProgArgv</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679333411"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679333412"><span class="hs-identifier hs-var">css</span></a><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-comment">-- setProgArgv copies the arguments</span><span>
</span><a name="line-399"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;setProgArgv&quot;</span><span>
</span><a name="line-400"></a><span>  </span><span class="hs-identifier">c_setProgArgv</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="Foreign.C.String.html#CString"><span class="hs-identifier hs-type">CString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span class="hs-comment">-- |'getEnvironment' retrieves the entire environment as a</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- list of @(key,value)@ pairs.</span><span>
</span><a name="line-404"></a><span class="hs-comment">--</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- If an environment entry does not contain an @\'=\'@ character,</span><span>
</span><a name="line-406"></a><span class="hs-comment">-- the @key@ is the whole entry and the @value@ is the empty string.</span><span>
</span><a name="line-407"></a><span class="hs-identifier">getEnvironment</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span class="hs-cpp">#ifdef mingw32_HOST_OS</span><span>
</span><a name="line-410"></a><span class="hs-identifier">getEnvironment</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bracket</span><span> </span><span class="hs-identifier">c_GetEnvironmentStrings</span><span> </span><span class="hs-identifier">c_FreeEnvironmentStrings</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">pBlock</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-411"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">pBlock</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">nullPtr</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-412"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">pBlock</span><span>
</span><a name="line-413"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-414"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">pBlock</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-415"></a><span>        </span><span class="hs-comment">-- The block is terminated by a null byte where there</span><span>
</span><a name="line-416"></a><span>        </span><span class="hs-comment">-- should be an environment variable of the form X=Y</span><span>
</span><a name="line-417"></a><span>        </span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">pBlock</span><span>
</span><a name="line-418"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">c</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-419"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-420"></a><span>          </span><span class="hs-comment">-- Seek the next pair (or terminating null):</span><span>
</span><a name="line-421"></a><span>          </span><span class="hs-identifier">pBlock'</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">seekNull</span><span> </span><span class="hs-identifier">pBlock</span><span> </span><span class="hs-identifier">False</span><span>
</span><a name="line-422"></a><span>          </span><span class="hs-comment">-- We now know the length in bytes, but ignore it when</span><span>
</span><a name="line-423"></a><span>          </span><span class="hs-comment">-- getting the actual String:</span><span>
</span><a name="line-424"></a><span>          </span><span class="hs-identifier">str</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peekCWString</span><span> </span><span class="hs-identifier">pBlock</span><span>
</span><a name="line-425"></a><span>          </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">divvy</span><span> </span><span class="hs-identifier">str</span><span> </span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">pBlock'</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span>    </span><span class="hs-comment">-- Returns pointer to the byte *after* the next null</span><span>
</span><a name="line-428"></a><span>    </span><span class="hs-identifier">seekNull</span><span> </span><span class="hs-identifier">pBlock</span><span> </span><span class="hs-identifier">done</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-429"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">pBlock'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pBlock</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">sizeOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CWchar</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">done</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">pBlock'</span><span>
</span><a name="line-431"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-432"></a><span>           </span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">pBlock'</span><span>
</span><a name="line-433"></a><span>           </span><span class="hs-identifier">seekNull</span><span> </span><span class="hs-identifier">pBlock'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">c</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">WINDOWS_CCONV</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;windows.h GetEnvironmentStringsW&quot;</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-identifier">c_GetEnvironmentStrings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CWchar</span><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">WINDOWS_CCONV</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;windows.h FreeEnvironmentStringsW&quot;</span><span>
</span><a name="line-439"></a><span>  </span><span class="hs-identifier">c_FreeEnvironmentStrings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CWchar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-440"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-441"></a><a name="getEnvironment"><a href="System.Environment.html#getEnvironment"><span class="hs-identifier">getEnvironment</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-442"></a><span>   </span><a name="local-6989586621679333413"><a href="#local-6989586621679333413"><span class="hs-identifier">pBlock</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.Environment.html#getEnvBlock"><span class="hs-identifier hs-var">getEnvBlock</span></a><span>
</span><a name="line-443"></a><span>   </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679333413"><span class="hs-identifier hs-var">pBlock</span></a><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.Ptr.html#nullPtr"><span class="hs-identifier hs-var">nullPtr</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-444"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-445"></a><span>      </span><a name="local-6989586621679333414"><a href="#local-6989586621679333414"><span class="hs-identifier">enc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Encoding.html#getFileSystemEncoding"><span class="hs-identifier hs-var">getFileSystemEncoding</span></a><span>
</span><a name="line-446"></a><span>      </span><a name="local-6989586621679333415"><a href="#local-6989586621679333415"><span class="hs-identifier">stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.Marshal.Array.html#peekArray0"><span class="hs-identifier hs-var">peekArray0</span></a><span> </span><a href="GHC.Ptr.html#nullPtr"><span class="hs-identifier hs-var">nullPtr</span></a><span> </span><a href="#local-6989586621679333413"><span class="hs-identifier hs-var">pBlock</span></a><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Foreign.html#peekCString"><span class="hs-identifier hs-var">GHC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">peekCString</span></a><span> </span><a href="#local-6989586621679333414"><span class="hs-identifier hs-var">enc</span></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>      </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="System.Environment.html#divvy"><span class="hs-identifier hs-var">divvy</span></a><span> </span><a href="#local-6989586621679333415"><span class="hs-identifier hs-var">stuff</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;__hscore_environ&quot;</span><span>
</span><a name="line-450"></a><span>  </span><span class="hs-identifier">getEnvBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="Foreign.C.String.html#CString"><span class="hs-identifier hs-type">CString</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span class="hs-identifier">divvy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">)</span><span>
</span><a name="line-454"></a><a name="divvy"><a href="System.Environment.html#divvy"><span class="hs-identifier">divvy</span></a></a><span> </span><a name="local-6989586621679333416"><a href="#local-6989586621679333416"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-455"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="GHC.List.html#break"><span class="hs-identifier hs-var">break</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span class="hs-char">'='</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679333416"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-456"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679333417"><a href="#local-6989586621679333417"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679333417"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- don't barf (like Posix.getEnvironment)</span><span>
</span><a name="line-457"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679333418"><a href="#local-6989586621679333418"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621679333419"><a href="#local-6989586621679333419"><span class="hs-identifier">value</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679333418"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><a href="#local-6989586621679333419"><span class="hs-identifier hs-var">value</span></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a></pre></body></html>