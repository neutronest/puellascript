<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The AQUA Project, Glasgow University, 1993-1998

\section[Simplify]{The main module of the simplifier}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Simplify</span><span> </span><span class="hs-special">(</span><span> </span><a href="Simplify.html#simplTopBinds"><span class="hs-identifier hs-var">simplTopBinds</span></a><span class="hs-special">,</span><span> </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span class="hs-special">,</span><span> </span><a href="Simplify.html#simplRules"><span class="hs-identifier hs-var">simplRules</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="SimplMonad.html"><span class="hs-identifier">SimplMonad</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span> </span><span class="hs-keyword">hiding</span><span>      </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTyVar"><span class="hs-identifier hs-var">substTyVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="SimplEnv.html"><span class="hs-identifier">SimplEnv</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="SimplUtils.html"><span class="hs-identifier">SimplUtils</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="OccurAnal.html"><span class="hs-identifier">OccurAnal</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Literal.html"><span class="hs-identifier">Literal</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="Literal.html#litIsLifted"><span class="hs-identifier hs-var">litIsLifted</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">--, mkMachInt ) -- temporalily commented out. See #8326</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="MkId.html"><span class="hs-identifier">MkId</span></a><span>             </span><span class="hs-special">(</span><span> </span><a href="MkId.html#seqId"><span class="hs-identifier hs-var">seqId</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="MkCore.html"><span class="hs-identifier">MkCore</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="MkCore.html#mkImpossibleExpr"><span class="hs-identifier hs-var">mkImpossibleExpr</span></a><span class="hs-special">,</span><span> </span><a href="MkCore.html#castBottomExpr"><span class="hs-identifier hs-var">castBottomExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="IdInfo.html"><span class="hs-identifier">IdInfo</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>             </span><span class="hs-special">(</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span> </span><a href="Name.html#mkSystemVarName"><span class="hs-identifier hs-var">mkSystemVarName</span></a><span class="hs-special">,</span><span> </span><a href="Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a><span class="hs-special">,</span><span> </span><a href="Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span> </span><span class="hs-keyword">hiding</span><span>  </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCoVar"><span class="hs-identifier hs-var">substCoVar</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="OptCoercion.html"><span class="hs-identifier">OptCoercion</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier hs-var">topNormaliseType_maybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><a href="DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a><span class="hs-special">,</span><span> </span><a href="DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a><span class="hs-special">,</span><span> </span><a href="DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-comment">--import TyCon            ( isEnumerationTyCon ) -- temporalily commented out. See #8326</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="CoreMonad.html"><span class="hs-identifier">CoreMonad</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CoreMonad.html#Tick"><span class="hs-identifier hs-type">Tick</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreMonad.html#SimplifierMode"><span class="hs-identifier hs-type">SimplifierMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Demand.html"><span class="hs-identifier">Demand</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Demand.html#dmdTypeDepth"><span class="hs-identifier hs-var">dmdTypeDepth</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#isStrictDmd"><span class="hs-identifier hs-var">isStrictDmd</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="PprCore.html#pprCoreExpr"><span class="hs-identifier hs-var">pprCoreExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUnfold.html"><span class="hs-identifier">CoreUnfold</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="CoreArity.html"><span class="hs-identifier">CoreArity</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="CoreOpt.html"><span class="hs-identifier">CoreOpt</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="CoreOpt.html#pushCoTyArg"><span class="hs-identifier hs-var">pushCoTyArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#pushCoValArg"><span class="hs-identifier hs-var">pushCoValArg</span></a><span>
</span><a name="line-39"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#joinPointBinding_maybe"><span class="hs-identifier hs-var">joinPointBinding_maybe</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#joinPointBindings_maybe"><span class="hs-identifier hs-var">joinPointBindings_maybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-comment">--import PrimOp           ( tagToEnumKey ) -- temporalily commented out. See #8326</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Rules.html"><span class="hs-identifier">Rules</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="Rules.html#mkRuleInfo"><span class="hs-identifier hs-var">mkRuleInfo</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#lookupRule"><span class="hs-identifier hs-var">lookupRule</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#getRules"><span class="hs-identifier hs-var">getRules</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-comment">--import TysPrim          ( intPrimTy ) -- temporalily commented out. See #8326</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#isNotTopLevel"><span class="hs-identifier hs-var">isNotTopLevel</span></a><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>                          </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="MonadUtils.html"><span class="hs-identifier">MonadUtils</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="MonadUtils.html#foldlM"><span class="hs-identifier hs-var">foldlM</span></a><span class="hs-special">,</span><span> </span><a href="MonadUtils.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#fromJust"><span class="hs-identifier hs-var">fromJust</span></a><span class="hs-special">,</span><span> </span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-comment">--import Unique           ( hasKey ) -- temporalily commented out. See #8326</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="Module.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#pprModuleName"><span class="hs-identifier hs-var">pprModuleName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">{-
The guts of the simplifier is in this module, but the driver loop for
the simplifier is in SimplCore.hs.


-----------------------------------------
        *** IMPORTANT NOTE ***
-----------------------------------------
The simplifier used to guarantee that the output had no shadowing, but
it does not do so any more.   (Actually, it never did!)  The reason is
documented with simplifyArgs.


-----------------------------------------
        *** IMPORTANT NOTE ***
-----------------------------------------
Many parts of the simplifier return a bunch of &quot;floats&quot; as well as an
expression. This is wrapped as a datatype SimplUtils.FloatsWith.

All &quot;floats&quot; are let-binds, not case-binds, but some non-rec lets may
be unlifted (with RHS ok-for-speculation).



-----------------------------------------
        ORGANISATION OF FUNCTIONS
-----------------------------------------
simplTopBinds
  - simplify all top-level binders
  - for NonRec, call simplRecOrTopPair
  - for Rec,    call simplRecBind


        ------------------------------
simplExpr (applied lambda)      ==&gt; simplNonRecBind
simplExpr (Let (NonRec ...) ..) ==&gt; simplNonRecBind
simplExpr (Let (Rec ...)    ..) ==&gt; simplify binders; simplRecBind

        ------------------------------
simplRecBind    [binders already simplfied]
  - use simplRecOrTopPair on each pair in turn

simplRecOrTopPair [binder already simplified]
  Used for: recursive bindings (top level and nested)
            top-level non-recursive bindings
  Returns:
  - check for PreInlineUnconditionally
  - simplLazyBind

simplNonRecBind
  Used for: non-top-level non-recursive bindings
            beta reductions (which amount to the same thing)
  Because it can deal with strict arts, it takes a
        &quot;thing-inside&quot; and returns an expression

  - check for PreInlineUnconditionally
  - simplify binder, including its IdInfo
  - if strict binding
        simplStrictArg
        mkAtomicArgs
        completeNonRecX
    else
        simplLazyBind
        addFloats

simplNonRecX:   [given a *simplified* RHS, but an *unsimplified* binder]
  Used for: binding case-binder and constr args in a known-constructor case
  - check for PreInLineUnconditionally
  - simplify binder
  - completeNonRecX

        ------------------------------
simplLazyBind:  [binder already simplified, RHS not]
  Used for: recursive bindings (top level and nested)
            top-level non-recursive bindings
            non-top-level, but *lazy* non-recursive bindings
        [must not be strict or unboxed]
  Returns floats + an augmented environment, not an expression
  - substituteIdInfo and add result to in-scope
        [so that rules are available in rec rhs]
  - simplify rhs
  - mkAtomicArgs
  - float if exposes constructor or PAP
  - completeBind


completeNonRecX:        [binder and rhs both simplified]
  - if the the thing needs case binding (unlifted and not ok-for-spec)
        build a Case
   else
        completeBind
        addFloats

completeBind:   [given a simplified RHS]
        [used for both rec and non-rec bindings, top level and not]
  - try PostInlineUnconditionally
  - add unfolding [this is the only place we add an unfolding]
  - add arity



Right hand sides and arguments
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In many ways we want to treat
        (a) the right hand side of a let(rec), and
        (b) a function argument
in the same way.  But not always!  In particular, we would
like to leave these arguments exactly as they are, so they
will match a RULE more easily.

        f (g x, h x)
        g (+ x)

It's harder to make the rule match if we ANF-ise the constructor,
or eta-expand the PAP:

        f (let { a = g x; b = h x } in (a,b))
        g (\y. + x y)

On the other hand if we see the let-defns

        p = (g x, h x)
        q = + x

then we *do* want to ANF-ise and eta-expand, so that p and q
can be safely inlined.

Even floating lets out is a bit dubious.  For let RHS's we float lets
out if that exposes a value, so that the value can be inlined more vigorously.
For example

        r = let x = e in (x,x)

Here, if we float the let out we'll expose a nice constructor. We did experiments
that showed this to be a generally good thing.  But it was a bad thing to float
lets out unconditionally, because that meant they got allocated more often.

For function arguments, there's less reason to expose a constructor (it won't
get inlined).  Just possibly it might make a rule match, but I'm pretty skeptical.
So for the moment we don't float lets out of function arguments either.


Eta expansion
~~~~~~~~~~~~~~
For eta expansion, we want to catch things like

        case e of (a,b) -&gt; \x -&gt; case a of (p,q) -&gt; \y -&gt; r

If the \x was on the RHS of a let, we'd eta expand to bring the two
lambdas together.  And in general that's a good thing to do.  Perhaps
we should eta expand wherever we find a (value) lambda?  Then the eta
expansion at a let RHS can concentrate solely on the PAP case.


Case-of-case and join points
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we perform the case-of-case transform (or otherwise push continuations
inward), we want to treat join points specially. Since they're always
tail-called and we want to maintain this invariant, we can do this (for any
evaluation context E):

  E[join j = e
    in case ... of
         A -&gt; jump j 1
         B -&gt; jump j 2
         C -&gt; f 3]

    --&gt;

  join j = E[e]
  in case ... of
       A -&gt; jump j 1
       B -&gt; jump j 2
       C -&gt; E[f 3]

As is evident from the example, there are two components to this behavior:

  1. When entering the RHS of a join point, copy the context inside.
  2. When a join point is invoked, discard the outer context.

Clearly we need to be very careful here to remain consistent---neither part is
optional!

************************************************************************
*                                                                      *
\subsection{Bindings}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-identifier">simplTopBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InBind"><span class="hs-identifier hs-type">InBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><a name="simplTopBinds"><a href="Simplify.html#simplTopBinds"><span class="hs-identifier">simplTopBinds</span></a></a><span> </span><a name="local-6989586621679788624"><a href="#local-6989586621679788624"><span class="hs-identifier">env0</span></a></a><span> </span><a name="local-6989586621679788625"><a href="#local-6989586621679788625"><span class="hs-identifier">binds0</span></a></a><span>
</span><a name="line-249"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Put all the top-level binders into scope at the start</span><span>
</span><a name="line-250"></a><span>                </span><span class="hs-comment">-- so that if a transformation rule has unexpectedly brought</span><span>
</span><a name="line-251"></a><span>                </span><span class="hs-comment">-- anything into scope, then we don't get a complaint about that.</span><span>
</span><a name="line-252"></a><span>                </span><span class="hs-comment">-- It's rather as if the top-level binders were imported.</span><span>
</span><a name="line-253"></a><span>                </span><span class="hs-comment">-- See note [Glomming] in OccurAnal.</span><span>
</span><a name="line-254"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788640"><a href="#local-6989586621679788640"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplRecBndrs"><span class="hs-identifier hs-var">simplRecBndrs</span></a><span> </span><a href="#local-6989586621679788624"><span class="hs-identifier hs-var">env0</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#bindersOfBinds"><span class="hs-identifier hs-var">bindersOfBinds</span></a><span> </span><a href="#local-6989586621679788625"><span class="hs-identifier hs-var">binds0</span></a><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788641"><a href="#local-6989586621679788641"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788626"><span class="hs-identifier hs-var">simpl_binds</span></a><span> </span><a href="#local-6989586621679788640"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679788625"><span class="hs-identifier hs-var">binds0</span></a><span>
</span><a name="line-256"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="SimplMonad.html#freeTick"><span class="hs-identifier hs-var">freeTick</span></a><span> </span><a href="CoreMonad.html#SimplifierDone"><span class="hs-identifier hs-var">SimplifierDone</span></a><span>
</span><a name="line-257"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679788641"><span class="hs-identifier hs-var">env2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-258"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-259"></a><span>        </span><span class="hs-comment">-- We need to track the zapped top-level binders, because</span><span>
</span><a name="line-260"></a><span>        </span><span class="hs-comment">-- they should have their fragile IdInfo zapped (notably occurrence info)</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-comment">-- That's why we run down binds and bndrs' simultaneously.</span><span>
</span><a name="line-262"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-263"></a><span>    </span><span class="hs-identifier">simpl_binds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InBind"><span class="hs-identifier hs-type">InBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-264"></a><span>    </span><a name="local-6989586621679788626"><a href="#local-6989586621679788626"><span class="hs-identifier">simpl_binds</span></a></a><span> </span><a name="local-6989586621679788628"><a href="#local-6989586621679788628"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679788628"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-265"></a><span>    </span><span class="hs-identifier">simpl_binds</span><span> </span><a name="local-6989586621679788629"><a href="#local-6989586621679788629"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679788630"><a href="#local-6989586621679788630"><span class="hs-identifier">bind</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679788631"><a href="#local-6989586621679788631"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788632"><a href="#local-6989586621679788632"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788627"><span class="hs-identifier hs-var">simpl_bind</span></a><span> </span><a href="#local-6989586621679788629"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788630"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-266"></a><span>                                      </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679788626"><span class="hs-identifier hs-var">simpl_binds</span></a><span> </span><a href="#local-6989586621679788632"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679788631"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>    </span><a name="local-6989586621679788627"><a href="#local-6989586621679788627"><span class="hs-identifier">simpl_bind</span></a></a><span> </span><a name="local-6989586621679788633"><a href="#local-6989586621679788633"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621679788634"><a href="#local-6989586621679788634"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplRecBind"><span class="hs-identifier hs-var">simplRecBind</span></a><span> </span><a href="#local-6989586621679788633"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="BasicTypes.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621679788634"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-269"></a><span>    </span><span class="hs-identifier">simpl_bind</span><span> </span><a name="local-6989586621679788635"><a href="#local-6989586621679788635"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621679788636"><a href="#local-6989586621679788636"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679788637"><a href="#local-6989586621679788637"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788638"><a href="#local-6989586621679788638"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788639"><a href="#local-6989586621679788639"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#addBndrRules"><span class="hs-identifier hs-var">addBndrRules</span></a><span> </span><a href="#local-6989586621679788635"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788636"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#lookupRecBndr"><span class="hs-identifier hs-var">lookupRecBndr</span></a><span> </span><a href="#local-6989586621679788635"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788636"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>                                     </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplRecOrTopPair"><span class="hs-identifier hs-var">simplRecOrTopPair</span></a><span> </span><a href="#local-6989586621679788638"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="BasicTypes.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a><span>
</span><a name="line-271"></a><span>                                                         </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-272"></a><span>                                                         </span><a href="#local-6989586621679788636"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679788639"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621679788637"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Lazy bindings}
*                                                                      *
************************************************************************

simplRecBind is used for
        * recursive bindings only
-}</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span class="hs-identifier">simplRecBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-286"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-287"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-288"></a><a name="simplRecBind"><a href="Simplify.html#simplRecBind"><span class="hs-identifier">simplRecBind</span></a></a><span> </span><a name="local-6989586621679788642"><a href="#local-6989586621679788642"><span class="hs-identifier">env0</span></a></a><span> </span><a name="local-6989586621679788643"><a href="#local-6989586621679788643"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788644"><a href="#local-6989586621679788644"><span class="hs-identifier">mb_cont</span></a></a><span> </span><a name="local-6989586621679788645"><a href="#local-6989586621679788645"><span class="hs-identifier">pairs0</span></a></a><span>
</span><a name="line-289"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788660"><a href="#local-6989586621679788660"><span class="hs-identifier">env_with_info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788661"><a href="#local-6989586621679788661"><span class="hs-identifier">triples</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a><span> </span><a href="#local-6989586621679788646"><span class="hs-identifier hs-var">add_rules</span></a><span> </span><a href="#local-6989586621679788642"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621679788645"><span class="hs-identifier hs-var">pairs0</span></a><span>
</span><a name="line-290"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788662"><a href="#local-6989586621679788662"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788647"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapFloats"><span class="hs-identifier hs-var">zapFloats</span></a><span> </span><a href="#local-6989586621679788660"><span class="hs-identifier hs-var">env_with_info</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788661"><span class="hs-identifier hs-var">triples</span></a><span>
</span><a name="line-291"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788642"><span class="hs-identifier hs-var">env0</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#addRecFloats"><span class="hs-identifier hs-var">addRecFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788662"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-292"></a><span>        </span><span class="hs-comment">-- addFloats adds the floats from env1,</span><span>
</span><a name="line-293"></a><span>        </span><span class="hs-comment">-- _and_ updates env0 with the in-scope set from env1</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>    </span><span class="hs-identifier">add_rules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">,</span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>        </span><span class="hs-comment">-- Add the (substituted) rules to the binder</span><span>
</span><a name="line-297"></a><span>    </span><a name="local-6989586621679788646"><a href="#local-6989586621679788646"><span class="hs-identifier">add_rules</span></a></a><span> </span><a name="local-6989586621679788648"><a href="#local-6989586621679788648"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679788649"><a href="#local-6989586621679788649"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788650"><a href="#local-6989586621679788650"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788651"><a href="#local-6989586621679788651"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788652"><a href="#local-6989586621679788652"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#addBndrRules"><span class="hs-identifier hs-var">addBndrRules</span></a><span> </span><a href="#local-6989586621679788648"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788649"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#lookupRecBndr"><span class="hs-identifier hs-var">lookupRecBndr</span></a><span> </span><a href="#local-6989586621679788648"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788649"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788651"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788649"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788652"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788650"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span>    </span><a name="local-6989586621679788647"><a href="#local-6989586621679788647"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679788653"><a href="#local-6989586621679788653"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679788653"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679788654"><a href="#local-6989586621679788654"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679788655"><a href="#local-6989586621679788655"><span class="hs-identifier">old_bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788656"><a href="#local-6989586621679788656"><span class="hs-identifier">new_bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788657"><a href="#local-6989586621679788657"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679788658"><a href="#local-6989586621679788658"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788659"><a href="#local-6989586621679788659"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplRecOrTopPair"><span class="hs-identifier hs-var">simplRecOrTopPair</span></a><span> </span><a href="#local-6989586621679788654"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788643"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="BasicTypes.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a><span> </span><a href="#local-6989586621679788644"><span class="hs-identifier hs-var">mb_cont</span></a><span>
</span><a name="line-305"></a><span>                                         </span><a href="#local-6989586621679788655"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><a href="#local-6989586621679788656"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><a href="#local-6989586621679788657"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-306"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679788647"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679788659"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679788658"><span class="hs-identifier hs-var">pairs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-comment">{-
simplOrTopPair is used for
        * recursive bindings (whether top level or not)
        * top-level non-recursive bindings

It assumes the binder has already been simplified, but not its IdInfo.
-}</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-identifier">simplRecOrTopPair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-317"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-318"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span>  </span><span class="hs-comment">-- Binder and rhs</span><span>
</span><a name="line-319"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>    </span><span class="hs-comment">-- Returns an env that includes the binding</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><a name="simplRecOrTopPair"><a href="Simplify.html#simplRecOrTopPair"><span class="hs-identifier">simplRecOrTopPair</span></a></a><span> </span><a name="local-6989586621679788663"><a href="#local-6989586621679788663"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788664"><a href="#local-6989586621679788664"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788665"><a href="#local-6989586621679788665"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621679788666"><a href="#local-6989586621679788666"><span class="hs-identifier">mb_cont</span></a></a><span> </span><a name="local-6989586621679788667"><a href="#local-6989586621679788667"><span class="hs-identifier">old_bndr</span></a></a><span> </span><a name="local-6989586621679788668"><a href="#local-6989586621679788668"><span class="hs-identifier">new_bndr</span></a></a><span> </span><a name="local-6989586621679788669"><a href="#local-6989586621679788669"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-322"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788673"><a href="#local-6989586621679788673"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-323"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679788670"><span class="hs-identifier hs-var">trace_bind</span></a><span> </span><a href="#local-6989586621679788673"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-324"></a><span>           </span><span class="hs-keyword">if</span><span> </span><a href="SimplUtils.html#preInlineUnconditionally"><span class="hs-identifier hs-var">preInlineUnconditionally</span></a><span> </span><a href="#local-6989586621679788673"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679788663"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788664"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788667"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><a href="#local-6989586621679788669"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-325"></a><span>                    </span><span class="hs-comment">-- Check for unconditional inline</span><span>
</span><a name="line-326"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#PreInlineUnconditionally"><span class="hs-identifier hs-var">PreInlineUnconditionally</span></a><span> </span><a href="#local-6989586621679788667"><span class="hs-identifier hs-var">old_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>                   </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><a href="#local-6989586621679788663"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788667"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#mkContEx"><span class="hs-identifier hs-var">mkContEx</span></a><span> </span><a href="#local-6989586621679788663"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788669"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>           </span><span class="hs-keyword">else</span><span> </span><a href="Simplify.html#simplBind"><span class="hs-identifier hs-var">simplBind</span></a><span> </span><a href="#local-6989586621679788663"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788664"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788665"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><a href="#local-6989586621679788666"><span class="hs-identifier hs-var">mb_cont</span></a><span> </span><a href="#local-6989586621679788667"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><a href="#local-6989586621679788668"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><a href="#local-6989586621679788669"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679788663"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-329"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-330"></a><span>    </span><a name="local-6989586621679788670"><a href="#local-6989586621679788670"><span class="hs-identifier">trace_bind</span></a></a><span> </span><a name="local-6989586621679788671"><a href="#local-6989586621679788671"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679788672"><a href="#local-6989586621679788672"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-331"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#dopt"><span class="hs-identifier hs-var">dopt</span></a><span> </span><a href="DynFlags.html#Opt_D_verbose_core2core"><span class="hs-identifier hs-var">Opt_D_verbose_core2core</span></a><span> </span><a href="#local-6989586621679788671"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788672"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-333"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-334"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a><span> </span><span class="hs-string">&quot;SimplBind&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679788667"><span class="hs-identifier hs-var">old_bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788672"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-335"></a><span>        </span><span class="hs-comment">-- trace_bind emits a trace for each top-level binding, which</span><span>
</span><a name="line-336"></a><span>        </span><span class="hs-comment">-- helps to locate the tracing for inlining and rule firing</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-comment">{-
simplBind is used for
  * [simplRecOrTopPair] recursive bindings (whether top level or not)
  * [simplRecOrTopPair] top-level non-recursive bindings
  * [simplNonRecE]      non-top-level *lazy* non-recursive bindings

Nota bene:
    1. It assumes that the binder is *already* simplified,
       and is in scope, and its IdInfo too, except unfolding

    2. It assumes that the binder type is lifted.

    3. It does not check for pre-inline-unconditionally;
       that should have been done already.
-}</span><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span class="hs-identifier">simplBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-355"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-356"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>      </span><span class="hs-comment">-- Binder, both pre-and post simpl</span><span>
</span><a name="line-357"></a><span>                                </span><span class="hs-comment">-- The OutId has IdInfo, except arity, unfolding</span><span>
</span><a name="line-358"></a><span>                                </span><span class="hs-comment">-- Ids only, no TyVars</span><span>
</span><a name="line-359"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-comment">-- The RHS and its environment</span><span>
</span><a name="line-360"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-361"></a><a name="simplBind"><a href="Simplify.html#simplBind"><span class="hs-identifier">simplBind</span></a></a><span> </span><a name="local-6989586621679788674"><a href="#local-6989586621679788674"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788675"><a href="#local-6989586621679788675"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788676"><a href="#local-6989586621679788676"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621679788677"><a href="#local-6989586621679788677"><span class="hs-identifier">mb_cont</span></a></a><span> </span><a name="local-6989586621679788678"><a href="#local-6989586621679788678"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679788679"><a href="#local-6989586621679788679"><span class="hs-identifier">bndr1</span></a></a><span> </span><a name="local-6989586621679788680"><a href="#local-6989586621679788680"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621679788681"><a href="#local-6989586621679788681"><span class="hs-identifier">rhs_se</span></a></a><span>
</span><a name="line-362"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span> </span><span class="hs-identifier">bndr1</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>    </span><a href="Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a><span> </span><a href="#local-6989586621679788679"><span class="hs-identifier hs-var">bndr1</span></a><span>
</span><a name="line-364"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isNotTopLevel</span><span> </span><a href="BasicTypes.html#isNotTopLevel"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="BasicTypes.html#isNotTopLevel"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><span class="hs-identifier">isJust</span><span> </span><span class="hs-identifier">mb_cont</span><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>    </span><a href="Simplify.html#simplJoinBind"><span class="hs-identifier hs-var">simplJoinBind</span></a><span> </span><a href="#local-6989586621679788674"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788676"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#fromJust"><span class="hs-identifier hs-var">fromJust</span></a><span> </span><a href="#local-6989586621679788677"><span class="hs-identifier hs-var">mb_cont</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788678"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788679"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-6989586621679788680"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679788681"><span class="hs-identifier hs-var">rhs_se</span></a><span>
</span><a name="line-366"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplLazyBind"><span class="hs-identifier hs-var">simplLazyBind</span></a><span> </span><a href="#local-6989586621679788674"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788675"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788676"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><a href="#local-6989586621679788678"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788679"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-6989586621679788680"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679788681"><span class="hs-identifier hs-var">rhs_se</span></a><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span class="hs-identifier">simplLazyBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-370"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span>
</span><a name="line-371"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>          </span><span class="hs-comment">-- Binder, both pre-and post simpl</span><span>
</span><a name="line-372"></a><span>                                        </span><span class="hs-comment">-- The OutId has IdInfo, except arity, unfolding</span><span>
</span><a name="line-373"></a><span>                                        </span><span class="hs-comment">-- Ids only, no TyVars</span><span>
</span><a name="line-374"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>     </span><span class="hs-comment">-- The RHS and its environment</span><span>
</span><a name="line-375"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-376"></a><span class="hs-comment">-- Precondition: rhs obeys the let/app invariant</span><span>
</span><a name="line-377"></a><span class="hs-comment">-- NOT used for JoinIds</span><span>
</span><a name="line-378"></a><a name="simplLazyBind"><a href="Simplify.html#simplLazyBind"><span class="hs-identifier">simplLazyBind</span></a></a><span> </span><a name="local-6989586621679788682"><a href="#local-6989586621679788682"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788683"><a href="#local-6989586621679788683"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788684"><a href="#local-6989586621679788684"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621679788685"><a href="#local-6989586621679788685"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679788686"><a href="#local-6989586621679788686"><span class="hs-identifier">bndr1</span></a></a><span> </span><a name="local-6989586621679788687"><a href="#local-6989586621679788687"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621679788688"><a href="#local-6989586621679788688"><span class="hs-identifier">rhs_se</span></a></a><span>
</span><a name="line-379"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isJoinId</span><span> </span><span class="hs-identifier">bndr</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Id.html#isJoinId"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-comment">-- pprTrace &quot;simplLazyBind&quot; ((ppr bndr &lt;+&gt; ppr bndr1) $$ ppr rhs $$ ppr (seIdSubst rhs_se)) $</span><span>
</span><a name="line-382"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span>   </span><a name="local-6989586621679788689"><a href="#local-6989586621679788689"><span class="hs-identifier">rhs_env</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788688"><span class="hs-identifier hs-var">rhs_se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setInScopeAndZapFloats"><span class="hs-identifier hs-var">setInScopeAndZapFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788682"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-383"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679788690"><a href="#local-6989586621679788690"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788691"><a href="#local-6989586621679788691"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSyn.html#collectTyAndValBinders"><span class="hs-identifier hs-var">collectTyAndValBinders</span></a><span> </span><a href="#local-6989586621679788687"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-384"></a><span>                                </span><span class="hs-special">(</span><a name="local-6989586621679788693"><a href="#local-6989586621679788693"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679788694"><a href="#local-6989586621679788694"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>                                  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679788692"><span class="hs-identifier hs-var">surely_not_lam</span></a><span> </span><a href="#local-6989586621679788694"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788693"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788694"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>                                </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788687"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span>                </span><a name="local-6989586621679788692"><a href="#local-6989586621679788692"><span class="hs-identifier">surely_not_lam</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-389"></a><span>                </span><span class="hs-identifier">surely_not_lam</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621679788695"><a href="#local-6989586621679788695"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679788696"><a href="#local-6989586621679788696"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-6989586621679788695"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788692"><span class="hs-identifier hs-var">surely_not_lam</span></a><span> </span><a href="#local-6989586621679788696"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-391"></a><span>                   </span><span class="hs-comment">-- eta-reduction could float</span><span>
</span><a name="line-392"></a><span>                </span><span class="hs-identifier">surely_not_lam</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-393"></a><span>                        </span><span class="hs-comment">-- Do not do the &quot;abstract tyyvar&quot; thing if there's</span><span>
</span><a name="line-394"></a><span>                        </span><span class="hs-comment">-- a lambda inside, because it defeats eta-reduction</span><span>
</span><a name="line-395"></a><span>                        </span><span class="hs-comment">--    f = /\a. \x. g a x</span><span>
</span><a name="line-396"></a><span>                        </span><span class="hs-comment">-- should eta-reduce.</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788697"><a href="#local-6989586621679788697"><span class="hs-identifier">body_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788698"><a href="#local-6989586621679788698"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplBinders"><span class="hs-identifier hs-var">simplBinders</span></a><span> </span><a href="#local-6989586621679788689"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621679788690"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-400"></a><span>                </span><span class="hs-comment">-- See Note [Floating and type abstraction] in SimplUtils</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span>        </span><span class="hs-comment">-- Simplify the RHS</span><span>
</span><a name="line-403"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><a name="local-6989586621679788699"><a href="#local-6989586621679788699"><span class="hs-identifier">rhs_cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkRhsStop"><span class="hs-identifier hs-var">mkRhsStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621679788697"><span class="hs-identifier hs-var">body_env</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621679788691"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-404"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788700"><a href="#local-6989586621679788700"><span class="hs-identifier">body_env0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788701"><a href="#local-6989586621679788701"><span class="hs-identifier">body0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679788697"><span class="hs-identifier hs-var">body_env</span></a><span> </span><a href="#local-6989586621679788691"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679788699"><span class="hs-identifier hs-var">rhs_cont</span></a><span>
</span><a name="line-405"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788702"><a href="#local-6989586621679788702"><span class="hs-identifier">body1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#wrapJoinFloats"><span class="hs-identifier hs-var">wrapJoinFloats</span></a><span> </span><a href="#local-6989586621679788700"><span class="hs-identifier hs-var">body_env0</span></a><span> </span><a href="#local-6989586621679788701"><span class="hs-identifier hs-var">body0</span></a><span>
</span><a name="line-406"></a><span>              </span><a name="local-6989586621679788703"><a href="#local-6989586621679788703"><span class="hs-identifier">body_env1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788700"><span class="hs-identifier hs-var">body_env0</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#restoreJoinFloats"><span class="hs-identifier hs-var">restoreJoinFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788697"><span class="hs-identifier hs-var">body_env</span></a><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span>        </span><span class="hs-comment">-- ANF-ise a constructor or PAP rhs</span><span>
</span><a name="line-409"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788704"><a href="#local-6989586621679788704"><span class="hs-identifier">body_env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788705"><a href="#local-6989586621679788705"><span class="hs-identifier">body2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#prepareRhs"><span class="hs-identifier hs-var">prepareRhs</span></a><span> </span><a href="#local-6989586621679788683"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788703"><span class="hs-identifier hs-var">body_env1</span></a><span> </span><a href="#local-6989586621679788686"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-6989586621679788702"><span class="hs-identifier hs-var">body1</span></a><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788711"><a href="#local-6989586621679788711"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788712"><a href="#local-6989586621679788712"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>            </span><span class="hs-glyph">&lt;-</span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#doFloatFromRhs"><span class="hs-identifier hs-var">doFloatFromRhs</span></a><span> </span><a href="#local-6989586621679788683"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788684"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679788705"><span class="hs-identifier hs-var">body2</span></a><span> </span><a href="#local-6989586621679788704"><span class="hs-identifier hs-var">body_env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>                </span><span class="hs-keyword">then</span><span>                            </span><span class="hs-comment">-- No floating, revert to body1</span><span>
</span><a name="line-414"></a><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788706"><a href="#local-6989586621679788706"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplUtils.html#mkLam"><span class="hs-identifier hs-var">mkLam</span></a><span> </span><a href="#local-6989586621679788682"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788698"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-6989586621679788703"><span class="hs-identifier hs-var">body_env1</span></a><span> </span><a href="#local-6989586621679788702"><span class="hs-identifier hs-var">body1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788699"><span class="hs-identifier hs-var">rhs_cont</span></a><span>
</span><a name="line-415"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788682"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788706"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621679788690"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-keyword">then</span><span>           </span><span class="hs-comment">-- Simple floating</span><span>
</span><a name="line-418"></a><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="CoreMonad.html#LetFloatFromLet"><span class="hs-identifier hs-var">LetFloatFromLet</span></a><span>
</span><a name="line-419"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#addFloats"><span class="hs-identifier hs-var">addFloats</span></a><span> </span><a href="#local-6989586621679788682"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788704"><span class="hs-identifier hs-var">body_env2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788705"><span class="hs-identifier hs-var">body2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>                </span><span class="hs-keyword">else</span><span>                            </span><span class="hs-comment">-- Do type-abstraction first</span><span>
</span><a name="line-422"></a><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="CoreMonad.html#LetFloatFromLet"><span class="hs-identifier hs-var">LetFloatFromLet</span></a><span>
</span><a name="line-423"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788707"><a href="#local-6989586621679788707"><span class="hs-identifier">poly_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788708"><a href="#local-6989586621679788708"><span class="hs-identifier">body3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplUtils.html#abstractFloats"><span class="hs-identifier hs-var">abstractFloats</span></a><span> </span><a href="#local-6989586621679788698"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621679788704"><span class="hs-identifier hs-var">body_env2</span></a><span> </span><a href="#local-6989586621679788705"><span class="hs-identifier hs-var">body2</span></a><span>
</span><a name="line-424"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788709"><a href="#local-6989586621679788709"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplUtils.html#mkLam"><span class="hs-identifier hs-var">mkLam</span></a><span> </span><a href="#local-6989586621679788682"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788698"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621679788708"><span class="hs-identifier hs-var">body3</span></a><span> </span><a href="#local-6989586621679788699"><span class="hs-identifier hs-var">rhs_cont</span></a><span>
</span><a name="line-425"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788710"><a href="#local-6989586621679788710"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#foldlM"><span class="hs-identifier hs-var">foldlM</span></a><span> </span><span class="hs-special">(</span><a href="Simplify.html#addPolyBind"><span class="hs-identifier hs-var">addPolyBind</span></a><span> </span><a href="#local-6989586621679788683"><span class="hs-identifier hs-var">top_lvl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788682"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788707"><span class="hs-identifier hs-var">poly_binds</span></a><span>
</span><a name="line-426"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788710"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788709"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#completeBind"><span class="hs-identifier hs-var">completeBind</span></a><span> </span><a href="#local-6989586621679788711"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679788683"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788684"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621679788685"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788686"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-6989586621679788712"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-identifier">simplJoinBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-431"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span>
</span><a name="line-432"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-433"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>          </span><span class="hs-comment">-- Binder, both pre-and post simpl</span><span>
</span><a name="line-434"></a><span>                                        </span><span class="hs-comment">-- The OutId has IdInfo, except arity,</span><span>
</span><a name="line-435"></a><span>                                        </span><span class="hs-comment">--   unfolding</span><span>
</span><a name="line-436"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>     </span><span class="hs-comment">-- The RHS and its environment</span><span>
</span><a name="line-437"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-438"></a><a name="simplJoinBind"><a href="Simplify.html#simplJoinBind"><span class="hs-identifier">simplJoinBind</span></a></a><span> </span><a name="local-6989586621679788713"><a href="#local-6989586621679788713"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788714"><a href="#local-6989586621679788714"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621679788715"><a href="#local-6989586621679788715"><span class="hs-identifier">cont</span></a></a><span> </span><a name="local-6989586621679788716"><a href="#local-6989586621679788716"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679788717"><a href="#local-6989586621679788717"><span class="hs-identifier">bndr1</span></a></a><span> </span><a name="local-6989586621679788718"><a href="#local-6989586621679788718"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621679788719"><a href="#local-6989586621679788719"><span class="hs-identifier">rhs_se</span></a></a><span>
</span><a name="line-439"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;simplLazyBind&quot; ((ppr bndr &lt;+&gt; ppr bndr1) $$</span><span>
</span><a name="line-440"></a><span>    </span><span class="hs-comment">--                           ppr rhs $$ ppr (seIdSubst rhs_se)) $</span><span>
</span><a name="line-441"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788720"><a href="#local-6989586621679788720"><span class="hs-identifier">rhs_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788719"><span class="hs-identifier hs-var">rhs_se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setInScopeAndZapFloats"><span class="hs-identifier hs-var">setInScopeAndZapFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788713"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>        </span><span class="hs-comment">-- Simplify the RHS</span><span>
</span><a name="line-444"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788721"><a href="#local-6989586621679788721"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplJoinRhs"><span class="hs-identifier hs-var">simplJoinRhs</span></a><span> </span><a href="#local-6989586621679788720"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621679788716"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788718"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679788715"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-445"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#completeBind"><span class="hs-identifier hs-var">completeBind</span></a><span> </span><a href="#local-6989586621679788713"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="#local-6989586621679788714"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679788715"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788716"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788717"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-6989586621679788721"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-comment">{-
A specialised variant of simplNonRec used when the RHS is already simplified,
notably in knownCon.  It uses case-binding where necessary.
-}</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-identifier">simplNonRecX</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-453"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span>            </span><span class="hs-comment">-- Old binder</span><span>
</span><a name="line-454"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>         </span><span class="hs-comment">-- Simplified RHS</span><span>
</span><a name="line-455"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-456"></a><span class="hs-comment">-- Precondition: rhs satisfies the let/app invariant</span><span>
</span><a name="line-457"></a><a name="simplNonRecX"><a href="Simplify.html#simplNonRecX"><span class="hs-identifier">simplNonRecX</span></a></a><span> </span><a name="local-6989586621679788722"><a href="#local-6989586621679788722"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788723"><a href="#local-6989586621679788723"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679788724"><a href="#local-6989586621679788724"><span class="hs-identifier">new_rhs</span></a></a><span>
</span><a name="line-458"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621679788723"><span class="hs-identifier hs-var">bndr</span></a><span>   </span><span class="hs-comment">-- Not uncommon; e.g. case (a,b) of c { (p,q) -&gt; p }</span><span>
</span><a name="line-459"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679788722"><span class="hs-identifier hs-var">env</span></a><span>    </span><span class="hs-comment">--  Here c is dead, and we avoid creating</span><span>
</span><a name="line-460"></a><span>                  </span><span class="hs-comment">--   the binding c = (a,b)</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621679788725"><a href="#local-6989586621679788725"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788724"><span class="hs-identifier hs-var">new_rhs</span></a><span>
</span><a name="line-463"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><a href="#local-6989586621679788722"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788723"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788725"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-466"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788726"><a href="#local-6989586621679788726"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788727"><a href="#local-6989586621679788727"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a><span> </span><a href="#local-6989586621679788722"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788723"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-467"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#completeNonRecX"><span class="hs-identifier hs-var">completeNonRecX</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="#local-6989586621679788726"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#isStrictId"><span class="hs-identifier hs-var">isStrictId</span></a><span> </span><a href="#local-6989586621679788723"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788723"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788727"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621679788724"><span class="hs-identifier hs-var">new_rhs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-468"></a><span>                </span><span class="hs-comment">-- simplNonRecX is only used for NotTopLevel things</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">completeNonRecX</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-471"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-472"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span>                 </span><span class="hs-comment">-- Old binder</span><span>
</span><a name="line-473"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>                </span><span class="hs-comment">-- New binder</span><span>
</span><a name="line-474"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>              </span><span class="hs-comment">-- Simplified RHS</span><span>
</span><a name="line-475"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-476"></a><span class="hs-comment">-- Precondition: rhs satisfies the let/app invariant</span><span>
</span><a name="line-477"></a><span class="hs-comment">--               See Note [CoreSyn let/app invariant] in CoreSyn</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><a name="completeNonRecX"><a href="Simplify.html#completeNonRecX"><span class="hs-identifier">completeNonRecX</span></a></a><span> </span><a name="local-6989586621679788728"><a href="#local-6989586621679788728"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788729"><a href="#local-6989586621679788729"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788730"><a href="#local-6989586621679788730"><span class="hs-identifier">is_strict</span></a></a><span> </span><a name="local-6989586621679788731"><a href="#local-6989586621679788731"><span class="hs-identifier">old_bndr</span></a></a><span> </span><a name="local-6989586621679788732"><a href="#local-6989586621679788732"><span class="hs-identifier">new_bndr</span></a></a><span> </span><a name="local-6989586621679788733"><a href="#local-6989586621679788733"><span class="hs-identifier">new_rhs</span></a></a><span>
</span><a name="line-480"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isJoinId</span><span> </span><span class="hs-identifier">new_bndr</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788734"><a href="#local-6989586621679788734"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788735"><a href="#local-6989586621679788735"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#prepareRhs"><span class="hs-identifier hs-var">prepareRhs</span></a><span> </span><a href="#local-6989586621679788728"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapFloats"><span class="hs-identifier hs-var">zapFloats</span></a><span> </span><a href="#local-6989586621679788729"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788732"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><a href="#local-6989586621679788733"><span class="hs-identifier hs-var">new_rhs</span></a><span>
</span><a name="line-482"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788736"><a href="#local-6989586621679788736"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788737"><a href="#local-6989586621679788737"><span class="hs-identifier">rhs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-483"></a><span>                </span><span class="hs-keyword">if</span><span> </span><a href="SimplEnv.html#doFloatFromRhs"><span class="hs-identifier hs-var">doFloatFromRhs</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a href="#local-6989586621679788730"><span class="hs-identifier hs-var">is_strict</span></a><span> </span><a href="#local-6989586621679788735"><span class="hs-identifier hs-var">rhs1</span></a><span> </span><a href="#local-6989586621679788734"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-484"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="CoreMonad.html#LetFloatFromLet"><span class="hs-identifier hs-var">LetFloatFromLet</span></a><span>
</span><a name="line-485"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#addFloats"><span class="hs-identifier hs-var">addFloats</span></a><span> </span><a href="#local-6989586621679788729"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788734"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788735"><span class="hs-identifier hs-var">rhs1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-comment">-- Add the floats to the main env</span><span>
</span><a name="line-486"></a><span>                </span><span class="hs-keyword">else</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788729"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-6989586621679788734"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679788735"><span class="hs-identifier hs-var">rhs1</span></a><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Wrap the floats around the RHS</span><span>
</span><a name="line-487"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#completeBind"><span class="hs-identifier hs-var">completeBind</span></a><span> </span><a href="#local-6989586621679788736"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-488"></a><span>                       </span><a href="#local-6989586621679788731"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><a href="#local-6989586621679788732"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><a href="#local-6989586621679788737"><span class="hs-identifier hs-var">rhs2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-comment">{-
{- No, no, no!  Do not try preInlineUnconditionally in completeNonRecX
   Doing so risks exponential behaviour, because new_rhs has been simplified once already
   In the cases described by the following comment, postInlineUnconditionally will
   catch many of the relevant cases.
        -- This happens; for example, the case_bndr during case of
        -- known constructor:  case (a,b) of x { (p,q) -&gt; ... }
        -- Here x isn't mentioned in the RHS, so we don't want to
        -- create the (dead) let-binding  let x = (a,b) in ...
        --
        -- Similarly, single occurrences can be inlined vigourously
        -- e.g.  case (f x, g y) of (a,b) -&gt; ....
        -- If a,b occur once we can avoid constructing the let binding for them.

   Furthermore in the case-binding case preInlineUnconditionally risks extra thunks
        -- Consider     case I# (quotInt# x y) of
        --                I# v -&gt; let w = J# v in ...
        -- If we gaily inline (quotInt# x y) for v, we end up building an
        -- extra thunk:
        --                let w = J# (quotInt# x y) in ...
        -- because quotInt# can fail.

  | preInlineUnconditionally env NotTopLevel bndr new_rhs
  = thing_inside (extendIdSubst env bndr (DoneEx new_rhs))
-}

----------------------------------
prepareRhs takes a putative RHS, checks whether it's a PAP or
constructor application and, if so, converts it to ANF, so that the
resulting thing can be inlined more easily.  Thus
        x = (f a, g b)
becomes
        t1 = f a
        t2 = g b
        x = (t1,t2)

We also want to deal well cases like this
        v = (f e1 `cast` co) e2
Here we want to make e1,e2 trivial and get
        x1 = e1; x2 = e2; v = (f x1 `cast` co) v2
That's what the 'go' loop in prepareRhs does
-}</span><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span class="hs-identifier">prepareRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- Adds new floats to the env iff that allows us to return a good RHS</span><span>
</span><a name="line-535"></a><a name="prepareRhs"><a href="Simplify.html#prepareRhs"><span class="hs-identifier">prepareRhs</span></a></a><span> </span><a name="local-6989586621679788738"><a href="#local-6989586621679788738"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788739"><a href="#local-6989586621679788739"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788740"><a href="#local-6989586621679788740"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621679788741"><a href="#local-6989586621679788741"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621679788742"><a href="#local-6989586621679788742"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Note [Float coercions]</span><span>
</span><a name="line-536"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621679788745"><a href="#local-6989586621679788745"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621679788746"><a href="#local-6989586621679788746"><span class="hs-identifier">_ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621679788742"><span class="hs-identifier hs-var">co</span></a><span>       </span><span class="hs-comment">-- Do *not* do this if rhs has an unlifted type</span><span>
</span><a name="line-537"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><a href="#local-6989586621679788745"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>            </span><span class="hs-comment">-- see Note [Float coercions (unlifted)]</span><span>
</span><a name="line-538"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788747"><a href="#local-6989586621679788747"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788748"><a href="#local-6989586621679788748"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#makeTrivialWithInfo"><span class="hs-identifier hs-var">makeTrivialWithInfo</span></a><span> </span><a href="#local-6989586621679788738"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788739"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a><span> </span><a href="#local-6989586621679788740"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788743"><span class="hs-identifier hs-var">sanitised_info</span></a><span> </span><a href="#local-6989586621679788741"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-539"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788747"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a href="#local-6989586621679788748"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621679788742"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-540"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-541"></a><span>    </span><a name="local-6989586621679788743"><a href="#local-6989586621679788743"><span class="hs-identifier">sanitised_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a><span> </span><span class="hs-special">`</span><a href="IdInfo.html#setStrictnessInfo"><span class="hs-identifier hs-var">setStrictnessInfo</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">strictnessInfo</span><span> </span><a href="#local-6989586621679788744"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-542"></a><span>                                   </span><span class="hs-special">`</span><a href="IdInfo.html#setDemandInfo"><span class="hs-identifier hs-var">setDemandInfo</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">demandInfo</span><span> </span><a href="#local-6989586621679788744"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-543"></a><span>    </span><a name="local-6989586621679788744"><a href="#local-6989586621679788744"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621679788740"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span class="hs-identifier">prepareRhs</span><span> </span><a name="local-6989586621679788749"><a href="#local-6989586621679788749"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788750"><a href="#local-6989586621679788750"><span class="hs-identifier">env0</span></a></a><span> </span><a name="local-6989586621679788751"><a href="#local-6989586621679788751"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621679788752"><a href="#local-6989586621679788752"><span class="hs-identifier">rhs0</span></a></a><span>
</span><a name="line-546"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788797"><a href="#local-6989586621679788797"><span class="hs-identifier">_is_exp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788798"><a href="#local-6989586621679788798"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788799"><a href="#local-6989586621679788799"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788753"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679788750"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621679788752"><span class="hs-identifier hs-var">rhs0</span></a><span>
</span><a name="line-547"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788798"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788799"><span class="hs-identifier hs-var">rhs1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-548"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-549"></a><span>    </span><a name="local-6989586621679788753"><a href="#local-6989586621679788753"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679788754"><a href="#local-6989586621679788754"><span class="hs-identifier">n_val_args</span></a></a><span> </span><a name="local-6989586621679788755"><a href="#local-6989586621679788755"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621679788756"><a href="#local-6989586621679788756"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621679788757"><a href="#local-6989586621679788757"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788758"><a href="#local-6989586621679788758"><span class="hs-identifier">is_exp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788759"><a href="#local-6989586621679788759"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788760"><a href="#local-6989586621679788760"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788753"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679788754"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><a href="#local-6989586621679788755"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788756"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-551"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788758"><span class="hs-identifier hs-var">is_exp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788759"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a href="#local-6989586621679788760"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621679788757"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-552"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679788761"><a href="#local-6989586621679788761"><span class="hs-identifier">n_val_args</span></a></a><span> </span><a name="local-6989586621679788762"><a href="#local-6989586621679788762"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621679788763"><a href="#local-6989586621679788763"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621679788764"><a href="#local-6989586621679788764"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788765"><a href="#local-6989586621679788765"><span class="hs-identifier">is_exp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788766"><a href="#local-6989586621679788766"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788767"><a href="#local-6989586621679788767"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788753"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679788761"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><a href="#local-6989586621679788762"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788763"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-554"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788765"><span class="hs-identifier hs-var">is_exp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788766"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621679788767"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621679788764"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-555"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679788768"><a href="#local-6989586621679788768"><span class="hs-identifier">n_val_args</span></a></a><span> </span><a name="local-6989586621679788769"><a href="#local-6989586621679788769"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621679788770"><a href="#local-6989586621679788770"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679788771"><a href="#local-6989586621679788771"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-556"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788772"><a href="#local-6989586621679788772"><span class="hs-identifier">is_exp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788773"><a href="#local-6989586621679788773"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788774"><a href="#local-6989586621679788774"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788753"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788768"><span class="hs-identifier hs-var">n_val_args</span></a><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788769"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788770"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-557"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679788772"><span class="hs-identifier hs-var">is_exp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-558"></a><span>                </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788775"><a href="#local-6989586621679788775"><span class="hs-identifier">env''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788776"><a href="#local-6989586621679788776"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#makeTrivial"><span class="hs-identifier hs-var">makeTrivial</span></a><span> </span><a href="#local-6989586621679788749"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788773"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a><span> </span><a href="#local-6989586621679788751"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788771"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-559"></a><span>                           </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788775"><span class="hs-identifier hs-var">env''</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621679788774"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621679788776"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-560"></a><span>                </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788769"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621679788770"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679788771"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-561"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679788777"><a href="#local-6989586621679788777"><span class="hs-identifier">n_val_args</span></a></a><span> </span><a name="local-6989586621679788778"><a href="#local-6989586621679788778"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679788779"><a href="#local-6989586621679788779"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788780"><span class="hs-identifier hs-var">is_exp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788778"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621679788779"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-564"></a><span>          </span><a name="local-6989586621679788780"><a href="#local-6989586621679788780"><span class="hs-identifier">is_exp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#isExpandableApp"><span class="hs-identifier hs-var">isExpandableApp</span></a><span> </span><a href="#local-6989586621679788779"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679788777"><span class="hs-identifier hs-var">n_val_args</span></a><span>   </span><span class="hs-comment">-- The fun a constructor or PAP</span><span>
</span><a name="line-565"></a><span>                        </span><span class="hs-comment">-- See Note [CONLIKE pragma] in BasicTypes</span><span>
</span><a name="line-566"></a><span>                        </span><span class="hs-comment">-- The definition of is_exp should match that in</span><span>
</span><a name="line-567"></a><span>                        </span><span class="hs-comment">-- OccurAnal.occAnalApp</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679788781"><a href="#local-6989586621679788781"><span class="hs-identifier">n_val_args</span></a></a><span> </span><a name="local-6989586621679788782"><a href="#local-6989586621679788782"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621679788783"><a href="#local-6989586621679788783"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679788784"><a href="#local-6989586621679788784"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-570"></a><span>        </span><span class="hs-comment">-- We want to be able to float bindings past this</span><span>
</span><a name="line-571"></a><span>        </span><span class="hs-comment">-- tick. Non-scoping ticks don't care.</span><span>
</span><a name="line-572"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishScoped"><span class="hs-identifier hs-var">tickishScoped</span></a><span> </span><a href="#local-6989586621679788783"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoreSyn.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span>
</span><a name="line-573"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788785"><a href="#local-6989586621679788785"><span class="hs-identifier">is_exp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788786"><a href="#local-6989586621679788786"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788787"><a href="#local-6989586621679788787"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788753"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679788781"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><a href="#local-6989586621679788782"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788784"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-574"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788785"><span class="hs-identifier hs-var">is_exp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788786"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621679788783"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679788787"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-575"></a><span>        </span><span class="hs-comment">-- On the other hand, for scoping ticks we need to be able to</span><span>
</span><a name="line-576"></a><span>        </span><span class="hs-comment">-- copy them on the floats, which in turn is only allowed if</span><span>
</span><a name="line-577"></a><span>        </span><span class="hs-comment">-- we can obtain non-counting ticks.</span><span>
</span><a name="line-578"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-6989586621679788783"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="CoreSyn.html#tickishCanSplit"><span class="hs-identifier hs-var">tickishCanSplit</span></a><span> </span><a href="#local-6989586621679788783"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788788"><a href="#local-6989586621679788788"><span class="hs-identifier">is_exp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788789"><a href="#local-6989586621679788789"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788790"><a href="#local-6989586621679788790"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788753"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679788781"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapFloats"><span class="hs-identifier hs-var">zapFloats</span></a><span> </span><a href="#local-6989586621679788782"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788784"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-580"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788791"><a href="#local-6989586621679788791"><span class="hs-identifier">tickIt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679788793"><a href="#local-6989586621679788793"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788794"><a href="#local-6989586621679788794"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>                       </span><span class="hs-comment">-- we have to take care not to tick top-level literal</span><span>
</span><a name="line-582"></a><span>                       </span><span class="hs-comment">-- strings. See Note [CoreSyn top-level string literals].</span><span>
</span><a name="line-583"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="BasicTypes.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a><span> </span><a href="#local-6989586621679788749"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreUtils.html#exprIsLiteralString"><span class="hs-identifier hs-var">exprIsLiteralString</span></a><span> </span><a href="#local-6989586621679788794"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-584"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788793"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788794"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-586"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788793"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkNoCount"><span class="hs-identifier hs-var">mkNoCount</span></a><span> </span><a href="#local-6989586621679788783"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788794"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>                   </span><a name="local-6989586621679788792"><a href="#local-6989586621679788792"><span class="hs-identifier">floats'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">seFloats</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621679788782"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#addFloats"><span class="hs-identifier hs-var">addFloats</span></a><span class="hs-special">`</span><span> </span><a href="SimplEnv.html#mapFloats"><span class="hs-identifier hs-var">mapFloats</span></a><span> </span><a href="#local-6989586621679788789"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679788791"><span class="hs-identifier hs-var">tickIt</span></a><span>
</span><a name="line-588"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788788"><span class="hs-identifier hs-var">is_exp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788789"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788792"><span class="hs-identifier hs-var">floats'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621679788783"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679788790"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679788795"><a href="#local-6989586621679788795"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788796"><a href="#local-6989586621679788796"><span class="hs-identifier">other</span></a></a><span>
</span><a name="line-591"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788795"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788796"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span class="hs-comment">{-
Note [Float coercions]
~~~~~~~~~~~~~~~~~~~~~~
When we find the binding
        x = e `cast` co
we'd like to transform it to
        x' = e
        x = x `cast` co         -- A trivial binding
There's a chance that e will be a constructor application or function, or something
like that, so moving the coercion to the usage site may well cancel the coercions
and lead to further optimisation.  Example:

     data family T a :: *
     data instance T Int = T Int

     foo :: Int -&gt; Int -&gt; Int
     foo m n = ...
        where
          x = T m
          go 0 = 0
          go n = case x of { T m -&gt; go (n-m) }
                -- This case should optimise

Note [Preserve strictness when floating coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the Note [Float coercions] transformation, keep the strictness info.
Eg
        f = e `cast` co    -- f has strictness SSL
When we transform to
        f' = e             -- f' also has strictness SSL
        f = f' `cast` co   -- f still has strictness SSL

Its not wrong to drop it on the floor, but better to keep it.

Note [Float coercions (unlifted)]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
BUT don't do [Float coercions] if 'e' has an unlifted type.
This *can* happen:

     foo :: Int = (error (# Int,Int #) &quot;urk&quot;)
                  `cast` CoUnsafe (# Int,Int #) Int

If do the makeTrivial thing to the error call, we'll get
    foo = case error (# Int,Int #) &quot;urk&quot; of v -&gt; v `cast` ...
But 'v' isn't in scope!

These strange casts can happen as a result of case-of-case
        bar = case (case x of { T -&gt; (# 2,3 #); F -&gt; error &quot;urk&quot; }) of
                (# p,q #) -&gt; p+q
-}</span><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span class="hs-identifier">makeTrivialArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span class="hs-special">)</span><span>
</span><a name="line-645"></a><a name="makeTrivialArg"><a href="Simplify.html#makeTrivialArg"><span class="hs-identifier">makeTrivialArg</span></a></a><span> </span><a name="local-6989586621679788800"><a href="#local-6989586621679788800"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a><span> </span><a name="local-6989586621679788801"><a href="#local-6989586621679788801"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-646"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788802"><a href="#local-6989586621679788802"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788803"><a href="#local-6989586621679788803"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#makeTrivial"><span class="hs-identifier hs-var">makeTrivial</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="#local-6989586621679788800"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;arg&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788801"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-647"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788802"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a><span> </span><a href="#local-6989586621679788803"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-648"></a><span class="hs-identifier">makeTrivialArg</span><span> </span><a name="local-6989586621679788804"><a href="#local-6989586621679788804"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788805"><a href="#local-6989586621679788805"><span class="hs-identifier">arg</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788804"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788805"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- CastBy, TyArg</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-identifier">makeTrivial</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-651"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>  </span><span class="hs-comment">-- ^ a &quot;friendly name&quot; to build the new binder from</span><span>
</span><a name="line-652"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span class="hs-comment">-- Binds the expression to a variable, if it's not trivial, returning the variable</span><span>
</span><a name="line-654"></a><a name="makeTrivial"><a href="Simplify.html#makeTrivial"><span class="hs-identifier">makeTrivial</span></a></a><span> </span><a name="local-6989586621679788806"><a href="#local-6989586621679788806"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788807"><a href="#local-6989586621679788807"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788808"><a href="#local-6989586621679788808"><span class="hs-identifier">context</span></a></a><span> </span><a name="local-6989586621679788809"><a href="#local-6989586621679788809"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-655"></a><span>    </span><a href="Simplify.html#makeTrivialWithInfo"><span class="hs-identifier hs-var">makeTrivialWithInfo</span></a><span> </span><a href="#local-6989586621679788806"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788807"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788808"><span class="hs-identifier hs-var">context</span></a><span> </span><a href="IdInfo.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a><span> </span><a href="#local-6989586621679788809"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span class="hs-identifier">makeTrivialWithInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-658"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-659"></a><span>                    </span><span class="hs-comment">-- ^ a &quot;friendly name&quot; to build the new binder from</span><span>
</span><a name="line-660"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-661"></a><span class="hs-comment">-- Propagate strictness and demand info to the new binder</span><span>
</span><a name="line-662"></a><span class="hs-comment">-- Note [Preserve strictness when floating coercions]</span><span>
</span><a name="line-663"></a><span class="hs-comment">-- Returned SimplEnv has same substitution as incoming one</span><span>
</span><a name="line-664"></a><a name="makeTrivialWithInfo"><a href="Simplify.html#makeTrivialWithInfo"><span class="hs-identifier">makeTrivialWithInfo</span></a></a><span> </span><a name="local-6989586621679788810"><a href="#local-6989586621679788810"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788811"><a href="#local-6989586621679788811"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788812"><a href="#local-6989586621679788812"><span class="hs-identifier">context</span></a></a><span> </span><a name="local-6989586621679788813"><a href="#local-6989586621679788813"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621679788814"><a href="#local-6989586621679788814"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-665"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-6989586621679788814"><span class="hs-identifier hs-var">expr</span></a><span>                          </span><span class="hs-comment">-- Already trivial</span><span>
</span><a name="line-666"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Simplify.html#bindingOk"><span class="hs-identifier hs-var">bindingOk</span></a><span> </span><a href="#local-6989586621679788810"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788814"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679788815"><span class="hs-identifier hs-var">expr_ty</span></a><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Cannot trivialise</span><span>
</span><a name="line-667"></a><span>                                                </span><span class="hs-comment">--   See Note [Cannot trivialise]</span><span>
</span><a name="line-668"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788811"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788814"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-669"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>           </span><span class="hs-comment">-- See Note [Take care] below</span><span>
</span><a name="line-670"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788816"><a href="#local-6989586621679788816"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqSupply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a><span>
</span><a name="line-671"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788817"><a href="#local-6989586621679788817"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#mkSystemVarName"><span class="hs-identifier hs-var">mkSystemVarName</span></a><span> </span><a href="#local-6989586621679788816"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621679788812"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-672"></a><span>              </span><a name="local-6989586621679788818"><a href="#local-6989586621679788818"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#mkLocalIdOrCoVarWithInfo"><span class="hs-identifier hs-var">mkLocalIdOrCoVarWithInfo</span></a><span> </span><a href="#local-6989586621679788817"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679788815"><span class="hs-identifier hs-var">expr_ty</span></a><span> </span><a href="#local-6989586621679788813"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-673"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788819"><a href="#local-6989586621679788819"><span class="hs-identifier">env'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#completeNonRecX"><span class="hs-identifier hs-var">completeNonRecX</span></a><span> </span><a href="#local-6989586621679788810"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788811"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679788818"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621679788818"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621679788814"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-674"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788820"><a href="#local-6989586621679788820"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplVar"><span class="hs-identifier hs-var">simplVar</span></a><span> </span><a href="#local-6989586621679788819"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679788818"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-675"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788819"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788820"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-676"></a><span>        </span><span class="hs-comment">-- The simplVar is needed because we're constructing a new binding</span><span>
</span><a name="line-677"></a><span>        </span><span class="hs-comment">--     a = rhs</span><span>
</span><a name="line-678"></a><span>        </span><span class="hs-comment">-- And if rhs is of form (rhs1 |&gt; co), then we might get</span><span>
</span><a name="line-679"></a><span>        </span><span class="hs-comment">--     a1 = rhs1</span><span>
</span><a name="line-680"></a><span>        </span><span class="hs-comment">--     a = a1 |&gt; co</span><span>
</span><a name="line-681"></a><span>        </span><span class="hs-comment">-- and now a's RHS is trivial and can be substituted out, and that</span><span>
</span><a name="line-682"></a><span>        </span><span class="hs-comment">-- is what completeNonRecX will do</span><span>
</span><a name="line-683"></a><span>        </span><span class="hs-comment">-- To put it another way, it's as if we'd simplified</span><span>
</span><a name="line-684"></a><span>        </span><span class="hs-comment">--    let var = e in var</span><span>
</span><a name="line-685"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-686"></a><span>    </span><a name="local-6989586621679788815"><a href="#local-6989586621679788815"><span class="hs-identifier">expr_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621679788814"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span class="hs-identifier">bindingOk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-689"></a><span class="hs-comment">-- True iff we can have a binding of this expression at this level</span><span>
</span><a name="line-690"></a><span class="hs-comment">-- Precondition: the type is the type of the expression</span><span>
</span><a name="line-691"></a><a name="bindingOk"><a href="Simplify.html#bindingOk"><span class="hs-identifier">bindingOk</span></a></a><span> </span><a name="local-6989586621679788821"><a href="#local-6989586621679788821"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788822"><a href="#local-6989586621679788822"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621679788823"><a href="#local-6989586621679788823"><span class="hs-identifier">expr_ty</span></a></a><span>
</span><a name="line-692"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="BasicTypes.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a><span> </span><a href="#local-6989586621679788821"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsTopLevelBindable"><span class="hs-identifier hs-var">exprIsTopLevelBindable</span></a><span> </span><a href="#local-6989586621679788822"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679788823"><span class="hs-identifier hs-var">expr_ty</span></a><span>
</span><a name="line-693"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-694"></a><span>
</span><a name="line-695"></a><span class="hs-comment">{-
Note [Cannot trivialise]
~~~~~~~~~~~~~~~~~~~~~~~~
Consider tih
   f :: Int -&gt; Addr#

   foo :: Bar
   foo = Bar (f 3)

Then we can't ANF-ise foo, even though we'd like to, because
we can't make a top-level binding for the Addr# (f 3). And if
so we don't want to turn it into
   foo = let x = f 3 in Bar x
because we'll just end up inlining x back, and that makes the
simplifier loop.  Better not to ANF-ise it at all.

Literal strings are an exception.

   foo = Ptr &quot;blob&quot;#

We want to turn this into:

   foo1 = &quot;blob&quot;#
   foo = Ptr foo1

See Note [CoreSyn top-level string literals] in CoreSyn.

************************************************************************
*                                                                      *
\subsection{Completing a lazy binding}
*                                                                      *
************************************************************************

completeBind
  * deals only with Ids, not TyVars
  * takes an already-simplified binder and RHS
  * is used for both recursive and non-recursive bindings
  * is used for both top-level and non-top-level bindings

It does the following:
  - tries discarding a dead binding
  - tries PostInlineUnconditionally
  - add unfolding [this is the only place we add an unfolding]
  - add arity

It does *not* attempt to do let-to-case.  Why?  Because it is used for
  - top-level bindings (when let-to-case is impossible)
  - many situations where the &quot;rhs&quot; is known to be a WHNF
                (so let-to-case is inappropriate).

Nor does it do the atomic-argument thing
-}</span><span>
</span><a name="line-747"></a><span>
</span><a name="line-748"></a><span class="hs-identifier">completeBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-749"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span>            </span><span class="hs-comment">-- Flag stuck into unfolding</span><span>
</span><a name="line-750"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span>                 </span><span class="hs-comment">-- Recursive binding?</span><span>
</span><a name="line-751"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>         </span><span class="hs-comment">-- Required only for join point</span><span>
</span><a name="line-752"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span>                    </span><span class="hs-comment">-- Old binder</span><span>
</span><a name="line-753"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>        </span><span class="hs-comment">-- New binder and RHS</span><span>
</span><a name="line-754"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-755"></a><span class="hs-comment">-- completeBind may choose to do its work</span><span>
</span><a name="line-756"></a><span class="hs-comment">--      * by extending the substitution (e.g. let x = y in ...)</span><span>
</span><a name="line-757"></a><span class="hs-comment">--      * or by adding to the floats in the envt</span><span>
</span><a name="line-758"></a><span class="hs-comment">--</span><span>
</span><a name="line-759"></a><span class="hs-comment">-- Precondition: rhs obeys the let/app invariant</span><span>
</span><a name="line-760"></a><a name="completeBind"><a href="Simplify.html#completeBind"><span class="hs-identifier">completeBind</span></a></a><span> </span><a name="local-6989586621679788824"><a href="#local-6989586621679788824"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788825"><a href="#local-6989586621679788825"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788826"><a href="#local-6989586621679788826"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621679788827"><a href="#local-6989586621679788827"><span class="hs-identifier">mb_cont</span></a></a><span> </span><a name="local-6989586621679788828"><a href="#local-6989586621679788828"><span class="hs-identifier">old_bndr</span></a></a><span> </span><a name="local-6989586621679788829"><a href="#local-6989586621679788829"><span class="hs-identifier">new_bndr</span></a></a><span> </span><a name="local-6989586621679788830"><a href="#local-6989586621679788830"><span class="hs-identifier">new_rhs</span></a></a><span>
</span><a name="line-761"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621679788828"><span class="hs-identifier hs-var">old_bndr</span></a><span>
</span><a name="line-762"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679788830"><span class="hs-identifier hs-var">new_rhs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-763"></a><span>     </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621679788831"><a href="#local-6989586621679788831"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><a href="#local-6989586621679788824"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788828"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><a href="#local-6989586621679788831"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>     </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#addNonRec"><span class="hs-identifier hs-var">addNonRec</span></a><span> </span><a href="#local-6989586621679788824"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788829"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><a href="#local-6989586621679788830"><span class="hs-identifier hs-var">new_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-767"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span> </span><span class="hs-identifier">new_bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788832"><a href="#local-6989586621679788832"><span class="hs-identifier">old_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621679788828"><span class="hs-identifier hs-var">old_bndr</span></a><span>
</span><a name="line-769"></a><span>            </span><a name="local-6989586621679788833"><a href="#local-6989586621679788833"><span class="hs-identifier">old_unf</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-6989586621679788832"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-770"></a><span>            </span><a name="local-6989586621679788834"><a href="#local-6989586621679788834"><span class="hs-identifier">occ_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">occInfo</span><span> </span><a href="#local-6989586621679788832"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span>        </span><span class="hs-comment">-- Do eta-expansion on the RHS of the binding</span><span>
</span><a name="line-773"></a><span>        </span><span class="hs-comment">-- See Note [Eta-expanding at let bindings] in SimplUtils</span><span>
</span><a name="line-774"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788835"><a href="#local-6989586621679788835"><span class="hs-identifier">new_arity</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788836"><a href="#local-6989586621679788836"><span class="hs-identifier">final_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a><span> </span><a href="#local-6989586621679788829"><span class="hs-identifier hs-var">new_bndr</span></a><span>
</span><a name="line-775"></a><span>                                    </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreArity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a><span> </span><a href="#local-6989586621679788830"><span class="hs-identifier hs-var">new_rhs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788830"><span class="hs-identifier hs-var">new_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-776"></a><span>                                         </span><span class="hs-comment">-- Note [Don't eta-expand join points]</span><span>
</span><a name="line-777"></a><span>                                    </span><span class="hs-keyword">else</span><span> </span><a href="SimplUtils.html#tryEtaExpandRhs"><span class="hs-identifier hs-var">tryEtaExpandRhs</span></a><span> </span><a href="#local-6989586621679788824"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788826"><span class="hs-identifier hs-var">is_rec</span></a><span>
</span><a name="line-778"></a><span>                                                         </span><a href="#local-6989586621679788829"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><a href="#local-6989586621679788830"><span class="hs-identifier hs-var">new_rhs</span></a><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span>        </span><span class="hs-comment">-- Simplify the unfolding</span><span>
</span><a name="line-781"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788837"><a href="#local-6989586621679788837"><span class="hs-identifier">new_unfolding</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplLetUnfolding"><span class="hs-identifier hs-var">simplLetUnfolding</span></a><span> </span><a href="#local-6989586621679788824"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788825"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788827"><span class="hs-identifier hs-var">mb_cont</span></a><span> </span><a href="#local-6989586621679788828"><span class="hs-identifier hs-var">old_bndr</span></a><span>
</span><a name="line-782"></a><span>                                           </span><a href="#local-6989586621679788836"><span class="hs-identifier hs-var">final_rhs</span></a><span> </span><a href="#local-6989586621679788833"><span class="hs-identifier hs-var">old_unf</span></a><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788838"><a href="#local-6989586621679788838"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-785"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="SimplUtils.html#postInlineUnconditionally"><span class="hs-identifier hs-var">postInlineUnconditionally</span></a><span> </span><a href="#local-6989586621679788838"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679788824"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788825"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679788829"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><a href="#local-6989586621679788834"><span class="hs-identifier hs-var">occ_info</span></a><span>
</span><a name="line-786"></a><span>                                     </span><a href="#local-6989586621679788836"><span class="hs-identifier hs-var">final_rhs</span></a><span> </span><a href="#local-6989586621679788837"><span class="hs-identifier hs-var">new_unfolding</span></a><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><span>                        </span><span class="hs-comment">-- Inline and discard the binding</span><span>
</span><a name="line-789"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#PostInlineUnconditionally"><span class="hs-identifier hs-var">PostInlineUnconditionally</span></a><span> </span><a href="#local-6989586621679788828"><span class="hs-identifier hs-var">old_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-790"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><a href="#local-6989586621679788824"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788828"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a><span> </span><a href="#local-6989586621679788836"><span class="hs-identifier hs-var">final_rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-791"></a><span>                </span><span class="hs-comment">-- Use the substitution to make quite, quite sure that the</span><span>
</span><a name="line-792"></a><span>                </span><span class="hs-comment">-- substitution will happen, since we are going to discard the binding</span><span>
</span><a name="line-793"></a><span>        </span><span class="hs-keyword">else</span><span>
</span><a name="line-794"></a><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788839"><a href="#local-6989586621679788839"><span class="hs-identifier">info1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621679788829"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><span class="hs-special">`</span><a href="IdInfo.html#setArityInfo"><span class="hs-identifier hs-var">setArityInfo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788835"><span class="hs-identifier hs-var">new_arity</span></a><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span>              </span><span class="hs-comment">-- Unfolding info: Note [Setting the new unfolding]</span><span>
</span><a name="line-797"></a><span>            </span><a name="local-6989586621679788840"><a href="#local-6989586621679788840"><span class="hs-identifier">info2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788839"><span class="hs-identifier hs-var">info1</span></a><span> </span><span class="hs-special">`</span><a href="IdInfo.html#setUnfoldingInfo"><span class="hs-identifier hs-var">setUnfoldingInfo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788837"><span class="hs-identifier hs-var">new_unfolding</span></a><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span>              </span><span class="hs-comment">-- Demand info: Note [Setting the demand info]</span><span>
</span><a name="line-800"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-801"></a><span>              </span><span class="hs-comment">-- We also have to nuke demand info if for some reason</span><span>
</span><a name="line-802"></a><span>              </span><span class="hs-comment">-- eta-expansion *reduces* the arity of the binding to less</span><span>
</span><a name="line-803"></a><span>              </span><span class="hs-comment">-- than that of the strictness sig. This can happen: see Note [Arity decrease].</span><span>
</span><a name="line-804"></a><span>            </span><a name="local-6989586621679788841"><a href="#local-6989586621679788841"><span class="hs-identifier">info3</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isEvaldUnfolding"><span class="hs-identifier hs-var">isEvaldUnfolding</span></a><span> </span><a href="#local-6989586621679788837"><span class="hs-identifier hs-var">new_unfolding</span></a><span>
</span><a name="line-805"></a><span>                    </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">strictnessInfo</span><span> </span><a href="#local-6989586621679788840"><span class="hs-identifier hs-var">info2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-806"></a><span>                          </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a name="local-6989586621679788844"><a href="#local-6989586621679788844"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679788835"><span class="hs-identifier hs-var">new_arity</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="Demand.html#dmdTypeDepth"><span class="hs-identifier hs-var">dmdTypeDepth</span></a><span> </span><a href="#local-6989586621679788844"><span class="hs-identifier hs-var">dmd_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-807"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#zapDemandInfo"><span class="hs-identifier hs-var">zapDemandInfo</span></a><span> </span><a href="#local-6989586621679788840"><span class="hs-identifier hs-var">info2</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788840"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-808"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-809"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788840"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span>              </span><span class="hs-comment">-- Zap call arity info. We have used it by now (via</span><span>
</span><a name="line-812"></a><span>              </span><span class="hs-comment">-- `tryEtaExpandRhs`), and the simplifier can invalidate this</span><span>
</span><a name="line-813"></a><span>              </span><span class="hs-comment">-- information, leading to broken code later (e.g. #13479)</span><span>
</span><a name="line-814"></a><span>            </span><a name="local-6989586621679788842"><a href="#local-6989586621679788842"><span class="hs-identifier">info4</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#zapCallArityInfo"><span class="hs-identifier hs-var">zapCallArityInfo</span></a><span> </span><a href="#local-6989586621679788841"><span class="hs-identifier hs-var">info3</span></a><span>
</span><a name="line-815"></a><span>
</span><a name="line-816"></a><span>            </span><a name="local-6989586621679788843"><a href="#local-6989586621679788843"><span class="hs-identifier">final_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788829"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdInfo"><span class="hs-identifier hs-var">setIdInfo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788842"><span class="hs-identifier hs-var">info4</span></a><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- pprTrace &quot;Binding&quot; (ppr final_id &lt;+&gt; ppr new_unfolding) $</span><span>
</span><a name="line-819"></a><span>        </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#addNonRec"><span class="hs-identifier hs-var">addNonRec</span></a><span> </span><a href="#local-6989586621679788824"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788843"><span class="hs-identifier hs-var">final_id</span></a><span> </span><a href="#local-6989586621679788836"><span class="hs-identifier hs-var">final_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-820"></a><span>                </span><span class="hs-comment">-- The addNonRec adds it to the in-scope set too</span><span>
</span><a name="line-821"></a><span>
</span><a name="line-822"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-823"></a><span class="hs-identifier">addPolyBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-824"></a><span class="hs-comment">-- Add a new binding to the environment, complete with its unfolding</span><span>
</span><a name="line-825"></a><span class="hs-comment">-- but *do not* do postInlineUnconditionally, because we have already</span><span>
</span><a name="line-826"></a><span class="hs-comment">-- processed some of the scope of the binding</span><span>
</span><a name="line-827"></a><span class="hs-comment">-- We still want the unfolding though.  Consider</span><span>
</span><a name="line-828"></a><span class="hs-comment">--      let</span><span>
</span><a name="line-829"></a><span class="hs-comment">--            x = /\a. let y = ... in Just y</span><span>
</span><a name="line-830"></a><span class="hs-comment">--      in body</span><span>
</span><a name="line-831"></a><span class="hs-comment">-- Then we float the y-binding out (via abstractFloats and addPolyBind)</span><span>
</span><a name="line-832"></a><span class="hs-comment">-- but 'x' may well then be inlined in 'body' in which case we'd like the</span><span>
</span><a name="line-833"></a><span class="hs-comment">-- opportunity to inline 'y' too.</span><span>
</span><a name="line-834"></a><span class="hs-comment">--</span><span>
</span><a name="line-835"></a><span class="hs-comment">-- INVARIANT: the arity is correct on the incoming binders</span><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><a name="addPolyBind"><a href="Simplify.html#addPolyBind"><span class="hs-identifier">addPolyBind</span></a></a><span> </span><a name="local-6989586621679788845"><a href="#local-6989586621679788845"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679788846"><a href="#local-6989586621679788846"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621679788847"><a href="#local-6989586621679788847"><span class="hs-identifier">poly_id</span></a></a><span> </span><a name="local-6989586621679788848"><a href="#local-6989586621679788848"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-838"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788849"><a href="#local-6989586621679788849"><span class="hs-identifier">unfolding</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplLetUnfolding"><span class="hs-identifier hs-var">simplLetUnfolding</span></a><span> </span><a href="#local-6989586621679788846"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788845"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621679788847"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="#local-6989586621679788848"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-839"></a><span>                                         </span><a href="CoreSyn.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a><span>
</span><a name="line-840"></a><span>                        </span><span class="hs-comment">-- Assumes that poly_id did not have an INLINE prag</span><span>
</span><a name="line-841"></a><span>                        </span><span class="hs-comment">-- which is perhaps wrong.  ToDo: think about this</span><span>
</span><a name="line-842"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788850"><a href="#local-6989586621679788850"><span class="hs-identifier">final_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdInfo"><span class="hs-identifier hs-var">setIdInfo</span></a><span> </span><a href="#local-6989586621679788847"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-843"></a><span>                         </span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621679788847"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-special">`</span><a href="IdInfo.html#setUnfoldingInfo"><span class="hs-identifier hs-var">setUnfoldingInfo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788849"><span class="hs-identifier hs-var">unfolding</span></a><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#addNonRec"><span class="hs-identifier hs-var">addNonRec</span></a><span> </span><a href="#local-6989586621679788846"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788850"><span class="hs-identifier hs-var">final_id</span></a><span> </span><a href="#local-6989586621679788848"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span class="hs-identifier">addPolyBind</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679788851"><a href="#local-6989586621679788851"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788852"><a href="#local-6989586621679788852"><span class="hs-identifier">bind</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendFloats"><span class="hs-identifier hs-var">extendFloats</span></a><span> </span><a href="#local-6989586621679788851"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788852"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>        </span><span class="hs-comment">-- Hack: letrecs are more awkward, so we extend &quot;by steam&quot;</span><span>
</span><a name="line-850"></a><span>        </span><span class="hs-comment">-- without adding unfoldings etc.  At worst this leads to</span><span>
</span><a name="line-851"></a><span>        </span><span class="hs-comment">-- more simplifier iterations</span><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span class="hs-comment">{- Note [Arity decrease]
~~~~~~~~~~~~~~~~~~~~~~~~
Generally speaking the arity of a binding should not decrease.  But it *can*
legitimately happen because of RULES.  Eg
        f = g Int
where g has arity 2, will have arity 2.  But if there's a rewrite rule
        g Int --&gt; h
where h has arity 1, then f's arity will decrease.  Here's a real-life example,
which is in the output of Specialise:

     Rec {
        $dm {Arity 2} = \d.\x. op d
        {-# RULES forall d. $dm Int d = $s$dm #-}

        dInt = MkD .... opInt ...
        opInt {Arity 1} = $dm dInt

        $s$dm {Arity 0} = \x. op dInt }

Here opInt has arity 1; but when we apply the rule its arity drops to 0.
That's why Specialise goes to a little trouble to pin the right arity
on specialised functions too.

Note [Setting the demand info]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the unfolding is a value, the demand info may
go pear-shaped, so we nuke it.  Example:
     let x = (a,b) in
     case x of (p,q) -&gt; h p q x
Here x is certainly demanded. But after we've nuked
the case, we'll get just
     let x = (a,b) in h a b x
and now x is not demanded (I'm assuming h is lazy)
This really happens.  Similarly
     let f = \x -&gt; e in ...f..f...
After inlining f at some of its call sites the original binding may
(for example) be no longer strictly demanded.
The solution here is a bit ad hoc...

Note [Don't eta-expand join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Similarly to CPR (see Note [Don't CPR join points] in WorkWrap), a join point
stands well to gain from its outer binding's eta-expansion, and eta-expanding a
join point is fraught with issues like how to deal with a cast:

    let join $j1 :: IO ()
             $j1 = ...
             $j2 :: Int -&gt; IO ()
             $j2 n = if n &gt; 0 then $j1
                              else ...

    =&gt;

    let join $j1 :: IO ()
             $j1 = (\eta -&gt; ...)
                     `cast` N:IO :: State# RealWorld -&gt; (# State# RealWorld, ())
                                 ~  IO ()
             $j2 :: Int -&gt; IO ()
             $j2 n = (\eta -&gt; if n &gt; 0 then $j1
                                       else ...)
                     `cast` N:IO :: State# RealWorld -&gt; (# State# RealWorld, ())
                                 ~  IO ()

The cast here can't be pushed inside the lambda (since it's not casting to a
function type), so the lambda has to stay, but it can't because it contains a
reference to a join point. In fact, $j2 can't be eta-expanded at all. Rather
than try and detect this situation (and whatever other situations crop up!), we
don't bother; again, any surrounding eta-expansion will improve these join
points anyway, since an outer cast can *always* be pushed inside. By the time
CorePrep comes around, the code is very likely to look more like this:

    let join $j1 :: State# RealWorld -&gt; (# State# RealWorld, ())
             $j1 = (...) eta
             $j2 :: Int -&gt; State# RealWorld -&gt; (# State# RealWorld, ())
             $j2 = if n &gt; 0 then $j1
                            else (...) eta

************************************************************************
*                                                                      *
\subsection[Simplify-simplExpr]{The main function: simplExpr}
*                                                                      *
************************************************************************

The reason for this OutExprStuff stuff is that we want to float *after*
simplifying a RHS, not before.  If we do so naively we get quadratic
behaviour as things float out.

To see why it's important to do it after, consider this (real) example:

        let t = f x
        in fst t
==&gt;
        let t = let a = e1
                    b = e2
                in (a,b)
        in fst t
==&gt;
        let a = e1
            b = e2
            t = (a,b)
        in
        a       -- Can't inline a this round, cos it appears twice
==&gt;
        e1

Each of the ==&gt; steps is a round of simplification.  We'd save a
whole round if we float first.  This can cascade.  Consider

        let f = g d
        in \x -&gt; ...f...
==&gt;
        let f = let d1 = ..d.. in \y -&gt; e
        in \x -&gt; ...f...
==&gt;
        let d1 = ..d..
        in \x -&gt; ...(\y -&gt;e)...

Only in this second round can the \y be applied, and it
might do the same again.
-}</span><span>
</span><a name="line-974"></a><span>
</span><a name="line-975"></a><span class="hs-identifier">simplExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-976"></a><a name="simplExpr"><a href="Simplify.html#simplExpr"><span class="hs-identifier">simplExpr</span></a></a><span> </span><a name="local-6989586621679788853"><a href="#local-6989586621679788853"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621679788854"><a href="#local-6989586621679788854"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-977"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788855"><a href="#local-6989586621679788855"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplType"><span class="hs-identifier hs-var">simplType</span></a><span> </span><a href="#local-6989586621679788853"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788854"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><a name="line-978"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621679788855"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-979"></a><span>
</span><a name="line-980"></a><span class="hs-identifier">simplExpr</span><span> </span><a name="local-6989586621679788856"><a href="#local-6989586621679788856"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788857"><a href="#local-6989586621679788857"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-981"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a><span> </span><a href="#local-6989586621679788856"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788857"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><a href="#local-6989586621679788858"><span class="hs-identifier hs-var">expr_out_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-983"></a><span>    </span><span class="hs-identifier">expr_out_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#OutType"><span class="hs-identifier hs-type">OutType</span></a><span>
</span><a name="line-984"></a><span>    </span><a name="local-6989586621679788858"><a href="#local-6989586621679788858"><span class="hs-identifier">expr_out_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621679788856"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621679788857"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-985"></a><span>    </span><span class="hs-comment">-- NB: Since 'expr' is term-valued, not (Type ty), this call</span><span>
</span><a name="line-986"></a><span>    </span><span class="hs-comment">--     to exprType will succeed.  exprType fails on (Type ty).</span><span>
</span><a name="line-987"></a><span>
</span><a name="line-988"></a><span class="hs-identifier">simplExprC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-989"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span>     </span><span class="hs-comment">-- A term-valued expression, never (Type ty)</span><span>
</span><a name="line-990"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-991"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-992"></a><span>        </span><span class="hs-comment">-- Simplify an expression, given a continuation</span><span>
</span><a name="line-993"></a><a name="simplExprC"><a href="Simplify.html#simplExprC"><span class="hs-identifier">simplExprC</span></a></a><span> </span><a name="local-6989586621679788859"><a href="#local-6989586621679788859"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788860"><a href="#local-6989586621679788860"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621679788861"><a href="#local-6989586621679788861"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-994"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;simplExprC&quot; (ppr expr $$ ppr cont {- $$ ppr (seIdSubst env) -} $$ ppr (seFloats env) ) $</span><span>
</span><a name="line-995"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788862"><a href="#local-6989586621679788862"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788863"><a href="#local-6989586621679788863"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapFloats"><span class="hs-identifier hs-var">zapFloats</span></a><span> </span><a href="#local-6989586621679788859"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788860"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679788861"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-996"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- pprTrace &quot;simplExprC ret&quot; (ppr expr $$ ppr expr') $</span><span>
</span><a name="line-997"></a><span>          </span><span class="hs-comment">-- pprTrace &quot;simplExprC ret3&quot; (ppr (seInScope env')) $</span><span>
</span><a name="line-998"></a><span>          </span><span class="hs-comment">-- pprTrace &quot;simplExprC ret4&quot; (ppr (seFloats env')) $</span><span>
</span><a name="line-999"></a><span>          </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-6989586621679788862"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679788863"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1000"></a><span>
</span><a name="line-1001"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-1002"></a><span class="hs-identifier">simplExprF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-1003"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span>     </span><span class="hs-comment">-- A term-valued expression, never (Type ty)</span><span>
</span><a name="line-1004"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1005"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1006"></a><span>
</span><a name="line-1007"></a><a name="simplExprF"><a href="Simplify.html#simplExprF"><span class="hs-identifier">simplExprF</span></a></a><span> </span><a name="local-6989586621679788864"><a href="#local-6989586621679788864"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788865"><a href="#local-6989586621679788865"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621679788866"><a href="#local-6989586621679788866"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1008"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">{- pprTrace &quot;simplExprF&quot; (vcat
      [ ppr e
      , text &quot;cont =&quot; &lt;+&gt; ppr cont
      , text &quot;inscope =&quot; &lt;+&gt; ppr (seInScope env)
      , text &quot;tvsubst =&quot; &lt;+&gt; ppr (seTvSubst env)
      , text &quot;idsubst =&quot; &lt;+&gt; ppr (seIdSubst env)
      , text &quot;cvsubst =&quot; &lt;+&gt; ppr (seCvSubst env)
      {- , ppr (seFloats env) -}
      ]) $ -}</span><span>
</span><a name="line-1017"></a><span>    </span><a href="Simplify.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a><span> </span><a href="#local-6989586621679788864"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788865"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679788866"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-identifier">simplExprF1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1020"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1021"></a><span>
</span><a name="line-1022"></a><a name="simplExprF1"><a href="Simplify.html#simplExprF1"><span class="hs-identifier">simplExprF1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621679788867"><a href="#local-6989586621679788867"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1023"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;simplExprF: type&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679788867"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>    </span><span class="hs-comment">-- simplExprF does only with term-valued expressions</span><span>
</span><a name="line-1025"></a><span>    </span><span class="hs-comment">-- The (Type ty) case is handled separately by simplExpr</span><span>
</span><a name="line-1026"></a><span>    </span><span class="hs-comment">-- and by the other callers of simplExprF</span><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788868"><a href="#local-6989586621679788868"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679788869"><a href="#local-6989586621679788869"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>        </span><a name="local-6989586621679788870"><a href="#local-6989586621679788870"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplIdF"><span class="hs-identifier hs-var">simplIdF</span></a><span> </span><a href="#local-6989586621679788868"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788869"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679788870"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1029"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788871"><a href="#local-6989586621679788871"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621679788872"><a href="#local-6989586621679788872"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>      </span><a name="local-6989586621679788873"><a href="#local-6989586621679788873"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679788871"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-6989586621679788872"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788873"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1030"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788874"><a href="#local-6989586621679788874"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621679788875"><a href="#local-6989586621679788875"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679788876"><a href="#local-6989586621679788876"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>  </span><a name="local-6989586621679788877"><a href="#local-6989586621679788877"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplTick"><span class="hs-identifier hs-var">simplTick</span></a><span> </span><a href="#local-6989586621679788874"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788875"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679788876"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679788877"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1031"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788878"><a href="#local-6989586621679788878"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621679788879"><a href="#local-6989586621679788879"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679788880"><a href="#local-6989586621679788880"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679788881"><a href="#local-6989586621679788881"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplCast"><span class="hs-identifier hs-var">simplCast</span></a><span> </span><a href="#local-6989586621679788878"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788879"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679788880"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621679788881"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1032"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788882"><a href="#local-6989586621679788882"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621679788883"><a href="#local-6989586621679788883"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>  </span><a name="local-6989586621679788884"><a href="#local-6989586621679788884"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplCoercionF"><span class="hs-identifier hs-var">simplCoercionF</span></a><span> </span><a href="#local-6989586621679788882"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788883"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621679788884"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1033"></a><span>
</span><a name="line-1034"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788885"><a href="#local-6989586621679788885"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621679788886"><a href="#local-6989586621679788886"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679788887"><a href="#local-6989586621679788887"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679788888"><a href="#local-6989586621679788888"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1035"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679788887"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1036"></a><span>      </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621679788889"><a href="#local-6989586621679788889"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- The argument type will (almost) certainly be used</span><span>
</span><a name="line-1037"></a><span>                      </span><span class="hs-comment">-- in the output program, so just force it now.</span><span>
</span><a name="line-1038"></a><span>                      </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><a name="line-1039"></a><span>                      </span><a name="local-6989586621679788890"><a href="#local-6989586621679788890"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplType"><span class="hs-identifier hs-var">simplType</span></a><span> </span><a href="#local-6989586621679788885"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788889"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span>                      </span><span class="hs-comment">-- But use substTy, not simplType, to avoid forcing</span><span>
</span><a name="line-1042"></a><span>                      </span><span class="hs-comment">-- the hole type; it will likely not be needed.</span><span>
</span><a name="line-1043"></a><span>                      </span><span class="hs-comment">-- See Note [The hole type in ApplyToTy]</span><span>
</span><a name="line-1044"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788891"><a href="#local-6989586621679788891"><span class="hs-identifier">hole'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621679788885"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621679788886"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-1045"></a><span>
</span><a name="line-1046"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679788885"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788886"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1047"></a><span>                      </span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg_ty</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788890"><span class="hs-identifier hs-var">arg'</span></a><span>
</span><a name="line-1048"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_hole_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788891"><span class="hs-identifier hs-var">hole'</span></a><span>
</span><a name="line-1049"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788888"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1050"></a><span>      </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679788885"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788886"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1051"></a><span>                 </span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788887"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788885"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1052"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788888"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1053"></a><span>
</span><a name="line-1054"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788892"><a href="#local-6989586621679788892"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788893"><a href="#local-6989586621679788893"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679788894"><a href="#local-6989586621679788894"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1055"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a><span> </span><a href="#local-6989586621679788892"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788897"><span class="hs-identifier hs-var">zapped_bndrs</span></a><span> </span><a href="#local-6989586621679788896"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679788894"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1056"></a><span>        </span><span class="hs-comment">-- The main issue here is under-saturated lambdas</span><span>
</span><a name="line-1057"></a><span>        </span><span class="hs-comment">--   (\x1. \x2. e) arg1</span><span>
</span><a name="line-1058"></a><span>        </span><span class="hs-comment">-- Here x1 might have &quot;occurs-once&quot; occ-info, because occ-info</span><span>
</span><a name="line-1059"></a><span>        </span><span class="hs-comment">-- is computed assuming that a group of lambdas is applied</span><span>
</span><a name="line-1060"></a><span>        </span><span class="hs-comment">-- all at once.  If there are too few args, we must zap the</span><span>
</span><a name="line-1061"></a><span>        </span><span class="hs-comment">-- occ-info, UNLESS the remaining binders are one-shot</span><span>
</span><a name="line-1062"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1063"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679788895"><a href="#local-6989586621679788895"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788896"><a href="#local-6989586621679788896"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a><span> </span><a href="#local-6989586621679788893"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1064"></a><span>    </span><a name="local-6989586621679788897"><a href="#local-6989586621679788897"><span class="hs-identifier">zapped_bndrs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679788898"><span class="hs-identifier hs-var">need_to_zap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621679788901"><span class="hs-identifier hs-var">zap</span></a><span> </span><a href="#local-6989586621679788895"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1065"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788895"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1066"></a><span>
</span><a name="line-1067"></a><span>    </span><a name="local-6989586621679788898"><a href="#local-6989586621679788898"><span class="hs-identifier">need_to_zap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="#local-6989586621679788900"><span class="hs-identifier hs-var">zappable_bndr</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#drop"><span class="hs-identifier hs-var">drop</span></a><span> </span><a href="#local-6989586621679788899"><span class="hs-identifier hs-var">n_args</span></a><span> </span><a href="#local-6989586621679788895"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1068"></a><span>    </span><a name="local-6989586621679788899"><a href="#local-6989586621679788899"><span class="hs-identifier">n_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a><span> </span><a href="#local-6989586621679788894"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1069"></a><span>        </span><span class="hs-comment">-- NB: countArgs counts all the args (incl type args)</span><span>
</span><a name="line-1070"></a><span>        </span><span class="hs-comment">-- and likewise drop counts all binders (incl type lambdas)</span><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span>    </span><a name="local-6989586621679788900"><a href="#local-6989586621679788900"><span class="hs-identifier">zappable_bndr</span></a></a><span> </span><a name="local-6989586621679788902"><a href="#local-6989586621679788902"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621679788902"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Id.html#isOneShotBndr"><span class="hs-identifier hs-var">isOneShotBndr</span></a><span> </span><a href="#local-6989586621679788902"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1073"></a><span>    </span><a name="local-6989586621679788901"><a href="#local-6989586621679788901"><span class="hs-identifier">zap</span></a></a><span> </span><a name="local-6989586621679788903"><a href="#local-6989586621679788903"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621679788903"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788903"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1074"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#zapLamIdInfo"><span class="hs-identifier hs-var">zapLamIdInfo</span></a><span> </span><a href="#local-6989586621679788903"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1075"></a><span>
</span><a name="line-1076"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788904"><a href="#local-6989586621679788904"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621679788905"><a href="#local-6989586621679788905"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679788906"><a href="#local-6989586621679788906"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679788907"><a href="#local-6989586621679788907"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679788908"><a href="#local-6989586621679788908"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1077"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679788904"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788905"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788906"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1078"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788907"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-1079"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788904"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788908"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1080"></a><span>
</span><a name="line-1081"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788909"><a href="#local-6989586621679788909"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621679788910"><a href="#local-6989586621679788910"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679788911"><a href="#local-6989586621679788911"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679788912"><a href="#local-6989586621679788912"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1082"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplRecE"><span class="hs-identifier hs-var">simplRecE</span></a><span> </span><a href="#local-6989586621679788909"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788910"><span class="hs-identifier hs-var">pairs</span></a><span> </span><a href="#local-6989586621679788911"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679788912"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1083"></a><span>
</span><a name="line-1084"></a><span class="hs-identifier">simplExprF1</span><span> </span><a name="local-6989586621679788913"><a href="#local-6989586621679788913"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621679788914"><a href="#local-6989586621679788914"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679788915"><a href="#local-6989586621679788915"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679788916"><a href="#local-6989586621679788916"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679788917"><a href="#local-6989586621679788917"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1085"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621679788918"><a href="#local-6989586621679788918"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788915"><span class="hs-identifier hs-var">rhs</span></a><span>    </span><span class="hs-comment">-- First deal with type lets (let a = Type ty in e)</span><span>
</span><a name="line-1086"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788919"><a href="#local-6989586621679788919"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplType"><span class="hs-identifier hs-var">simplType</span></a><span> </span><a href="#local-6989586621679788913"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788918"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1088"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621679788913"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788914"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788919"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788916"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679788917"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1089"></a><span>
</span><a name="line-1090"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1091"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplNonRecE"><span class="hs-identifier hs-var">simplNonRecE</span></a><span> </span><a href="#local-6989586621679788913"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788914"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788915"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788913"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788916"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788917"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1092"></a><span>
</span><a name="line-1093"></a><span class="hs-comment">{- Note [Avoiding space leaks in OutType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Since the simplifier is run for multiple iterations, we need to ensure
that any thunks in the output of one simplifier iteration are forced
by the evaluation of the next simplifier iteration. Otherwise we may
retain multiple copies of the Core program and leak a terrible amount
of memory (as in #13426).

The simplifier is naturally strict in the entire &quot;Expr part&quot; of the
input Core program, because any expression may contain binders, which
we must find in order to extend the SimplEnv accordingly. But types
do not contain binders and so it is tempting to write things like

    simplExpr env (Type ty) = return (Type (substTy env ty))   -- Bad!

This is Bad because the result includes a thunk (substTy env ty) which
retains a reference to the whole simplifier environment; and the next
simplifier iteration will not force this thunk either, because the
line above is not strict in ty.

So instead our strategy is for the simplifier to fully evaluate
OutTypes when it emits them into the output Core program, for example

    simplExpr env (Type ty) = do { ty' &lt;- simplType env ty     -- Good
                                 ; return (Type ty') }

where the only difference from above is that simplType calls seqType
on the result of substTy.

However, SimplCont can also contain OutTypes and it's not necessarily
a good idea to force types on the way in to SimplCont, because they
may end up not being used and forcing them could be a lot of wasted
work. T5631 is a good example of this.

- For ApplyToTy's sc_arg_ty, we force the type on the way in because
  the type will almost certainly appear as a type argument in the
  output program.

- For the hole types in Stop and ApplyToTy, we force the type when we
  emit it into the output program, after obtaining it from
  contResultType. (The hole type in ApplyToTy is only directly used
  to form the result type in a new Stop continuation.)
-}</span><span>
</span><a name="line-1136"></a><span>
</span><a name="line-1137"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-1138"></a><span class="hs-comment">-- Simplify a join point, adding the context.</span><span>
</span><a name="line-1139"></a><span class="hs-comment">-- Context goes *inside* the lambdas. IOW, if the join point has arity n, we do:</span><span>
</span><a name="line-1140"></a><span class="hs-comment">--   \x1 .. xn -&gt; e =&gt; \x1 .. xn -&gt; E[e]</span><span>
</span><a name="line-1141"></a><span class="hs-comment">-- Note that we need the arity of the join point, since e may be a lambda</span><span>
</span><a name="line-1142"></a><span class="hs-comment">-- (though this is unlikely). See Note [Case-of-case and join points].</span><span>
</span><a name="line-1143"></a><span class="hs-identifier">simplJoinRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1144"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-1145"></a><a name="simplJoinRhs"><a href="Simplify.html#simplJoinRhs"><span class="hs-identifier">simplJoinRhs</span></a></a><span> </span><a name="local-6989586621679788920"><a href="#local-6989586621679788920"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788921"><a href="#local-6989586621679788921"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679788922"><a href="#local-6989586621679788922"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621679788923"><a href="#local-6989586621679788923"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1146"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679788924"><a href="#local-6989586621679788924"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Id.html#isJoinId_maybe"><span class="hs-identifier hs-var">isJoinId_maybe</span></a><span> </span><a href="#local-6989586621679788921"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1147"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788925"><a href="#local-6989586621679788925"><span class="hs-identifier">join_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788926"><a href="#local-6989586621679788926"><span class="hs-identifier">join_body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a><span> </span><a href="#local-6989586621679788924"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621679788922"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1148"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788927"><a href="#local-6989586621679788927"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788928"><a href="#local-6989586621679788928"><span class="hs-identifier">join_bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplLamBndrs"><span class="hs-identifier hs-var">simplLamBndrs</span></a><span> </span><a href="#local-6989586621679788920"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788925"><span class="hs-identifier hs-var">join_bndrs</span></a><span>
</span><a name="line-1149"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679788929"><a href="#local-6989586621679788929"><span class="hs-identifier">join_body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a><span> </span><a href="#local-6989586621679788927"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679788926"><span class="hs-identifier hs-var">join_body</span></a><span> </span><a href="#local-6989586621679788923"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1150"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621679788928"><span class="hs-identifier hs-var">join_bndrs'</span></a><span> </span><a href="#local-6989586621679788929"><span class="hs-identifier hs-var">join_body'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1151"></a><span>
</span><a name="line-1152"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1153"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;simplJoinRhs&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679788921"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>
</span><a name="line-1155"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-1156"></a><span class="hs-identifier">simplType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InType"><span class="hs-identifier hs-type">InType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#OutType"><span class="hs-identifier hs-type">OutType</span></a><span>
</span><a name="line-1157"></a><span>        </span><span class="hs-comment">-- Kept monadic just so we can do the seqType</span><span>
</span><a name="line-1158"></a><span>        </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><a name="line-1159"></a><a name="simplType"><a href="Simplify.html#simplType"><span class="hs-identifier">simplType</span></a></a><span> </span><a name="local-6989586621679788930"><a href="#local-6989586621679788930"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788931"><a href="#local-6989586621679788931"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1160"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;simplType&quot; (ppr ty $$ ppr (seTvSubst env)) $</span><span>
</span><a name="line-1161"></a><span>    </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><a href="#local-6989586621679788932"><span class="hs-identifier hs-var">new_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679788932"><span class="hs-identifier hs-var">new_ty</span></a><span>
</span><a name="line-1162"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1163"></a><span>    </span><a name="local-6989586621679788932"><a href="#local-6989586621679788932"><span class="hs-identifier">new_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621679788930"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788931"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1164"></a><span>
</span><a name="line-1165"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-1166"></a><span class="hs-identifier">simplCoercionF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InCoercion"><span class="hs-identifier hs-type">InCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1167"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1168"></a><a name="simplCoercionF"><a href="Simplify.html#simplCoercionF"><span class="hs-identifier">simplCoercionF</span></a></a><span> </span><a name="local-6989586621679788933"><a href="#local-6989586621679788933"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788934"><a href="#local-6989586621679788934"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621679788935"><a href="#local-6989586621679788935"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1169"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679788936"><a href="#local-6989586621679788936"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplCoercion"><span class="hs-identifier hs-var">simplCoercion</span></a><span> </span><a href="#local-6989586621679788933"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788934"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1170"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679788933"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621679788936"><span class="hs-identifier hs-var">co'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788935"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1171"></a><span>
</span><a name="line-1172"></a><span class="hs-identifier">simplCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InCoercion"><span class="hs-identifier hs-type">InCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a><span>
</span><a name="line-1173"></a><a name="simplCoercion"><a href="Simplify.html#simplCoercion"><span class="hs-identifier">simplCoercion</span></a></a><span> </span><a name="local-6989586621679788937"><a href="#local-6989586621679788937"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788938"><a href="#local-6989586621679788938"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1174"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788939"><a href="#local-6989586621679788939"><span class="hs-identifier">opt_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621679788937"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788938"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1175"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621679788939"><span class="hs-identifier hs-var">opt_co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679788939"><span class="hs-identifier hs-var">opt_co</span></a><span>
</span><a name="line-1176"></a><span>
</span><a name="line-1177"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-1178"></a><span class="hs-comment">-- | Push a TickIt context outwards past applications and cases, as</span><span>
</span><a name="line-1179"></a><span class="hs-comment">-- long as this is a non-scoping tick, to let case and application</span><span>
</span><a name="line-1180"></a><span class="hs-comment">-- optimisations apply.</span><span>
</span><a name="line-1181"></a><span>
</span><a name="line-1182"></a><span class="hs-identifier">simplTick</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1183"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1184"></a><a name="simplTick"><a href="Simplify.html#simplTick"><span class="hs-identifier">simplTick</span></a></a><span> </span><a name="local-6989586621679788940"><a href="#local-6989586621679788940"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788941"><a href="#local-6989586621679788941"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621679788942"><a href="#local-6989586621679788942"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621679788943"><a href="#local-6989586621679788943"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1185"></a><span>  </span><span class="hs-comment">-- A scoped tick turns into a continuation, so that we can spot</span><span>
</span><a name="line-1186"></a><span>  </span><span class="hs-comment">-- (scc t (\x . e)) in simplLam and eliminate the scc.  If we didn't do</span><span>
</span><a name="line-1187"></a><span>  </span><span class="hs-comment">-- it this way, then it would take two passes of the simplifier to</span><span>
</span><a name="line-1188"></a><span>  </span><span class="hs-comment">-- reduce ((scc t (\x . e)) e').</span><span>
</span><a name="line-1189"></a><span>  </span><span class="hs-comment">-- NB, don't do this with counting ticks, because if the expr is</span><span>
</span><a name="line-1190"></a><span>  </span><span class="hs-comment">-- bottom, then rebuildCall will discard the continuation.</span><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span class="hs-comment">-- XXX: we cannot do this, because the simplifier assumes that</span><span>
</span><a name="line-1193"></a><span class="hs-comment">-- the context can be pushed into a case with a single branch. e.g.</span><span>
</span><a name="line-1194"></a><span class="hs-comment">--    scc&lt;f&gt;  case expensive of p -&gt; e</span><span>
</span><a name="line-1195"></a><span class="hs-comment">-- becomes</span><span>
</span><a name="line-1196"></a><span class="hs-comment">--    case expensive of p -&gt; scc&lt;f&gt; e</span><span>
</span><a name="line-1197"></a><span class="hs-comment">--</span><span>
</span><a name="line-1198"></a><span class="hs-comment">-- So I'm disabling this for now.  It just means we will do more</span><span>
</span><a name="line-1199"></a><span class="hs-comment">-- simplifier iterations that necessary in some cases.</span><span>
</span><a name="line-1200"></a><span>
</span><a name="line-1201"></a><span class="hs-comment">--  | tickishScoped tickish &amp;&amp; not (tickishCounts tickish)</span><span>
</span><a name="line-1202"></a><span class="hs-comment">--  = simplExprF env expr (TickIt tickish cont)</span><span>
</span><a name="line-1203"></a><span>
</span><a name="line-1204"></a><span>  </span><span class="hs-comment">-- For unscoped or soft-scoped ticks, we are allowed to float in new</span><span>
</span><a name="line-1205"></a><span>  </span><span class="hs-comment">-- cost, so we simply push the continuation inside the tick.  This</span><span>
</span><a name="line-1206"></a><span>  </span><span class="hs-comment">-- has the effect of moving the tick to the outside of a case or</span><span>
</span><a name="line-1207"></a><span>  </span><span class="hs-comment">-- application context, allowing the normal case and application</span><span>
</span><a name="line-1208"></a><span>  </span><span class="hs-comment">-- optimisations to fire.</span><span>
</span><a name="line-1209"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679788941"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>
</span><a name="line-1210"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788988"><a href="#local-6989586621679788988"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788989"><a href="#local-6989586621679788989"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679788940"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788942"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679788943"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1211"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788988"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-6989586621679788941"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621679788989"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1212"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1213"></a><span>
</span><a name="line-1214"></a><span>  </span><span class="hs-comment">-- Push tick inside if the context looks like this will allow us to</span><span>
</span><a name="line-1215"></a><span>  </span><span class="hs-comment">-- do a case-of-case - see Note [case-of-scc-of-case]</span><span>
</span><a name="line-1216"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788943"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679788990"><a href="#local-6989586621679788990"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788944"><span class="hs-identifier hs-var">push_tick_inside</span></a><span>
</span><a name="line-1217"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679788940"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788990"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621679788943"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1218"></a><span>
</span><a name="line-1219"></a><span>  </span><span class="hs-comment">-- We don't want to move the tick, but we might still want to allow</span><span>
</span><a name="line-1220"></a><span>  </span><span class="hs-comment">-- floats to pass through with appropriate wrapping (or not, see</span><span>
</span><a name="line-1221"></a><span>  </span><span class="hs-comment">-- wrap_floats below)</span><span>
</span><a name="line-1222"></a><span>  </span><span class="hs-comment">--- | not (tickishCounts tickish) || tickishCanSplit tickish</span><span>
</span><a name="line-1223"></a><span>  </span><span class="hs-comment">-- = wrap_floats</span><span>
</span><a name="line-1224"></a><span>
</span><a name="line-1225"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1226"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788945"><span class="hs-identifier hs-var">no_floating_past_tick</span></a><span>
</span><a name="line-1227"></a><span>
</span><a name="line-1228"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1229"></a><span>
</span><a name="line-1230"></a><span>  </span><span class="hs-comment">-- Try to push tick inside a case, see Note [case-of-scc-of-case].</span><span>
</span><a name="line-1231"></a><span>  </span><a name="local-6989586621679788944"><a href="#local-6989586621679788944"><span class="hs-identifier">push_tick_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1232"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679788950"><span class="hs-identifier hs-var">expr0</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1233"></a><span>      </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621679788960"><a href="#local-6989586621679788960"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679788961"><a href="#local-6989586621679788961"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679788962"><a href="#local-6989586621679788962"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679788963"><a href="#local-6989586621679788963"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-1234"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788952"><span class="hs-identifier hs-var">tickScrut</span></a><span> </span><a href="#local-6989586621679788960"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788961"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788962"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621679788953"><span class="hs-identifier hs-var">tickAlt</span></a><span> </span><a href="#local-6989586621679788963"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1235"></a><span>      </span><a name="local-6989586621679788964"><a href="#local-6989586621679788964"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1236"></a><span>   </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788949"><a href="#local-6989586621679788949"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788950"><a href="#local-6989586621679788950"><span class="hs-identifier">expr0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a><span> </span><a href="#local-6989586621679788951"><span class="hs-identifier hs-var">movable</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621679788941"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621679788942"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1237"></a><span>         </span><a name="local-6989586621679788951"><a href="#local-6989586621679788951"><span class="hs-identifier">movable</span></a></a><span> </span><a name="local-6989586621679788955"><a href="#local-6989586621679788955"><span class="hs-identifier">t</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-6989586621679788955"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1238"></a><span>                          </span><a href="#local-6989586621679788955"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1239"></a><span>                          </span><a href="CoreSyn.html#tickishCanSplit"><span class="hs-identifier hs-var">tickishCanSplit</span></a><span> </span><a href="#local-6989586621679788955"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1240"></a><span>         </span><a name="local-6989586621679788952"><a href="#local-6989586621679788952"><span class="hs-identifier">tickScrut</span></a></a><span> </span><a name="local-6989586621679788956"><a href="#local-6989586621679788956"><span class="hs-identifier">e</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-6989586621679788956"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679788949"><span class="hs-identifier hs-var">ticks</span></a><span>
</span><a name="line-1241"></a><span>         </span><span class="hs-comment">-- Alternatives get annotated with all ticks that scope in some way,</span><span>
</span><a name="line-1242"></a><span>         </span><span class="hs-comment">-- but we don't want to count entries.</span><span>
</span><a name="line-1243"></a><span>         </span><a name="local-6989586621679788953"><a href="#local-6989586621679788953"><span class="hs-identifier">tickAlt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679788957"><a href="#local-6989586621679788957"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><a name="local-6989586621679788958"><a href="#local-6989586621679788958"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><a name="local-6989586621679788959"><a href="#local-6989586621679788959"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788957"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><a href="#local-6989586621679788958"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-6989586621679788959"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679788954"><span class="hs-identifier hs-var">ts_scope</span></a><span class="hs-special">)</span><span>
</span><a name="line-1244"></a><span>         </span><a name="local-6989586621679788954"><a href="#local-6989586621679788954"><span class="hs-identifier">ts_scope</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="CoreSyn.html#mkNoCount"><span class="hs-identifier hs-var">mkNoCount</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1245"></a><span>                            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788949"><span class="hs-identifier hs-var">ticks</span></a><span>
</span><a name="line-1246"></a><span>
</span><a name="line-1247"></a><span>  </span><a name="local-6989586621679788945"><a href="#local-6989586621679788945"><span class="hs-identifier">no_floating_past_tick</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1248"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788965"><a href="#local-6989586621679788965"><span class="hs-identifier">inc</span></a></a><span class="hs-special">,</span><a name="local-6989586621679788966"><a href="#local-6989586621679788966"><span class="hs-identifier">outc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788947"><span class="hs-identifier hs-var">splitCont</span></a><span> </span><a href="#local-6989586621679788943"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1249"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788967"><a href="#local-6989586621679788967"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788968"><a href="#local-6989586621679788968"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapFloats"><span class="hs-identifier hs-var">zapFloats</span></a><span> </span><a href="#local-6989586621679788940"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788942"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679788965"><span class="hs-identifier hs-var">inc</span></a><span>
</span><a name="line-1250"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679788969"><a href="#local-6989586621679788969"><span class="hs-identifier">tickish'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788946"><span class="hs-identifier hs-var">simplTickish</span></a><span> </span><a href="#local-6989586621679788940"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788941"><span class="hs-identifier hs-var">tickish</span></a><span>
</span><a name="line-1251"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788970"><a href="#local-6989586621679788970"><span class="hs-identifier">env''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679788971"><a href="#local-6989586621679788971"><span class="hs-identifier">expr''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapFloats"><span class="hs-identifier hs-var">zapFloats</span></a><span> </span><a href="#local-6989586621679788967"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><span>                                    </span><span class="hs-special">(</span><a href="SimplEnv.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-6989586621679788967"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679788968"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1253"></a><span>                                    </span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><a href="#local-6989586621679788969"><span class="hs-identifier hs-var">tickish'</span></a><span> </span><a href="#local-6989586621679788966"><span class="hs-identifier hs-var">outc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1254"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#addFloats"><span class="hs-identifier hs-var">addFloats</span></a><span> </span><a href="#local-6989586621679788940"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679788970"><span class="hs-identifier hs-var">env''</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788971"><span class="hs-identifier hs-var">expr''</span></a><span class="hs-special">)</span><span>
</span><a name="line-1255"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1256"></a><span>
</span><a name="line-1257"></a><span class="hs-comment">-- Alternative version that wraps outgoing floats with the tick.  This</span><span>
</span><a name="line-1258"></a><span class="hs-comment">-- results in ticks being duplicated, as we don't make any attempt to</span><span>
</span><a name="line-1259"></a><span class="hs-comment">-- eliminate the tick if we re-inline the binding (because the tick</span><span>
</span><a name="line-1260"></a><span class="hs-comment">-- semantics allows unrestricted inlining of HNFs), so I'm not doing</span><span>
</span><a name="line-1261"></a><span class="hs-comment">-- this any more.  FloatOut will catch any real opportunities for</span><span>
</span><a name="line-1262"></a><span class="hs-comment">-- floating.</span><span>
</span><a name="line-1263"></a><span class="hs-comment">--</span><span>
</span><a name="line-1264"></a><span class="hs-comment">--  wrap_floats =</span><span>
</span><a name="line-1265"></a><span class="hs-comment">--    do { let (inc,outc) = splitCont cont</span><span>
</span><a name="line-1266"></a><span class="hs-comment">--       ; (env', expr') &lt;- simplExprF (zapFloats env) expr inc</span><span>
</span><a name="line-1267"></a><span class="hs-comment">--       ; let tickish' = simplTickish env tickish</span><span>
</span><a name="line-1268"></a><span class="hs-comment">--       ; let wrap_float (b,rhs) = (zapIdStrictness (setIdArity b 0),</span><span>
</span><a name="line-1269"></a><span class="hs-comment">--                                   mkTick (mkNoCount tickish') rhs)</span><span>
</span><a name="line-1270"></a><span class="hs-comment">--              -- when wrapping a float with mkTick, we better zap the Id's</span><span>
</span><a name="line-1271"></a><span class="hs-comment">--              -- strictness info and arity, because it might be wrong now.</span><span>
</span><a name="line-1272"></a><span class="hs-comment">--       ; let env'' = addFloats env (mapFloats env' wrap_float)</span><span>
</span><a name="line-1273"></a><span class="hs-comment">--       ; rebuild env'' expr' (TickIt tickish' outc)</span><span>
</span><a name="line-1274"></a><span class="hs-comment">--       }</span><span>
</span><a name="line-1275"></a><span>
</span><a name="line-1276"></a><span>
</span><a name="line-1277"></a><span>  </span><a name="local-6989586621679788946"><a href="#local-6989586621679788946"><span class="hs-identifier">simplTickish</span></a></a><span> </span><a name="local-6989586621679788972"><a href="#local-6989586621679788972"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788973"><a href="#local-6989586621679788973"><span class="hs-identifier">tickish</span></a></a><span>
</span><a name="line-1278"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a name="local-6989586621679788974"><a href="#local-6989586621679788974"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679788975"><a href="#local-6989586621679788975"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679788973"><span class="hs-identifier hs-var">tickish</span></a><span>
</span><a name="line-1279"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a href="#local-6989586621679788974"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788948"><span class="hs-identifier hs-var">getDoneId</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SimplEnv.html#substId"><span class="hs-identifier hs-var">substId</span></a><span> </span><a href="#local-6989586621679788972"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788975"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-1280"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788973"><span class="hs-identifier hs-var">tickish</span></a><span>
</span><a name="line-1281"></a><span>
</span><a name="line-1282"></a><span>  </span><span class="hs-comment">-- Push type application and coercion inside a tick</span><span>
</span><a name="line-1283"></a><span>  </span><span class="hs-identifier">splitCont</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">)</span><span>
</span><a name="line-1284"></a><span>  </span><a name="local-6989586621679788947"><a href="#local-6989586621679788947"><span class="hs-identifier">splitCont</span></a></a><span> </span><a name="local-6989586621679788976"><a href="#local-6989586621679788976"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679788977"><a href="#local-6989586621679788977"><span class="hs-identifier">tail</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788976"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788978"><span class="hs-identifier hs-var">inc</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788979"><span class="hs-identifier hs-var">outc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1285"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788978"><a href="#local-6989586621679788978"><span class="hs-identifier">inc</span></a></a><span class="hs-special">,</span><a name="local-6989586621679788979"><a href="#local-6989586621679788979"><span class="hs-identifier">outc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788947"><span class="hs-identifier hs-var">splitCont</span></a><span> </span><a href="#local-6989586621679788977"><span class="hs-identifier hs-var">tail</span></a><span>
</span><a name="line-1286"></a><span>  </span><span class="hs-identifier">splitCont</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a name="local-6989586621679788980"><a href="#local-6989586621679788980"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621679788981"><a href="#local-6989586621679788981"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a href="#local-6989586621679788980"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621679788982"><span class="hs-identifier hs-var">inc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788983"><span class="hs-identifier hs-var">outc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1287"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679788982"><a href="#local-6989586621679788982"><span class="hs-identifier">inc</span></a></a><span class="hs-special">,</span><a name="local-6989586621679788983"><a href="#local-6989586621679788983"><span class="hs-identifier">outc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788947"><span class="hs-identifier hs-var">splitCont</span></a><span> </span><a href="#local-6989586621679788981"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-1288"></a><span>  </span><span class="hs-identifier">splitCont</span><span> </span><a name="local-6989586621679788984"><a href="#local-6989586621679788984"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679788984"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788984"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-1289"></a><span>
</span><a name="line-1290"></a><span>  </span><a name="local-6989586621679788948"><a href="#local-6989586621679788948"><span class="hs-identifier">getDoneId</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><a name="local-6989586621679788985"><a href="#local-6989586621679788985"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679788985"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1291"></a><span>  </span><span class="hs-identifier">getDoneId</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a><span> </span><a name="local-6989586621679788986"><a href="#local-6989586621679788986"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#getIdFromTrivialExpr"><span class="hs-identifier hs-var">getIdFromTrivialExpr</span></a><span> </span><a href="#local-6989586621679788986"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-comment">-- Note [substTickish] in CoreSubst</span><span>
</span><a name="line-1292"></a><span>  </span><span class="hs-identifier">getDoneId</span><span> </span><a name="local-6989586621679788987"><a href="#local-6989586621679788987"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;getDoneId&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679788987"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span class="hs-comment">-- Note [case-of-scc-of-case]</span><span>
</span><a name="line-1295"></a><span class="hs-comment">-- It's pretty important to be able to transform case-of-case when</span><span>
</span><a name="line-1296"></a><span class="hs-comment">-- there's an SCC in the way.  For example, the following comes up</span><span>
</span><a name="line-1297"></a><span class="hs-comment">-- in nofib/real/compress/Encode.hs:</span><span>
</span><a name="line-1298"></a><span class="hs-comment">--</span><span>
</span><a name="line-1299"></a><span class="hs-comment">--        case scctick&lt;code_string.r1&gt;</span><span>
</span><a name="line-1300"></a><span class="hs-comment">--             case $wcode_string_r13s wild_XC w1_s137 w2_s138 l_aje</span><span>
</span><a name="line-1301"></a><span class="hs-comment">--             of _ { (# ww1_s13f, ww2_s13g, ww3_s13h #) -&gt;</span><span>
</span><a name="line-1302"></a><span class="hs-comment">--             (ww1_s13f, ww2_s13g, ww3_s13h)</span><span>
</span><a name="line-1303"></a><span class="hs-comment">--             }</span><span>
</span><a name="line-1304"></a><span class="hs-comment">--        of _ { (ww_s12Y, ww1_s12Z, ww2_s130) -&gt;</span><span>
</span><a name="line-1305"></a><span class="hs-comment">--        tick&lt;code_string.f1&gt;</span><span>
</span><a name="line-1306"></a><span class="hs-comment">--        (ww_s12Y,</span><span>
</span><a name="line-1307"></a><span class="hs-comment">--         ww1_s12Z,</span><span>
</span><a name="line-1308"></a><span class="hs-comment">--         PTTrees.PT</span><span>
</span><a name="line-1309"></a><span class="hs-comment">--           @ GHC.Types.Char @ GHC.Types.Int wild2_Xj ww2_s130 r_ajf)</span><span>
</span><a name="line-1310"></a><span class="hs-comment">--        }</span><span>
</span><a name="line-1311"></a><span class="hs-comment">--</span><span>
</span><a name="line-1312"></a><span class="hs-comment">-- We really want this case-of-case to fire, because then the 3-tuple</span><span>
</span><a name="line-1313"></a><span class="hs-comment">-- will go away (indeed, the CPR optimisation is relying on this</span><span>
</span><a name="line-1314"></a><span class="hs-comment">-- happening).  But the scctick is in the way - we need to push it</span><span>
</span><a name="line-1315"></a><span class="hs-comment">-- inside to expose the case-of-case.  So we perform this</span><span>
</span><a name="line-1316"></a><span class="hs-comment">-- transformation on the inner case:</span><span>
</span><a name="line-1317"></a><span class="hs-comment">--</span><span>
</span><a name="line-1318"></a><span class="hs-comment">--   scctick c (case e of { p1 -&gt; e1; ...; pn -&gt; en })</span><span>
</span><a name="line-1319"></a><span class="hs-comment">--    ==&gt;</span><span>
</span><a name="line-1320"></a><span class="hs-comment">--   case (scctick c e) of { p1 -&gt; scc c e1; ...; pn -&gt; scc c en }</span><span>
</span><a name="line-1321"></a><span class="hs-comment">--</span><span>
</span><a name="line-1322"></a><span class="hs-comment">-- So we've moved a constant amount of work out of the scc to expose</span><span>
</span><a name="line-1323"></a><span class="hs-comment">-- the case.  We only do this when the continuation is interesting: in</span><span>
</span><a name="line-1324"></a><span class="hs-comment">-- for now, it has to be another Case (maybe generalise this later).</span><span>
</span><a name="line-1325"></a><span>
</span><a name="line-1326"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The main rebuilder}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1333"></a><span>
</span><a name="line-1334"></a><span class="hs-identifier">rebuild</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1335"></a><span class="hs-comment">-- At this point the substitution in the SimplEnv should be irrelevant</span><span>
</span><a name="line-1336"></a><span class="hs-comment">-- only the in-scope set and floats should matter</span><span>
</span><a name="line-1337"></a><a name="rebuild"><a href="Simplify.html#rebuild"><span class="hs-identifier">rebuild</span></a></a><span> </span><a name="local-6989586621679788991"><a href="#local-6989586621679788991"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679788992"><a href="#local-6989586621679788992"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621679788993"><a href="#local-6989586621679788993"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1338"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679788993"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1339"></a><span>      </span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>      </span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><a name="local-6989586621679788994"><a href="#local-6989586621679788994"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679788995"><a href="#local-6989586621679788995"><span class="hs-identifier">cont</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-6989586621679788994"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788995"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1341"></a><span>      </span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a name="local-6989586621679788996"><a href="#local-6989586621679788996"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621679788997"><a href="#local-6989586621679788997"><span class="hs-identifier">cont</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679788996"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788997"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1342"></a><span>                       </span><span class="hs-comment">-- NB: mkCast implements the (Coercion co |&gt; g) optimisation</span><span>
</span><a name="line-1343"></a><span>
</span><a name="line-1344"></a><span>      </span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679788998"><a href="#local-6989586621679788998"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679788999"><a href="#local-6989586621679788999"><span class="hs-identifier">alts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789000"><a href="#local-6989586621679789000"><span class="hs-identifier">se</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789001"><a href="#local-6989586621679789001"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1345"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#rebuildCase"><span class="hs-identifier hs-var">rebuildCase</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789000"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setFloats"><span class="hs-identifier hs-var">setFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679788998"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679788999"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="#local-6989586621679789001"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1346"></a><span>
</span><a name="line-1347"></a><span>      </span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><a name="local-6989586621679789002"><a href="#local-6989586621679789002"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789003"><a href="#local-6989586621679789003"><span class="hs-identifier">cont</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789002"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">`</span><a href="SimplUtils.html#addValArgTo"><span class="hs-identifier hs-var">addValArgTo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789003"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1348"></a><span>      </span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><a name="local-6989586621679789004"><a href="#local-6989586621679789004"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679789005"><a href="#local-6989586621679789005"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679789006"><a href="#local-6989586621679789006"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679789007"><a href="#local-6989586621679789007"><span class="hs-identifier">se</span></a></a><span> </span><a name="local-6989586621679789008"><a href="#local-6989586621679789008"><span class="hs-identifier">cont</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789009"><a href="#local-6989586621679789009"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplNonRecX"><span class="hs-identifier hs-var">simplNonRecX</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789007"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setFloats"><span class="hs-identifier hs-var">setFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789004"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1349"></a><span>                                               </span><span class="hs-comment">-- expr satisfies let/app since it started life</span><span>
</span><a name="line-1350"></a><span>                                               </span><span class="hs-comment">-- in a call to simplNonRecE</span><span>
</span><a name="line-1351"></a><span>                                          </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a><span> </span><a href="#local-6989586621679789009"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789005"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679789006"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789008"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1352"></a><span>
</span><a name="line-1353"></a><span>      </span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789010"><a href="#local-6989586621679789010"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789011"><a href="#local-6989586621679789011"><span class="hs-identifier">cont</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1354"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621679789010"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789011"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1355"></a><span>
</span><a name="line-1356"></a><span>      </span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789012"><a href="#local-6989586621679789012"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789013"><a href="#local-6989586621679789013"><span class="hs-identifier">se</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789014"><a href="#local-6989586621679789014"><span class="hs-identifier">dup_flag</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789015"><a href="#local-6989586621679789015"><span class="hs-identifier">cont</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1357"></a><span>        </span><span class="hs-comment">-- See Note [Avoid redundant simplification]</span><span>
</span><a name="line-1358"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a><span> </span><a href="#local-6989586621679789014"><span class="hs-identifier hs-var">dup_flag</span></a><span>
</span><a name="line-1359"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679789012"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789015"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1360"></a><span>
</span><a name="line-1361"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1362"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789016"><a href="#local-6989586621679789016"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789013"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setInScopeAndZapFloats"><span class="hs-identifier hs-var">setInScopeAndZapFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789012"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1363"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679788991"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621679788992"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679789016"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789015"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1364"></a><span>
</span><a name="line-1365"></a><span>
</span><a name="line-1366"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Lambdas}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1373"></a><span>
</span><a name="line-1374"></a><span class="hs-identifier">simplCast</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1375"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><a name="simplCast"><a href="Simplify.html#simplCast"><span class="hs-identifier">simplCast</span></a></a><span> </span><a name="local-6989586621679789017"><a href="#local-6989586621679789017"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789018"><a href="#local-6989586621679789018"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679789019"><a href="#local-6989586621679789019"><span class="hs-identifier">co0</span></a></a><span> </span><a name="local-6989586621679789020"><a href="#local-6989586621679789020"><span class="hs-identifier">cont0</span></a></a><span>
</span><a name="line-1377"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789046"><a href="#local-6989586621679789046"><span class="hs-identifier">co1</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplCoercion"><span class="hs-identifier hs-var">simplCoercion</span></a><span> </span><a href="#local-6989586621679789017"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789019"><span class="hs-identifier hs-var">co0</span></a><span>
</span><a name="line-1378"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789047"><a href="#local-6989586621679789047"><span class="hs-identifier">cont1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679789021"><span class="hs-identifier hs-var">addCoerce</span></a><span> </span><a href="#local-6989586621679789046"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621679789020"><span class="hs-identifier hs-var">cont0</span></a><span>
</span><a name="line-1379"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789017"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789018"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789047"><span class="hs-identifier hs-var">cont1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1380"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1381"></a><span>       </span><span class="hs-identifier">addCoerce</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1382"></a><span>       </span><a name="local-6989586621679789021"><a href="#local-6989586621679789021"><span class="hs-identifier">addCoerce</span></a></a><span> </span><a name="local-6989586621679789022"><a href="#local-6989586621679789022"><span class="hs-identifier">co1</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a name="local-6989586621679789023"><a href="#local-6989586621679789023"><span class="hs-identifier">co2</span></a></a><span> </span><a name="local-6989586621679789024"><a href="#local-6989586621679789024"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1383"></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789021"><span class="hs-identifier hs-var">addCoerce</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span> </span><a href="#local-6989586621679789022"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621679789023"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789024"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1384"></a><span>
</span><a name="line-1385"></a><span>       </span><span class="hs-identifier">addCoerce</span><span> </span><a name="local-6989586621679789025"><a href="#local-6989586621679789025"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621679789026"><a href="#local-6989586621679789026"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789027"><a href="#local-6989586621679789027"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789028"><a href="#local-6989586621679789028"><span class="hs-identifier">tail</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1386"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789029"><a href="#local-6989586621679789029"><span class="hs-identifier">arg_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789030"><a href="#local-6989586621679789030"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#pushCoTyArg"><span class="hs-identifier hs-var">pushCoTyArg</span></a><span> </span><a href="#local-6989586621679789025"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621679789027"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-1387"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789031"><a href="#local-6989586621679789031"><span class="hs-identifier">tail'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679789021"><span class="hs-identifier hs-var">addCoerce</span></a><span> </span><a href="#local-6989586621679789030"><span class="hs-identifier hs-var">co'</span></a><span> </span><a href="#local-6989586621679789028"><span class="hs-identifier hs-var">tail</span></a><span>
</span><a name="line-1388"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789026"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789029"><span class="hs-identifier hs-var">arg_ty'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789031"><span class="hs-identifier hs-var">tail'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1389"></a><span>
</span><a name="line-1390"></a><span>       </span><span class="hs-identifier">addCoerce</span><span> </span><a name="local-6989586621679789032"><a href="#local-6989586621679789032"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789033"><a href="#local-6989586621679789033"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789034"><a href="#local-6989586621679789034"><span class="hs-identifier">arg_se</span></a></a><span>
</span><a name="line-1391"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789035"><a href="#local-6989586621679789035"><span class="hs-identifier">dup</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789036"><a href="#local-6989586621679789036"><span class="hs-identifier">tail</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1392"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789037"><a href="#local-6989586621679789037"><span class="hs-identifier">co1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789038"><a href="#local-6989586621679789038"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#pushCoValArg"><span class="hs-identifier hs-var">pushCoValArg</span></a><span> </span><a href="#local-6989586621679789032"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1393"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789039"><a href="#local-6989586621679789039"><span class="hs-identifier">new_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621679789037"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1394"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Type.html#isTypeLevPoly"><span class="hs-identifier hs-var">isTypeLevPoly</span></a><span> </span><a href="#local-6989586621679789039"><span class="hs-identifier hs-var">new_ty</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- without this check, we get a lev-poly arg</span><span>
</span><a name="line-1395"></a><span>                                       </span><span class="hs-comment">-- See Note [Levity polymorphism invariants] in CoreSyn</span><span>
</span><a name="line-1396"></a><span>                                       </span><span class="hs-comment">-- test: typecheck/should_run/EtaExpandLevPoly</span><span>
</span><a name="line-1397"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789040"><a href="#local-6989586621679789040"><span class="hs-identifier">dup'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789041"><a href="#local-6989586621679789041"><span class="hs-identifier">arg_se'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789042"><a href="#local-6989586621679789042"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplArg"><span class="hs-identifier hs-var">simplArg</span></a><span> </span><a href="#local-6989586621679789017"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789035"><span class="hs-identifier hs-var">dup</span></a><span> </span><a href="#local-6989586621679789034"><span class="hs-identifier hs-var">arg_se</span></a><span> </span><a href="#local-6989586621679789033"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1398"></a><span>                   </span><span class="hs-comment">-- When we build the ApplyTo we can't mix the OutCoercion</span><span>
</span><a name="line-1399"></a><span>                   </span><span class="hs-comment">-- 'co' with the InExpr 'arg', so we simplify</span><span>
</span><a name="line-1400"></a><span>                   </span><span class="hs-comment">-- to make it all consistent.  It's a bit messy.</span><span>
</span><a name="line-1401"></a><span>                   </span><span class="hs-comment">-- But it isn't a common case.</span><span>
</span><a name="line-1402"></a><span>                   </span><span class="hs-comment">-- Example of use: Trac #995</span><span>
</span><a name="line-1403"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789043"><a href="#local-6989586621679789043"><span class="hs-identifier">tail'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679789021"><span class="hs-identifier hs-var">addCoerce</span></a><span> </span><a href="#local-6989586621679789038"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="#local-6989586621679789036"><span class="hs-identifier hs-var">tail</span></a><span>
</span><a name="line-1404"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><a href="#local-6989586621679789042"><span class="hs-identifier hs-var">arg'</span></a><span> </span><a href="#local-6989586621679789037"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1405"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789041"><span class="hs-identifier hs-var">arg_se'</span></a><span>
</span><a name="line-1406"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789040"><span class="hs-identifier hs-var">dup'</span></a><span>
</span><a name="line-1407"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789043"><span class="hs-identifier hs-var">tail'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1408"></a><span>
</span><a name="line-1409"></a><span>       </span><span class="hs-identifier">addCoerce</span><span> </span><a name="local-6989586621679789044"><a href="#local-6989586621679789044"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621679789045"><a href="#local-6989586621679789045"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1410"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflexiveCo"><span class="hs-identifier hs-var">isReflexiveCo</span></a><span> </span><a href="#local-6989586621679789044"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789045"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1411"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a href="#local-6989586621679789044"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621679789045"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-1412"></a><span>                </span><span class="hs-comment">-- It's worth checking isReflexiveCo.</span><span>
</span><a name="line-1413"></a><span>                </span><span class="hs-comment">-- For example, in the initial form of a worker</span><span>
</span><a name="line-1414"></a><span>                </span><span class="hs-comment">-- we may find  (coerce T (coerce S (\x.e))) y</span><span>
</span><a name="line-1415"></a><span>                </span><span class="hs-comment">-- and we'd like it to simplify to e[y/x] in one round</span><span>
</span><a name="line-1416"></a><span>                </span><span class="hs-comment">-- of simplification</span><span>
</span><a name="line-1417"></a><span>
</span><a name="line-1418"></a><span class="hs-identifier">simplArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1419"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1420"></a><a name="simplArg"><a href="Simplify.html#simplArg"><span class="hs-identifier">simplArg</span></a></a><span> </span><a name="local-6989586621679789048"><a href="#local-6989586621679789048"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789049"><a href="#local-6989586621679789049"><span class="hs-identifier">dup_flag</span></a></a><span> </span><a name="local-6989586621679789050"><a href="#local-6989586621679789050"><span class="hs-identifier">arg_env</span></a></a><span> </span><a name="local-6989586621679789051"><a href="#local-6989586621679789051"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-1421"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a><span> </span><a href="#local-6989586621679789049"><span class="hs-identifier hs-var">dup_flag</span></a><span>
</span><a name="line-1422"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789049"><span class="hs-identifier hs-var">dup_flag</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789050"><span class="hs-identifier hs-var">arg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789051"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1423"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1424"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789052"><a href="#local-6989586621679789052"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789050"><span class="hs-identifier hs-var">arg_env</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setInScopeAndZapFloats"><span class="hs-identifier hs-var">setInScopeAndZapFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789048"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789051"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1425"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Simplified"><span class="hs-identifier hs-var">Simplified</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span> </span><a href="#local-6989586621679789050"><span class="hs-identifier hs-var">arg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789052"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1426"></a><span>
</span><a name="line-1427"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Lambdas}
*                                                                      *
************************************************************************

Note [Zap unfolding when beta-reducing]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Lambda-bound variables can have stable unfoldings, such as
   $j = \x. \b{Unf=Just x}. e
See Note [Case binders and join points] below; the unfolding for lets
us optimise e better.  However when we beta-reduce it we want to
revert to using the actual value, otherwise we can end up in the
stupid situation of
          let x = blah in
          let b{Unf=Just x} = y
          in ...b...
Here it'd be far better to drop the unfolding and use the actual RHS.
-}</span><span>
</span><a name="line-1447"></a><span>
</span><a name="line-1448"></a><span class="hs-identifier">simplLam</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1449"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1450"></a><span>
</span><a name="line-1451"></a><a name="simplLam"><a href="Simplify.html#simplLam"><span class="hs-identifier">simplLam</span></a></a><span> </span><a name="local-6989586621679789053"><a href="#local-6989586621679789053"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621679789054"><a href="#local-6989586621679789054"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679789055"><a href="#local-6989586621679789055"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789053"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789054"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789055"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1452"></a><span>
</span><a name="line-1453"></a><span>        </span><span class="hs-comment">-- Beta reduction</span><span>
</span><a name="line-1454"></a><span>
</span><a name="line-1455"></a><span class="hs-identifier">simplLam</span><span> </span><a name="local-6989586621679789056"><a href="#local-6989586621679789056"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789057"><a href="#local-6989586621679789057"><span class="hs-identifier">bndr</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789058"><a href="#local-6989586621679789058"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679789059"><a href="#local-6989586621679789059"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789060"><a href="#local-6989586621679789060"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789061"><a href="#local-6989586621679789061"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1456"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#BetaReduction"><span class="hs-identifier hs-var">BetaReduction</span></a><span> </span><a href="#local-6989586621679789057"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1457"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621679789056"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789057"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679789060"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789058"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621679789059"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789061"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1458"></a><span>
</span><a name="line-1459"></a><span class="hs-identifier">simplLam</span><span> </span><a name="local-6989586621679789062"><a href="#local-6989586621679789062"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789063"><a href="#local-6989586621679789063"><span class="hs-identifier">bndr</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789064"><a href="#local-6989586621679789064"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679789065"><a href="#local-6989586621679789065"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789066"><a href="#local-6989586621679789066"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789067"><a href="#local-6989586621679789067"><span class="hs-identifier">arg_se</span></a></a><span>
</span><a name="line-1460"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789068"><a href="#local-6989586621679789068"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1461"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#BetaReduction"><span class="hs-identifier hs-var">BetaReduction</span></a><span> </span><a href="#local-6989586621679789063"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1462"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplNonRecE"><span class="hs-identifier hs-var">simplNonRecE</span></a><span> </span><a href="#local-6989586621679789062"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789069"><span class="hs-identifier hs-var">zap_unfolding</span></a><span> </span><a href="#local-6989586621679789063"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789066"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789067"><span class="hs-identifier hs-var">arg_se</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789064"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789065"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789068"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1463"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1464"></a><span>    </span><a name="local-6989586621679789069"><a href="#local-6989586621679789069"><span class="hs-identifier">zap_unfolding</span></a></a><span> </span><a name="local-6989586621679789070"><a href="#local-6989586621679789070"><span class="hs-identifier">bndr</span></a></a><span>  </span><span class="hs-comment">-- See Note [Zap unfolding when beta-reducing]</span><span>
</span><a name="line-1465"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621679789070"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a><span> </span><a href="#local-6989586621679789070"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1466"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdUnfolding"><span class="hs-identifier hs-var">setIdUnfolding</span></a><span> </span><a href="#local-6989586621679789070"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span>
</span><a name="line-1467"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789070"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1468"></a><span>
</span><a name="line-1469"></a><span>      </span><span class="hs-comment">-- discard a non-counting tick on a lambda.  This may change the</span><span>
</span><a name="line-1470"></a><span>      </span><span class="hs-comment">-- cost attribution slightly (moving the allocation of the</span><span>
</span><a name="line-1471"></a><span>      </span><span class="hs-comment">-- lambda elsewhere), but we don't care: optimisation changes</span><span>
</span><a name="line-1472"></a><span>      </span><span class="hs-comment">-- cost attribution all the time.</span><span>
</span><a name="line-1473"></a><span class="hs-identifier">simplLam</span><span> </span><a name="local-6989586621679789071"><a href="#local-6989586621679789071"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789072"><a href="#local-6989586621679789072"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621679789073"><a href="#local-6989586621679789073"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><a name="local-6989586621679789074"><a href="#local-6989586621679789074"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621679789075"><a href="#local-6989586621679789075"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1474"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-6989586621679789074"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span>
</span><a name="line-1475"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a><span> </span><a href="#local-6989586621679789071"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789072"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621679789073"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789075"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1476"></a><span>
</span><a name="line-1477"></a><span>        </span><span class="hs-comment">-- Not enough args, so there are real lambdas left to put in the result</span><span>
</span><a name="line-1478"></a><span class="hs-identifier">simplLam</span><span> </span><a name="local-6989586621679789076"><a href="#local-6989586621679789076"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789077"><a href="#local-6989586621679789077"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621679789078"><a href="#local-6989586621679789078"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679789079"><a href="#local-6989586621679789079"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1479"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789080"><a href="#local-6989586621679789080"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789081"><a href="#local-6989586621679789081"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplLamBndrs"><span class="hs-identifier hs-var">simplLamBndrs</span></a><span> </span><a href="#local-6989586621679789076"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789077"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1480"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789082"><a href="#local-6989586621679789082"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><a href="#local-6989586621679789080"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789078"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1481"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789083"><a href="#local-6989586621679789083"><span class="hs-identifier">new_lam</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplUtils.html#mkLam"><span class="hs-identifier hs-var">mkLam</span></a><span> </span><a href="#local-6989586621679789076"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789081"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621679789082"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621679789079"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1482"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679789080"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789083"><span class="hs-identifier hs-var">new_lam</span></a><span> </span><a href="#local-6989586621679789079"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1483"></a><span>
</span><a name="line-1484"></a><span class="hs-identifier">simplLamBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1485"></a><a name="simplLamBndrs"><a href="Simplify.html#simplLamBndrs"><span class="hs-identifier">simplLamBndrs</span></a></a><span> </span><a name="local-6989586621679789084"><a href="#local-6989586621679789084"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789085"><a href="#local-6989586621679789085"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MonadUtils.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a><span> </span><a href="Simplify.html#simplLamBndr"><span class="hs-identifier hs-var">simplLamBndr</span></a><span> </span><a href="#local-6989586621679789084"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789085"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1486"></a><span>
</span><a name="line-1487"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-1488"></a><span class="hs-identifier">simplLamBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1489"></a><span class="hs-comment">-- Used for lambda binders.  These sometimes have unfoldings added by</span><span>
</span><a name="line-1490"></a><span class="hs-comment">-- the worker/wrapper pass that must be preserved, because they can't</span><span>
</span><a name="line-1491"></a><span class="hs-comment">-- be reconstructed from context.  For example:</span><span>
</span><a name="line-1492"></a><span class="hs-comment">--      f x = case x of (a,b) -&gt; fw a b x</span><span>
</span><a name="line-1493"></a><span class="hs-comment">--      fw a b x{=(a,b)} = ...</span><span>
</span><a name="line-1494"></a><span class="hs-comment">-- The &quot;{=(a,b)}&quot; is an unfolding we can't reconstruct otherwise.</span><span>
</span><a name="line-1495"></a><a name="simplLamBndr"><a href="Simplify.html#simplLamBndr"><span class="hs-identifier">simplLamBndr</span></a></a><span> </span><a name="local-6989586621679789086"><a href="#local-6989586621679789086"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789087"><a href="#local-6989586621679789087"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-1496"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621679789087"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreSyn.html#isFragileUnfolding"><span class="hs-identifier hs-var">isFragileUnfolding</span></a><span> </span><a href="#local-6989586621679789088"><span class="hs-identifier hs-var">old_unf</span></a><span>   </span><span class="hs-comment">-- Special case</span><span>
</span><a name="line-1497"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789089"><a href="#local-6989586621679789089"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789090"><a href="#local-6989586621679789090"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a><span> </span><a href="#local-6989586621679789086"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789087"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1498"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789091"><a href="#local-6989586621679789091"><span class="hs-identifier">unf'</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplUnfolding"><span class="hs-identifier hs-var">simplUnfolding</span></a><span> </span><a href="#local-6989586621679789089"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621679789087"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679789088"><span class="hs-identifier hs-var">old_unf</span></a><span>
</span><a name="line-1499"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789092"><a href="#local-6989586621679789092"><span class="hs-identifier">bndr2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789090"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdUnfolding"><span class="hs-identifier hs-var">setIdUnfolding</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789091"><span class="hs-identifier hs-var">unf'</span></a><span>
</span><a name="line-1500"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a><span> </span><a href="#local-6989586621679789089"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679789092"><span class="hs-identifier hs-var">bndr2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789092"><span class="hs-identifier hs-var">bndr2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1501"></a><span>
</span><a name="line-1502"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1503"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a><span> </span><a href="#local-6989586621679789086"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789087"><span class="hs-identifier hs-var">bndr</span></a><span>                </span><span class="hs-comment">-- Normal case</span><span>
</span><a name="line-1504"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1505"></a><span>    </span><a name="local-6989586621679789088"><a href="#local-6989586621679789088"><span class="hs-identifier">old_unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-6989586621679789087"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1506"></a><span>
</span><a name="line-1507"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-1508"></a><span class="hs-identifier">simplNonRecE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-1509"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span>                    </span><span class="hs-comment">-- The binder, always an Id for simplNonRecE</span><span>
</span><a name="line-1510"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Rhs of binding (or arg of lambda)</span><span>
</span><a name="line-1511"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Body of the let/lambda</span><span>
</span><a name="line-1512"></a><span>                                        </span><span class="hs-comment">--      \xs.e</span><span>
</span><a name="line-1513"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1514"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>
</span><a name="line-1516"></a><span class="hs-comment">-- simplNonRecE is used for</span><span>
</span><a name="line-1517"></a><span class="hs-comment">--  * non-top-level non-recursive lets in expressions</span><span>
</span><a name="line-1518"></a><span class="hs-comment">--  * beta reduction</span><span>
</span><a name="line-1519"></a><span class="hs-comment">--</span><span>
</span><a name="line-1520"></a><span class="hs-comment">-- It deals with strict bindings, via the StrictBind continuation,</span><span>
</span><a name="line-1521"></a><span class="hs-comment">-- which may abort the whole process</span><span>
</span><a name="line-1522"></a><span class="hs-comment">--</span><span>
</span><a name="line-1523"></a><span class="hs-comment">-- Precondition: rhs satisfies the let/app invariant</span><span>
</span><a name="line-1524"></a><span class="hs-comment">--               Note [CoreSyn let/app invariant] in CoreSyn</span><span>
</span><a name="line-1525"></a><span class="hs-comment">--</span><span>
</span><a name="line-1526"></a><span class="hs-comment">-- The &quot;body&quot; of the binding comes as a pair of ([InId],InExpr)</span><span>
</span><a name="line-1527"></a><span class="hs-comment">-- representing a lambda; so we recurse back to simplLam</span><span>
</span><a name="line-1528"></a><span class="hs-comment">-- Why?  Because of the binder-occ-info-zapping done before</span><span>
</span><a name="line-1529"></a><span class="hs-comment">--       the call to simplLam in simplExprF (Lam ...)</span><span>
</span><a name="line-1530"></a><span>
</span><a name="line-1531"></a><a name="simplNonRecE"><a href="Simplify.html#simplNonRecE"><span class="hs-identifier">simplNonRecE</span></a></a><span> </span><a name="local-6989586621679789093"><a href="#local-6989586621679789093"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789094"><a href="#local-6989586621679789094"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789095"><a href="#local-6989586621679789095"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789096"><a href="#local-6989586621679789096"><span class="hs-identifier">rhs_se</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789097"><a href="#local-6989586621679789097"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789098"><a href="#local-6989586621679789098"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679789099"><a href="#local-6989586621679789099"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1532"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1533"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679789100"><a href="#local-6989586621679789100"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1534"></a><span>       </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1535"></a><span>         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#preInlineUnconditionally"><span class="hs-identifier hs-var">preInlineUnconditionally</span></a><span> </span><a href="#local-6989586621679789100"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679789093"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679789095"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1536"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#PreInlineUnconditionally"><span class="hs-identifier hs-var">PreInlineUnconditionally</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1537"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- pprTrace &quot;preInlineUncond&quot; (ppr bndr &lt;+&gt; ppr rhs) $</span><span>
</span><a name="line-1538"></a><span>                  </span><a href="Simplify.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><a href="#local-6989586621679789093"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#mkContEx"><span class="hs-identifier hs-var">mkContEx</span></a><span> </span><a href="#local-6989586621679789096"><span class="hs-identifier hs-var">rhs_se</span></a><span> </span><a href="#local-6989586621679789095"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789097"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621679789098"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789099"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1539"></a><span>
</span><a name="line-1540"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isStrictId"><span class="hs-identifier hs-var">isStrictId</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span>          </span><span class="hs-comment">-- Includes coercions</span><span>
</span><a name="line-1541"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789096"><span class="hs-identifier hs-var">rhs_se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setFloats"><span class="hs-identifier hs-var">setFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789093"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789095"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1542"></a><span>                         </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679789097"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621679789098"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789093"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789099"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-1543"></a><span>
</span><a name="line-1544"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789101"><a href="#local-6989586621679789101"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789102"><a href="#local-6989586621679789102"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#joinPointBinding_maybe"><span class="hs-identifier hs-var">joinPointBinding_maybe</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679789095"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1545"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789103"><a href="#local-6989586621679789103"><span class="hs-identifier">cont_dup_res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#resultTypeOfDupableCont"><span class="hs-identifier hs-var">resultTypeOfDupableCont</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621679789093"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1546"></a><span>                                           </span><span class="hs-special">[</span><a href="#local-6989586621679789101"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621679789099"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1547"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789104"><a href="#local-6989586621679789104"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789105"><a href="#local-6989586621679789105"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplNonRecJoinBndr"><span class="hs-identifier hs-var">simplNonRecJoinBndr</span></a><span> </span><a href="#local-6989586621679789093"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1548"></a><span>                                                        </span><a href="#local-6989586621679789103"><span class="hs-identifier hs-var">cont_dup_res_ty</span></a><span> </span><a href="#local-6989586621679789101"><span class="hs-identifier hs-var">bndr'</span></a><span>
</span><a name="line-1549"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789106"><a href="#local-6989586621679789106"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789107"><a href="#local-6989586621679789107"><span class="hs-identifier">bndr2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#addBndrRules"><span class="hs-identifier hs-var">addBndrRules</span></a><span> </span><a href="#local-6989586621679789104"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679789101"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621679789105"><span class="hs-identifier hs-var">bndr1</span></a><span>
</span><a name="line-1550"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789108"><a href="#local-6989586621679789108"><span class="hs-identifier">env3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789109"><a href="#local-6989586621679789109"><span class="hs-identifier">cont_dup</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789110"><a href="#local-6989586621679789110"><span class="hs-identifier">cont_nodup</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1551"></a><span>                     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#prepareLetCont"><span class="hs-identifier hs-var">prepareLetCont</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapJoinFloats"><span class="hs-identifier hs-var">zapJoinFloats</span></a><span> </span><a href="#local-6989586621679789106"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679789101"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621679789099"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1552"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span class="hs-identifier">cont_dup_res_ty</span><span> </span><span class="hs-special">`</span><a href="#local-6989586621679789103"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">contResultType</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">cont_dup</span></a><span class="hs-special">,</span><span>
</span><a name="line-1553"></a><span>                     </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cont_dup_res_ty</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">blankLine</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-1554"></a><span>                     </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cont</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">blankLine</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-1555"></a><span>                     </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cont_dup</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">blankLine</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-1556"></a><span>                     </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cont_nodup</span><span class="hs-special">)</span><span>
</span><a name="line-1557"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789111"><a href="#local-6989586621679789111"><span class="hs-identifier">env4</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplJoinBind"><span class="hs-identifier hs-var">simplJoinBind</span></a><span> </span><a href="#local-6989586621679789108"><span class="hs-identifier hs-var">env3</span></a><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a href="#local-6989586621679789109"><span class="hs-identifier hs-var">cont_dup</span></a><span> </span><a href="#local-6989586621679789101"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621679789107"><span class="hs-identifier hs-var">bndr2</span></a><span>
</span><a name="line-1558"></a><span>                                         </span><a href="#local-6989586621679789102"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621679789096"><span class="hs-identifier hs-var">rhs_se</span></a><span>
</span><a name="line-1559"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789112"><a href="#local-6989586621679789112"><span class="hs-identifier">env5</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789113"><a href="#local-6989586621679789113"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a><span> </span><a href="#local-6989586621679789111"><span class="hs-identifier hs-var">env4</span></a><span> </span><a href="#local-6989586621679789097"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621679789098"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789109"><span class="hs-identifier hs-var">cont_dup</span></a><span>
</span><a name="line-1560"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789112"><span class="hs-identifier hs-var">env5</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#restoreJoinFloats"><span class="hs-identifier hs-var">restoreJoinFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789106"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1561"></a><span>                           </span><span class="hs-special">(</span><a href="SimplEnv.html#wrapJoinFloats"><span class="hs-identifier hs-var">wrapJoinFloats</span></a><span> </span><a href="#local-6989586621679789112"><span class="hs-identifier hs-var">env5</span></a><span> </span><a href="#local-6989586621679789113"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789110"><span class="hs-identifier hs-var">cont_nodup</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1562"></a><span>
</span><a name="line-1563"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1564"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">bndr</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1565"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789114"><a href="#local-6989586621679789114"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789115"><a href="#local-6989586621679789115"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplNonRecBndr"><span class="hs-identifier hs-var">simplNonRecBndr</span></a><span> </span><a href="#local-6989586621679789093"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1566"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789116"><a href="#local-6989586621679789116"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789117"><a href="#local-6989586621679789117"><span class="hs-identifier">bndr2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#addBndrRules"><span class="hs-identifier hs-var">addBndrRules</span></a><span> </span><a href="#local-6989586621679789114"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679789115"><span class="hs-identifier hs-var">bndr1</span></a><span>
</span><a name="line-1567"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789118"><a href="#local-6989586621679789118"><span class="hs-identifier">env3</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplLazyBind"><span class="hs-identifier hs-var">simplLazyBind</span></a><span> </span><a href="#local-6989586621679789116"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a href="#local-6989586621679789094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679789117"><span class="hs-identifier hs-var">bndr2</span></a><span> </span><a href="#local-6989586621679789095"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789096"><span class="hs-identifier hs-var">rhs_se</span></a><span>
</span><a name="line-1568"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a><span> </span><a href="#local-6989586621679789118"><span class="hs-identifier hs-var">env3</span></a><span> </span><a href="#local-6989586621679789097"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621679789098"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789099"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1569"></a><span>
</span><a name="line-1570"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-1571"></a><span class="hs-identifier">simplRecE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-1572"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1573"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span>
</span><a name="line-1574"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1575"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1576"></a><span>
</span><a name="line-1577"></a><span class="hs-comment">-- simplRecE is used for</span><span>
</span><a name="line-1578"></a><span class="hs-comment">--  * non-top-level recursive lets in expressions</span><span>
</span><a name="line-1579"></a><a name="simplRecE"><a href="Simplify.html#simplRecE"><span class="hs-identifier">simplRecE</span></a></a><span> </span><a name="local-6989586621679789119"><a href="#local-6989586621679789119"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789120"><a href="#local-6989586621679789120"><span class="hs-identifier">pairs</span></a></a><span> </span><a name="local-6989586621679789121"><a href="#local-6989586621679789121"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679789122"><a href="#local-6989586621679789122"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1580"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679789123"><a href="#local-6989586621679789123"><span class="hs-identifier">pairs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#joinPointBindings_maybe"><span class="hs-identifier hs-var">joinPointBindings_maybe</span></a><span> </span><a href="#local-6989586621679789120"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-1581"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789124"><a href="#local-6989586621679789124"><span class="hs-identifier">bndrs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-6989586621679789123"><span class="hs-identifier hs-var">pairs'</span></a><span>
</span><a name="line-1582"></a><span>              </span><a name="local-6989586621679789125"><a href="#local-6989586621679789125"><span class="hs-identifier">cont_dup_res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#resultTypeOfDupableCont"><span class="hs-identifier hs-var">resultTypeOfDupableCont</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621679789119"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1583"></a><span>                                                        </span><a href="#local-6989586621679789124"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621679789122"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1584"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789126"><a href="#local-6989586621679789126"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplRecJoinBndrs"><span class="hs-identifier hs-var">simplRecJoinBndrs</span></a><span> </span><a href="#local-6989586621679789119"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789125"><span class="hs-identifier hs-var">cont_dup_res_ty</span></a><span> </span><a href="#local-6989586621679789124"><span class="hs-identifier hs-var">bndrs'</span></a><span>
</span><a name="line-1585"></a><span>                </span><span class="hs-comment">-- NB: bndrs' don't have unfoldings or rules</span><span>
</span><a name="line-1586"></a><span>                </span><span class="hs-comment">-- We add them as we go down</span><span>
</span><a name="line-1587"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789127"><a href="#local-6989586621679789127"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789128"><a href="#local-6989586621679789128"><span class="hs-identifier">cont_dup</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789129"><a href="#local-6989586621679789129"><span class="hs-identifier">cont_nodup</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#prepareLetCont"><span class="hs-identifier hs-var">prepareLetCont</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapJoinFloats"><span class="hs-identifier hs-var">zapJoinFloats</span></a><span> </span><a href="#local-6989586621679789126"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1588"></a><span>                                                         </span><a href="#local-6989586621679789124"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621679789122"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1589"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span class="hs-identifier">cont_dup_res_ty</span><span> </span><span class="hs-special">`</span><a href="#local-6989586621679789125"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">contResultType</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">cont_dup</span></a><span class="hs-special">,</span><span>
</span><a name="line-1590"></a><span>            </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cont_dup_res_ty</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">blankLine</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-1591"></a><span>            </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cont</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">blankLine</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-1592"></a><span>            </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cont_dup</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">blankLine</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-1593"></a><span>            </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cont_nodup</span><span class="hs-special">)</span><span>
</span><a name="line-1594"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789130"><a href="#local-6989586621679789130"><span class="hs-identifier">env3</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplRecBind"><span class="hs-identifier hs-var">simplRecBind</span></a><span> </span><a href="#local-6989586621679789127"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679789128"><span class="hs-identifier hs-var">cont_dup</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789123"><span class="hs-identifier hs-var">pairs'</span></a><span>
</span><a name="line-1595"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789131"><a href="#local-6989586621679789131"><span class="hs-identifier">env4</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789132"><a href="#local-6989586621679789132"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789130"><span class="hs-identifier hs-var">env3</span></a><span> </span><a href="#local-6989586621679789121"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789128"><span class="hs-identifier hs-var">cont_dup</span></a><span>
</span><a name="line-1596"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789131"><span class="hs-identifier hs-var">env4</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#restoreJoinFloats"><span class="hs-identifier hs-var">restoreJoinFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789126"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1597"></a><span>                  </span><span class="hs-special">(</span><a href="SimplEnv.html#wrapJoinFloats"><span class="hs-identifier hs-var">wrapJoinFloats</span></a><span> </span><a href="#local-6989586621679789131"><span class="hs-identifier hs-var">env4</span></a><span> </span><a href="#local-6989586621679789132"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789129"><span class="hs-identifier hs-var">cont_nodup</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1598"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1599"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789133"><a href="#local-6989586621679789133"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-6989586621679789120"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-1600"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">isJoinId</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">bndrs</span><span class="hs-special">)</span><span>
</span><a name="line-1601"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789134"><a href="#local-6989586621679789134"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplRecBndrs"><span class="hs-identifier hs-var">simplRecBndrs</span></a><span> </span><a href="#local-6989586621679789119"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789133"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1602"></a><span>                </span><span class="hs-comment">-- NB: bndrs' don't have unfoldings or rules</span><span>
</span><a name="line-1603"></a><span>                </span><span class="hs-comment">-- We add them as we go down</span><span>
</span><a name="line-1604"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789135"><a href="#local-6989586621679789135"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplRecBind"><span class="hs-identifier hs-var">simplRecBind</span></a><span> </span><a href="#local-6989586621679789134"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679789122"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789120"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-1605"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789135"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621679789121"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679789122"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1606"></a><span>
</span><a name="line-1607"></a><span>
</span><a name="line-1608"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                     Variables
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1615"></a><span>
</span><a name="line-1616"></a><span class="hs-identifier">simplVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-1617"></a><span class="hs-comment">-- Look up an InVar in the environment</span><span>
</span><a name="line-1618"></a><a name="simplVar"><a href="Simplify.html#simplVar"><span class="hs-identifier">simplVar</span></a></a><span> </span><a name="local-6989586621679789136"><a href="#local-6989586621679789136"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789137"><a href="#local-6989586621679789137"><span class="hs-identifier">var</span></a></a><span>
</span><a name="line-1619"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621679789137"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#substTyVar"><span class="hs-identifier hs-var">substTyVar</span></a><span> </span><a href="#local-6989586621679789136"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789137"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1620"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621679789137"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#substCoVar"><span class="hs-identifier hs-var">substCoVar</span></a><span> </span><a href="#local-6989586621679789136"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789137"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1621"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1622"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="SimplEnv.html#substId"><span class="hs-identifier hs-var">substId</span></a><span> </span><a href="#local-6989586621679789136"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789137"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1623"></a><span>        </span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><a name="local-6989586621679789138"><a href="#local-6989586621679789138"><span class="hs-identifier">var1</span></a></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621679789138"><span class="hs-identifier hs-var">var1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1624"></a><span>        </span><a href="SimplEnv.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a><span> </span><a name="local-6989586621679789139"><a href="#local-6989586621679789139"><span class="hs-identifier">e</span></a></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789139"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1625"></a><span>        </span><a href="SimplEnv.html#ContEx"><span class="hs-identifier hs-var">ContEx</span></a><span> </span><a name="local-6989586621679789140"><a href="#local-6989586621679789140"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621679789141"><a href="#local-6989586621679789141"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621679789142"><a href="#local-6989586621679789142"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621679789143"><a href="#local-6989586621679789143"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#setSubstEnv"><span class="hs-identifier hs-var">setSubstEnv</span></a><span> </span><a href="#local-6989586621679789136"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789140"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621679789141"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621679789142"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789143"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1626"></a><span>
</span><a name="line-1627"></a><span class="hs-identifier">simplIdF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1628"></a><a name="simplIdF"><a href="Simplify.html#simplIdF"><span class="hs-identifier">simplIdF</span></a></a><span> </span><a name="local-6989586621679789144"><a href="#local-6989586621679789144"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789145"><a href="#local-6989586621679789145"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621679789146"><a href="#local-6989586621679789146"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1629"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="SimplEnv.html#substId"><span class="hs-identifier hs-var">substId</span></a><span> </span><a href="#local-6989586621679789144"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789145"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1630"></a><span>        </span><a href="SimplEnv.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a><span> </span><a name="local-6989586621679789159"><a href="#local-6989586621679789159"><span class="hs-identifier">e</span></a></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span> </span><a href="#local-6989586621679789144"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789159"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679789147"><span class="hs-identifier hs-var">trimmed_cont</span></a><span>
</span><a name="line-1631"></a><span>        </span><a href="SimplEnv.html#ContEx"><span class="hs-identifier hs-var">ContEx</span></a><span> </span><a name="local-6989586621679789160"><a href="#local-6989586621679789160"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621679789161"><a href="#local-6989586621679789161"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621679789162"><a href="#local-6989586621679789162"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621679789163"><a href="#local-6989586621679789163"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#setSubstEnv"><span class="hs-identifier hs-var">setSubstEnv</span></a><span> </span><a href="#local-6989586621679789144"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789160"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621679789161"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621679789162"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789163"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679789146"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1632"></a><span>                                  </span><span class="hs-comment">-- Don't trim; haven't already simplified</span><span>
</span><a name="line-1633"></a><span>                                  </span><span class="hs-comment">-- the join, so the cont was never copied</span><span>
</span><a name="line-1634"></a><span>        </span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><a name="local-6989586621679789164"><a href="#local-6989586621679789164"><span class="hs-identifier">var1</span></a></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#completeCall"><span class="hs-identifier hs-var">completeCall</span></a><span> </span><a href="#local-6989586621679789144"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789164"><span class="hs-identifier hs-var">var1</span></a><span> </span><a href="#local-6989586621679789147"><span class="hs-identifier hs-var">trimmed_cont</span></a><span>
</span><a name="line-1635"></a><span>                </span><span class="hs-comment">-- Note [zapSubstEnv]</span><span>
</span><a name="line-1636"></a><span>                </span><span class="hs-comment">-- The template is already simplified, so don't re-substitute.</span><span>
</span><a name="line-1637"></a><span>                </span><span class="hs-comment">-- This is VITAL.  Consider</span><span>
</span><a name="line-1638"></a><span>                </span><span class="hs-comment">--      let x = e in</span><span>
</span><a name="line-1639"></a><span>                </span><span class="hs-comment">--      let y = \z -&gt; ...x... in</span><span>
</span><a name="line-1640"></a><span>                </span><span class="hs-comment">--      \ x -&gt; ...y...</span><span>
</span><a name="line-1641"></a><span>                </span><span class="hs-comment">-- We'll clone the inner \x, adding x-&gt;x' in the id_subst</span><span>
</span><a name="line-1642"></a><span>                </span><span class="hs-comment">-- Then when we inline y, we must *not* replace x by x' in</span><span>
</span><a name="line-1643"></a><span>                </span><span class="hs-comment">-- the inlined copy!!</span><span>
</span><a name="line-1644"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1645"></a><span>    </span><a name="local-6989586621679789147"><a href="#local-6989586621679789147"><span class="hs-identifier">trimmed_cont</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679789149"><a href="#local-6989586621679789149"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#isJoinIdInEnv_maybe"><span class="hs-identifier hs-var">isJoinIdInEnv_maybe</span></a><span> </span><a href="#local-6989586621679789144"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789145"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1646"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789148"><span class="hs-identifier hs-var">trim_cont</span></a><span> </span><a href="#local-6989586621679789149"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621679789146"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1647"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1648"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789146"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1649"></a><span>
</span><a name="line-1650"></a><span>    </span><span class="hs-comment">-- Drop outer context from join point invocation</span><span>
</span><a name="line-1651"></a><span>    </span><span class="hs-comment">-- Note [Case-of-case and join points]</span><span>
</span><a name="line-1652"></a><span>    </span><a name="local-6989586621679789148"><a href="#local-6989586621679789148"><span class="hs-identifier">trim_cont</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621679789150"><a href="#local-6989586621679789150"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1653"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789150"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1654"></a><span>    </span><span class="hs-identifier">trim_cont</span><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621679789151"><a href="#local-6989586621679789151"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1655"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789151"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-1656"></a><span>    </span><span class="hs-identifier">trim_cont</span><span> </span><a name="local-6989586621679789152"><a href="#local-6989586621679789152"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679789153"><a href="#local-6989586621679789153"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789154"><a href="#local-6989586621679789154"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1657"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789153"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789148"><span class="hs-identifier hs-var">trim_cont</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789152"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789154"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1658"></a><span>    </span><span class="hs-identifier">trim_cont</span><span> </span><a name="local-6989586621679789155"><a href="#local-6989586621679789155"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679789156"><a href="#local-6989586621679789156"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789157"><a href="#local-6989586621679789157"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1659"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789156"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789148"><span class="hs-identifier hs-var">trim_cont</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789155"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789157"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- join arity counts types!</span><span>
</span><a name="line-1660"></a><span>    </span><span class="hs-identifier">trim_cont</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789158"><a href="#local-6989586621679789158"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1661"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;completeCall&quot;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789145"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789158"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1662"></a><span>
</span><a name="line-1663"></a><span class="hs-comment">---------------------------------------------------------</span><span>
</span><a name="line-1664"></a><span class="hs-comment">--      Dealing with a call site</span><span>
</span><a name="line-1665"></a><span>
</span><a name="line-1666"></a><span class="hs-identifier">completeCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1667"></a><a name="completeCall"><a href="Simplify.html#completeCall"><span class="hs-identifier">completeCall</span></a></a><span> </span><a name="local-6989586621679789165"><a href="#local-6989586621679789165"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789166"><a href="#local-6989586621679789166"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621679789167"><a href="#local-6989586621679789167"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1668"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">------------- Try inlining ----------------</span><span>
</span><a name="line-1669"></a><span>          </span><a name="local-6989586621679789172"><a href="#local-6989586621679789172"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1670"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>  </span><span class="hs-special">(</span><a name="local-6989586621679789173"><a href="#local-6989586621679789173"><span class="hs-identifier">lone_variable</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789174"><a href="#local-6989586621679789174"><span class="hs-identifier">arg_infos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789175"><a href="#local-6989586621679789175"><span class="hs-identifier">call_cont</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contArgs"><span class="hs-identifier hs-var">contArgs</span></a><span> </span><a href="#local-6989586621679789167"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1671"></a><span>               </span><a name="local-6989586621679789176"><a href="#local-6989586621679789176"><span class="hs-identifier">n_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621679789174"><span class="hs-identifier hs-var">arg_infos</span></a><span>
</span><a name="line-1672"></a><span>               </span><a name="local-6989586621679789177"><a href="#local-6989586621679789177"><span class="hs-identifier">interesting_cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#interestingCallContext"><span class="hs-identifier hs-var">interestingCallContext</span></a><span> </span><a href="#local-6989586621679789175"><span class="hs-identifier hs-var">call_cont</span></a><span>
</span><a name="line-1673"></a><span>               </span><a name="local-6989586621679789178"><a href="#local-6989586621679789178"><span class="hs-identifier">unfolding</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#activeUnfolding"><span class="hs-identifier hs-var">activeUnfolding</span></a><span> </span><a href="#local-6989586621679789165"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789166"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1674"></a><span>               </span><a name="local-6989586621679789179"><a href="#local-6989586621679789179"><span class="hs-identifier">maybe_inline</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUnfold.html#callSiteInline"><span class="hs-identifier hs-var">callSiteInline</span></a><span> </span><a href="#local-6989586621679789172"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679789166"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621679789178"><span class="hs-identifier hs-var">unfolding</span></a><span>
</span><a name="line-1675"></a><span>                                             </span><a href="#local-6989586621679789173"><span class="hs-identifier hs-var">lone_variable</span></a><span> </span><a href="#local-6989586621679789174"><span class="hs-identifier hs-var">arg_infos</span></a><span> </span><a href="#local-6989586621679789177"><span class="hs-identifier hs-var">interesting_cont</span></a><span>
</span><a name="line-1676"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679789179"><span class="hs-identifier hs-var">maybe_inline</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1677"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679789180"><a href="#local-6989586621679789180"><span class="hs-identifier">expr</span></a></a><span>      </span><span class="hs-comment">-- There is an inlining!</span><span>
</span><a name="line-1678"></a><span>              </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#checkedTick"><span class="hs-identifier hs-var">checkedTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#UnfoldingDone"><span class="hs-identifier hs-var">UnfoldingDone</span></a><span> </span><a href="#local-6989586621679789166"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-1679"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679789168"><span class="hs-identifier hs-var">dump_inline</span></a><span> </span><a href="#local-6989586621679789172"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679789180"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679789167"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1680"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span> </span><a href="#local-6989586621679789165"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789180"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679789167"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1681"></a><span>
</span><a name="line-1682"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>               </span><span class="hs-comment">-- No inlining!</span><span>
</span><a name="line-1683"></a><span>
</span><a name="line-1684"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789181"><a href="#local-6989586621679789181"><span class="hs-identifier">rule_base</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplMonad.html#getSimplRules"><span class="hs-identifier hs-var">getSimplRules</span></a><span>
</span><a name="line-1685"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789182"><a href="#local-6989586621679789182"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkArgInfo"><span class="hs-identifier hs-var">mkArgInfo</span></a><span> </span><a href="#local-6989586621679789166"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><a href="Rules.html#getRules"><span class="hs-identifier hs-var">getRules</span></a><span> </span><a href="#local-6989586621679789181"><span class="hs-identifier hs-var">rule_base</span></a><span> </span><a href="#local-6989586621679789166"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789176"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><a href="#local-6989586621679789175"><span class="hs-identifier hs-var">call_cont</span></a><span>
</span><a name="line-1686"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a><span> </span><a href="#local-6989586621679789165"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789182"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621679789167"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1687"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1688"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1689"></a><span>    </span><a name="local-6989586621679789168"><a href="#local-6989586621679789168"><span class="hs-identifier">dump_inline</span></a></a><span> </span><a name="local-6989586621679789169"><a href="#local-6989586621679789169"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679789170"><a href="#local-6989586621679789170"><span class="hs-identifier">unfolding</span></a></a><span> </span><a name="local-6989586621679789171"><a href="#local-6989586621679789171"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1690"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#dopt"><span class="hs-identifier hs-var">dopt</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_inlinings"><span class="hs-identifier hs-var">Opt_D_dump_inlinings</span></a><span> </span><a href="#local-6989586621679789169"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#dopt"><span class="hs-identifier hs-var">dopt</span></a><span> </span><a href="DynFlags.html#Opt_D_verbose_core2core"><span class="hs-identifier hs-var">Opt_D_verbose_core2core</span></a><span> </span><a href="#local-6989586621679789169"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1692"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-6989586621679789166"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1693"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="ErrUtils.html#printOutputForUser"><span class="hs-identifier hs-var">printOutputForUser</span></a><span> </span><a href="#local-6989586621679789169"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="Outputable.html#alwaysQualify"><span class="hs-identifier hs-var">alwaysQualify</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1694"></a><span>                </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Inlining done:&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789166"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1695"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1696"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="ErrUtils.html#printOutputForUser"><span class="hs-identifier hs-var">printOutputForUser</span></a><span> </span><a href="#local-6989586621679789169"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="Outputable.html#alwaysQualify"><span class="hs-identifier hs-var">alwaysQualify</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1697"></a><span>           </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Inlining done: &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789166"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">,</span><span>
</span><a name="line-1698"></a><span>                </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Inlined fn: &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789170"><span class="hs-identifier hs-var">unfolding</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1699"></a><span>                              </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Cont:  &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789171"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1700"></a><span>
</span><a name="line-1701"></a><span class="hs-identifier">rebuildCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-1702"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span>
</span><a name="line-1703"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1704"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1705"></a><a name="rebuildCall"><a href="Simplify.html#rebuildCall"><span class="hs-identifier">rebuildCall</span></a></a><span> </span><a name="local-6989586621679789183"><a href="#local-6989586621679789183"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789184"><a href="#local-6989586621679789184"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789185"><a href="#local-6989586621679789185"><span class="hs-identifier">rev_args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_strs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679789186"><a href="#local-6989586621679789186"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1706"></a><span>  </span><span class="hs-comment">-- When we run out of strictness args, it means</span><span>
</span><a name="line-1707"></a><span>  </span><span class="hs-comment">-- that the call is definitely bottom; see SimplUtils.mkArgInfo</span><span>
</span><a name="line-1708"></a><span>  </span><span class="hs-comment">-- Then we want to discard the entire strict continuation.  E.g.</span><span>
</span><a name="line-1709"></a><span>  </span><span class="hs-comment">--    * case (error &quot;hello&quot;) of { ... }</span><span>
</span><a name="line-1710"></a><span>  </span><span class="hs-comment">--    * (error &quot;Hello&quot;) arg</span><span>
</span><a name="line-1711"></a><span>  </span><span class="hs-comment">--    * f (error &quot;Hello&quot;) where f is strict</span><span>
</span><a name="line-1712"></a><span>  </span><span class="hs-comment">--    etc</span><span>
</span><a name="line-1713"></a><span>  </span><span class="hs-comment">-- Then, especially in the first of these cases, we'd like to discard</span><span>
</span><a name="line-1714"></a><span>  </span><span class="hs-comment">-- the continuation, leaving just the bottoming expression.  But the</span><span>
</span><a name="line-1715"></a><span>  </span><span class="hs-comment">-- type might not be right, so we may have to add a coerce.</span><span>
</span><a name="line-1716"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a><span> </span><a href="#local-6989586621679789186"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Only do this if there is a non-trivial</span><span>
</span><a name="line-1717"></a><span>                                 </span><span class="hs-comment">-- continuation to discard, else we do it</span><span>
</span><a name="line-1718"></a><span>                                 </span><span class="hs-comment">-- again and again!</span><span>
</span><a name="line-1719"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><a href="#local-6989586621679789188"><span class="hs-identifier hs-var">cont_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>        </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><a name="line-1720"></a><span>    </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789183"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="MkCore.html#castBottomExpr"><span class="hs-identifier hs-var">castBottomExpr</span></a><span> </span><a href="#local-6989586621679789187"><span class="hs-identifier hs-var">res</span></a><span> </span><a href="#local-6989586621679789188"><span class="hs-identifier hs-var">cont_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1721"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1722"></a><span>    </span><a name="local-6989586621679789187"><a href="#local-6989586621679789187"><span class="hs-identifier">res</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#argInfoExpr"><span class="hs-identifier hs-var">argInfoExpr</span></a><span> </span><a href="#local-6989586621679789184"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679789185"><span class="hs-identifier hs-var">rev_args</span></a><span>
</span><a name="line-1723"></a><span>    </span><a name="local-6989586621679789188"><a href="#local-6989586621679789188"><span class="hs-identifier">cont_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789186"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1724"></a><span>
</span><a name="line-1725"></a><span class="hs-identifier">rebuildCall</span><span> </span><a name="local-6989586621679789189"><a href="#local-6989586621679789189"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789190"><a href="#local-6989586621679789190"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a name="local-6989586621679789191"><a href="#local-6989586621679789191"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621679789192"><a href="#local-6989586621679789192"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1726"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a><span> </span><a href="#local-6989586621679789189"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#addCastTo"><span class="hs-identifier hs-var">addCastTo</span></a><span> </span><a href="#local-6989586621679789190"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621679789191"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789192"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1727"></a><span>
</span><a name="line-1728"></a><span class="hs-identifier">rebuildCall</span><span> </span><a name="local-6989586621679789193"><a href="#local-6989586621679789193"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789194"><a href="#local-6989586621679789194"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789195"><a href="#local-6989586621679789195"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789196"><a href="#local-6989586621679789196"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1729"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a><span> </span><a href="#local-6989586621679789193"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789194"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">`</span><a href="SimplUtils.html#addTyArgTo"><span class="hs-identifier hs-var">addTyArgTo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789195"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789196"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1730"></a><span>
</span><a name="line-1731"></a><span class="hs-identifier">rebuildCall</span><span> </span><a name="local-6989586621679789197"><a href="#local-6989586621679789197"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789198"><a href="#local-6989586621679789198"><span class="hs-identifier">info</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789199"><a href="#local-6989586621679789199"><span class="hs-identifier">encl_rules</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_type</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789200"><a href="#local-6989586621679789200"><span class="hs-identifier">fun_ty</span></a></a><span>
</span><a name="line-1732"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_strs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789201"><a href="#local-6989586621679789201"><span class="hs-identifier">str</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789202"><a href="#local-6989586621679789202"><span class="hs-identifier">strs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_discs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789203"><a href="#local-6989586621679789203"><span class="hs-identifier">disc</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789204"><a href="#local-6989586621679789204"><span class="hs-identifier">discs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1733"></a><span>            </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789205"><a href="#local-6989586621679789205"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789206"><a href="#local-6989586621679789206"><span class="hs-identifier">arg_se</span></a></a><span>
</span><a name="line-1734"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789207"><a href="#local-6989586621679789207"><span class="hs-identifier">dup_flag</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789208"><a href="#local-6989586621679789208"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1735"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a><span> </span><a href="#local-6989586621679789207"><span class="hs-identifier hs-var">dup_flag</span></a><span>     </span><span class="hs-comment">-- See Note [Avoid redundant simplification]</span><span>
</span><a name="line-1736"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a><span> </span><a href="#local-6989586621679789197"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#addValArgTo"><span class="hs-identifier hs-var">addValArgTo</span></a><span> </span><a href="#local-6989586621679789209"><span class="hs-identifier hs-var">info'</span></a><span> </span><a href="#local-6989586621679789205"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789208"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1737"></a><span>
</span><a name="line-1738"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679789201"><span class="hs-identifier hs-var">str</span></a><span>                 </span><span class="hs-comment">-- Strict argument</span><span>
</span><a name="line-1739"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;Strict Arg&quot; (ppr arg $$ ppr (seIdSubst env) $$ ppr (seInScope env)) $</span><span>
</span><a name="line-1740"></a><span>    </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789206"><span class="hs-identifier hs-var">arg_se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setFloats"><span class="hs-identifier hs-var">setFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789197"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789205"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1741"></a><span>               </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><a href="#local-6989586621679789209"><span class="hs-identifier hs-var">info'</span></a><span> </span><a href="#local-6989586621679789210"><span class="hs-identifier hs-var">cci</span></a><span> </span><a href="#local-6989586621679789208"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-1742"></a><span>                </span><span class="hs-comment">-- Note [Shadowing]</span><span>
</span><a name="line-1743"></a><span>
</span><a name="line-1744"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                           </span><span class="hs-comment">-- Lazy argument</span><span>
</span><a name="line-1745"></a><span>        </span><span class="hs-comment">-- DO NOT float anything outside, hence simplExprC</span><span>
</span><a name="line-1746"></a><span>        </span><span class="hs-comment">-- There is no benefit (unlike in a let-binding), and we'd</span><span>
</span><a name="line-1747"></a><span>        </span><span class="hs-comment">-- have to be very careful about bogus strictness through</span><span>
</span><a name="line-1748"></a><span>        </span><span class="hs-comment">-- floating a demanded let.</span><span>
</span><a name="line-1749"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789211"><a href="#local-6989586621679789211"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789206"><span class="hs-identifier hs-var">arg_se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setInScopeAndZapFloats"><span class="hs-identifier hs-var">setInScopeAndZapFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789197"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789205"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1750"></a><span>                             </span><span class="hs-special">(</span><a href="SimplUtils.html#mkLazyArgStop"><span class="hs-identifier hs-var">mkLazyArgStop</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#funArgTy"><span class="hs-identifier hs-var">funArgTy</span></a><span> </span><a href="#local-6989586621679789200"><span class="hs-identifier hs-var">fun_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789210"><span class="hs-identifier hs-var">cci</span></a><span class="hs-special">)</span><span>
</span><a name="line-1751"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a><span> </span><a href="#local-6989586621679789197"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#addValArgTo"><span class="hs-identifier hs-var">addValArgTo</span></a><span> </span><a href="#local-6989586621679789209"><span class="hs-identifier hs-var">info'</span></a><span> </span><a href="#local-6989586621679789211"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789208"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1752"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1753"></a><span>    </span><a name="local-6989586621679789209"><a href="#local-6989586621679789209"><span class="hs-identifier">info'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789198"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_strs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789202"><span class="hs-identifier hs-var">strs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_discs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789204"><span class="hs-identifier hs-var">discs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1754"></a><span>    </span><a name="local-6989586621679789210"><a href="#local-6989586621679789210"><span class="hs-identifier">cci</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679789199"><span class="hs-identifier hs-var">encl_rules</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUnfold.html#RuleArgCtxt"><span class="hs-identifier hs-var">RuleArgCtxt</span></a><span>
</span><a name="line-1755"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679789203"><span class="hs-identifier hs-var">disc</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreUnfold.html#DiscArgCtxt"><span class="hs-identifier hs-var">DiscArgCtxt</span></a><span>  </span><span class="hs-comment">-- Be keener here</span><span>
</span><a name="line-1756"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUnfold.html#BoringCtxt"><span class="hs-identifier hs-var">BoringCtxt</span></a><span>   </span><span class="hs-comment">-- Nothing interesting</span><span>
</span><a name="line-1757"></a><span>
</span><a name="line-1758"></a><span class="hs-identifier">rebuildCall</span><span> </span><a name="local-6989586621679789212"><a href="#local-6989586621679789212"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789213"><a href="#local-6989586621679789213"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789214"><a href="#local-6989586621679789214"><span class="hs-identifier">rev_args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789215"><a href="#local-6989586621679789215"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679789216"><a href="#local-6989586621679789216"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1759"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621679789215"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-1760"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679789212"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#argInfoExpr"><span class="hs-identifier hs-var">argInfoExpr</span></a><span> </span><a href="#local-6989586621679789213"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679789214"><span class="hs-identifier hs-var">rev_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789216"><span class="hs-identifier hs-var">cont</span></a><span>      </span><span class="hs-comment">-- No rules, common case</span><span>
</span><a name="line-1761"></a><span>
</span><a name="line-1762"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1763"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- We've accumulated a simplified call in &lt;fun,rev_args&gt;</span><span>
</span><a name="line-1764"></a><span>          </span><span class="hs-comment">-- so try rewrite rules; see Note [RULEs apply to simplified arguments]</span><span>
</span><a name="line-1765"></a><span>          </span><span class="hs-comment">-- See also Note [Rules for recursive functions]</span><span>
</span><a name="line-1766"></a><span>          </span><a name="local-6989586621679789217"><a href="#local-6989586621679789217"><span class="hs-identifier">mb_rule</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#tryRules"><span class="hs-identifier hs-var">tryRules</span></a><span> </span><a href="#local-6989586621679789212"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789215"><span class="hs-identifier hs-var">rules</span></a><span> </span><a href="#local-6989586621679789213"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-6989586621679789214"><span class="hs-identifier hs-var">rev_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789216"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1767"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679789217"><span class="hs-identifier hs-var">mb_rule</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1768"></a><span>             </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789218"><a href="#local-6989586621679789218"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789219"><a href="#local-6989586621679789219"><span class="hs-identifier">rule_rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789220"><a href="#local-6989586621679789220"><span class="hs-identifier">cont'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789218"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789219"><span class="hs-identifier hs-var">rule_rhs</span></a><span> </span><a href="#local-6989586621679789220"><span class="hs-identifier hs-var">cont'</span></a><span>
</span><a name="line-1769"></a><span>
</span><a name="line-1770"></a><span>                 </span><span class="hs-comment">-- Rules don't match</span><span>
</span><a name="line-1771"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><a href="#local-6989586621679789212"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#argInfoExpr"><span class="hs-identifier hs-var">argInfoExpr</span></a><span> </span><a href="#local-6989586621679789213"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679789214"><span class="hs-identifier hs-var">rev_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789216"><span class="hs-identifier hs-var">cont</span></a><span>      </span><span class="hs-comment">-- No rules</span><span>
</span><a name="line-1772"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1773"></a><span>
</span><a name="line-1774"></a><span class="hs-comment">{-
Note [RULES apply to simplified arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's very desirable to try RULES once the arguments have been simplified, because
doing so ensures that rule cascades work in one pass.  Consider
   {-# RULES g (h x) = k x
             f (k x) = x #-}
   ...f (g (h x))...
Then we want to rewrite (g (h x)) to (k x) and only then try f's rules. If
we match f's rules against the un-simplified RHS, it won't match.  This
makes a particularly big difference when superclass selectors are involved:
        op ($p1 ($p2 (df d)))
We want all this to unravel in one sweep.

Note [Avoid redundant simplification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Because RULES apply to simplified arguments, there's a danger of repeatedly
simplifying already-simplified arguments.  An important example is that of
        (&gt;&gt;=) d e1 e2
Here e1, e2 are simplified before the rule is applied, but don't really
participate in the rule firing. So we mark them as Simplified to avoid
re-simplifying them.

Note [Shadowing]
~~~~~~~~~~~~~~~~
This part of the simplifier may break the no-shadowing invariant
Consider
        f (...(\a -&gt; e)...) (case y of (a,b) -&gt; e')
where f is strict in its second arg
If we simplify the innermost one first we get (...(\a -&gt; e)...)
Simplifying the second arg makes us float the case out, so we end up with
        case y of (a,b) -&gt; f (...(\a -&gt; e)...) e'
So the output does not have the no-shadowing invariant.  However, there is
no danger of getting name-capture, because when the first arg was simplified
we used an in-scope set that at least mentioned all the variables free in its
static environment, and that is enough.

We can't just do innermost first, or we'd end up with a dual problem:
        case x of (a,b) -&gt; f e (...(\a -&gt; e')...)

I spent hours trying to recover the no-shadowing invariant, but I just could
not think of an elegant way to do it.  The simplifier is already knee-deep in
continuations.  We have to keep the right in-scope set around; AND we have
to get the effect that finding (error &quot;foo&quot;) in a strict arg position will
discard the entire application and replace it with (error &quot;foo&quot;).  Getting
all this at once is TOO HARD!


************************************************************************
*                                                                      *
                Rewrite rules
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1828"></a><span>
</span><a name="line-1829"></a><span class="hs-identifier">tryRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-1830"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span class="hs-special">]</span><span>
</span><a name="line-1831"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1832"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1833"></a><span>
</span><a name="line-1834"></a><a name="tryRules"><a href="Simplify.html#tryRules"><span class="hs-identifier">tryRules</span></a></a><span> </span><a name="local-6989586621679789221"><a href="#local-6989586621679789221"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789222"><a href="#local-6989586621679789222"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-6989586621679789223"><a href="#local-6989586621679789223"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621679789224"><a href="#local-6989586621679789224"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679789225"><a href="#local-6989586621679789225"><span class="hs-identifier">call_cont</span></a></a><span>
</span><a name="line-1835"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621679789222"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-1836"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1837"></a><span class="hs-comment">{- Disabled until we fix #8326
  | fn `hasKey` tagToEnumKey   -- See Note [Optimising tagToEnum#]
  , [_type_arg, val_arg] &lt;- args
  , Select dup bndr ((_,[],rhs1) : rest_alts) se cont &lt;- call_cont
  , isDeadBinder bndr
  = do { dflags &lt;- getDynFlags
       ; let enum_to_tag :: CoreAlt -&gt; CoreAlt
                -- Takes   K -&gt; e  into   tagK# -&gt; e
                -- where tagK# is the tag of constructor K
             enum_to_tag (DataAlt con, [], rhs)
               = ASSERT( isEnumerationTyCon (dataConTyCon con) )
                (LitAlt tag, [], rhs)
              where
                tag = mkMachInt dflags (toInteger (dataConTag con - fIRST_TAG))
             enum_to_tag alt = pprPanic &quot;tryRules: tagToEnum&quot; (ppr alt)

             new_alts = (DEFAULT, [], rhs1) : map enum_to_tag rest_alts
             new_bndr = setIdType bndr intPrimTy
                 -- The binder is dead, but should have the right type
      ; return (Just (val_arg, Select dup new_bndr new_alts se cont)) }
-}</span><span>
</span><a name="line-1858"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1859"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789240"><a href="#local-6989586621679789240"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1860"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Rules.html#lookupRule"><span class="hs-identifier hs-var">lookupRule</span></a><span> </span><a href="#local-6989586621679789240"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#getUnfoldingInRuleMatch"><span class="hs-identifier hs-var">getUnfoldingInRuleMatch</span></a><span> </span><a href="#local-6989586621679789221"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#activeRule"><span class="hs-identifier hs-var">activeRule</span></a><span> </span><a href="#local-6989586621679789221"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1861"></a><span>                         </span><a href="#local-6989586621679789223"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a><span> </span><a href="#local-6989586621679789224"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789222"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1862"></a><span>           </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1863"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621679789229"><span class="hs-identifier hs-var">nodump</span></a><span> </span><a href="#local-6989586621679789240"><span class="hs-identifier hs-var">dflags</span></a><span>  </span><span class="hs-comment">-- This ensures that an empty file is written</span><span>
</span><a name="line-1864"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>  </span><span class="hs-comment">-- No rule matches</span><span>
</span><a name="line-1865"></a><span>           </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789241"><a href="#local-6989586621679789241"><span class="hs-identifier">rule</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789242"><a href="#local-6989586621679789242"><span class="hs-identifier">rule_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1866"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#checkedTick"><span class="hs-identifier hs-var">checkedTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#RuleFired"><span class="hs-identifier hs-var">RuleFired</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a><span> </span><a href="#local-6989586621679789241"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1867"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789243"><a href="#local-6989586621679789243"><span class="hs-identifier">cont'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#pushSimplifiedArgs"><span class="hs-identifier hs-var">pushSimplifiedArgs</span></a><span> </span><a href="#local-6989586621679789226"><span class="hs-identifier hs-var">zapped_env</span></a><span>
</span><a name="line-1868"></a><span>                                                 </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#drop"><span class="hs-identifier hs-var">drop</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleArity"><span class="hs-identifier hs-var">ruleArity</span></a><span> </span><a href="#local-6989586621679789241"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789224"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1869"></a><span>                                                 </span><a href="#local-6989586621679789225"><span class="hs-identifier hs-var">call_cont</span></a><span>
</span><a name="line-1870"></a><span>                              </span><span class="hs-comment">-- (ruleArity rule) says how</span><span>
</span><a name="line-1871"></a><span>                              </span><span class="hs-comment">-- many args the rule consumed</span><span>
</span><a name="line-1872"></a><span>
</span><a name="line-1873"></a><span>                      </span><a name="local-6989586621679789244"><a href="#local-6989586621679789244"><span class="hs-identifier">occ_anald_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a><span> </span><a href="#local-6989586621679789242"><span class="hs-identifier hs-var">rule_rhs</span></a><span>
</span><a name="line-1874"></a><span>                          </span><span class="hs-comment">-- See Note [Occurrence-analyse after rule firing]</span><span>
</span><a name="line-1875"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679789228"><span class="hs-identifier hs-var">dump</span></a><span> </span><a href="#local-6989586621679789240"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679789241"><span class="hs-identifier hs-var">rule</span></a><span> </span><a href="#local-6989586621679789242"><span class="hs-identifier hs-var">rule_rhs</span></a><span>
</span><a name="line-1876"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789226"><span class="hs-identifier hs-var">zapped_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789244"><span class="hs-identifier hs-var">occ_anald_rhs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789243"><span class="hs-identifier hs-var">cont'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1877"></a><span>                     </span><span class="hs-comment">-- The occ_anald_rhs and cont' are all Out things</span><span>
</span><a name="line-1878"></a><span>                     </span><span class="hs-comment">-- hence zapping the environment</span><span>
</span><a name="line-1879"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1880"></a><span>    </span><a name="local-6989586621679789226"><a href="#local-6989586621679789226"><span class="hs-identifier">zapped_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span> </span><a href="#local-6989586621679789221"><span class="hs-identifier hs-var">env</span></a><span>  </span><span class="hs-comment">-- See Note [zapSubstEnv]</span><span>
</span><a name="line-1881"></a><span>
</span><a name="line-1882"></a><span>    </span><a name="local-6989586621679789227"><a href="#local-6989586621679789227"><span class="hs-identifier">printRuleModule</span></a></a><span> </span><a name="local-6989586621679789231"><a href="#local-6989586621679789231"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1883"></a><span>      </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span>
</span><a name="line-1884"></a><span>        </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;BUILTIN&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Module.html#pprModuleName"><span class="hs-identifier hs-var">pprModuleName</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">moduleName</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleModule"><span class="hs-identifier hs-var">ruleModule</span></a><span> </span><a href="#local-6989586621679789231"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1885"></a><span>
</span><a name="line-1886"></a><span>    </span><a name="local-6989586621679789228"><a href="#local-6989586621679789228"><span class="hs-identifier">dump</span></a></a><span> </span><a name="local-6989586621679789232"><a href="#local-6989586621679789232"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679789233"><a href="#local-6989586621679789233"><span class="hs-identifier">rule</span></a></a><span> </span><a name="local-6989586621679789234"><a href="#local-6989586621679789234"><span class="hs-identifier">rule_rhs</span></a></a><span>
</span><a name="line-1887"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#dopt"><span class="hs-identifier hs-var">dopt</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_rule_rewrites"><span class="hs-identifier hs-var">Opt_D_dump_rule_rewrites</span></a><span> </span><a href="#local-6989586621679789232"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1888"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789230"><span class="hs-identifier hs-var">log_rule</span></a><span> </span><a href="#local-6989586621679789232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_rule_rewrites"><span class="hs-identifier hs-var">Opt_D_dump_rule_rewrites</span></a><span> </span><span class="hs-string">&quot;Rule fired&quot;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-1889"></a><span>          </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a><span> </span><a href="#local-6989586621679789233"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-1890"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Module:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>  </span><a href="#local-6989586621679789227"><span class="hs-identifier hs-var">printRuleModule</span></a><span> </span><a href="#local-6989586621679789233"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-1891"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Before:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789223"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789224"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1892"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;After: &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="PprCore.html#pprCoreExpr"><span class="hs-identifier hs-var">pprCoreExpr</span></a><span> </span><a href="#local-6989586621679789234"><span class="hs-identifier hs-var">rule_rhs</span></a><span>
</span><a name="line-1893"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Cont:  &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789225"><span class="hs-identifier hs-var">call_cont</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1894"></a><span>
</span><a name="line-1895"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#dopt"><span class="hs-identifier hs-var">dopt</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_rule_firings"><span class="hs-identifier hs-var">Opt_D_dump_rule_firings</span></a><span> </span><a href="#local-6989586621679789232"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1896"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789230"><span class="hs-identifier hs-var">log_rule</span></a><span> </span><a href="#local-6989586621679789232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_rule_firings"><span class="hs-identifier hs-var">Opt_D_dump_rule_firings</span></a><span> </span><span class="hs-string">&quot;Rule fired:&quot;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1897"></a><span>          </span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a><span> </span><a href="#local-6989586621679789233"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-1898"></a><span>            </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621679789227"><span class="hs-identifier hs-var">printRuleModule</span></a><span> </span><a href="#local-6989586621679789233"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-1899"></a><span>
</span><a name="line-1900"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1901"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1902"></a><span>
</span><a name="line-1903"></a><span>    </span><a name="local-6989586621679789229"><a href="#local-6989586621679789229"><span class="hs-identifier">nodump</span></a></a><span> </span><a name="local-6989586621679789235"><a href="#local-6989586621679789235"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1904"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#dopt"><span class="hs-identifier hs-var">dopt</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_rule_rewrites"><span class="hs-identifier hs-var">Opt_D_dump_rule_rewrites</span></a><span> </span><a href="#local-6989586621679789235"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1905"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="ErrUtils.html#dumpSDoc"><span class="hs-identifier hs-var">dumpSDoc</span></a><span> </span><a href="#local-6989586621679789235"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="Outputable.html#alwaysQualify"><span class="hs-identifier hs-var">alwaysQualify</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_rule_rewrites"><span class="hs-identifier hs-var">Opt_D_dump_rule_rewrites</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1906"></a><span>
</span><a name="line-1907"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#dopt"><span class="hs-identifier hs-var">dopt</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_rule_firings"><span class="hs-identifier hs-var">Opt_D_dump_rule_firings</span></a><span> </span><a href="#local-6989586621679789235"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1908"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="ErrUtils.html#dumpSDoc"><span class="hs-identifier hs-var">dumpSDoc</span></a><span> </span><a href="#local-6989586621679789235"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="Outputable.html#alwaysQualify"><span class="hs-identifier hs-var">alwaysQualify</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_rule_firings"><span class="hs-identifier hs-var">Opt_D_dump_rule_firings</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1909"></a><span>
</span><a name="line-1910"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1911"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1912"></a><span>
</span><a name="line-1913"></a><span>    </span><a name="local-6989586621679789230"><a href="#local-6989586621679789230"><span class="hs-identifier">log_rule</span></a></a><span> </span><a name="local-6989586621679789236"><a href="#local-6989586621679789236"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679789237"><a href="#local-6989586621679789237"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621679789238"><a href="#local-6989586621679789238"><span class="hs-identifier">hdr</span></a></a><span> </span><a name="local-6989586621679789239"><a href="#local-6989586621679789239"><span class="hs-identifier">details</span></a></a><span>
</span><a name="line-1914"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="ErrUtils.html#dumpSDoc"><span class="hs-identifier hs-var">dumpSDoc</span></a><span> </span><a href="#local-6989586621679789236"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="Outputable.html#alwaysQualify"><span class="hs-identifier hs-var">alwaysQualify</span></a><span> </span><a href="#local-6989586621679789237"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1915"></a><span>                   </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621679789238"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">4</span><span> </span><a href="#local-6989586621679789239"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">]</span><span>
</span><a name="line-1916"></a><span>
</span><a name="line-1917"></a><span class="hs-identifier">trySeqRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-1918"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span>   </span><span class="hs-comment">-- Scrutinee and RHS</span><span>
</span><a name="line-1919"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-1920"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1921"></a><span class="hs-comment">-- See Note [User-defined RULES for seq]</span><span>
</span><a name="line-1922"></a><a name="trySeqRules"><a href="Simplify.html#trySeqRules"><span class="hs-identifier">trySeqRules</span></a></a><span> </span><a name="local-6989586621679789245"><a href="#local-6989586621679789245"><span class="hs-identifier">in_env</span></a></a><span> </span><a name="local-6989586621679789246"><a href="#local-6989586621679789246"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789247"><a href="#local-6989586621679789247"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621679789248"><a href="#local-6989586621679789248"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1923"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789258"><a href="#local-6989586621679789258"><span class="hs-identifier">rule_base</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplMonad.html#getSimplRules"><span class="hs-identifier hs-var">getSimplRules</span></a><span>
</span><a name="line-1924"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#tryRules"><span class="hs-identifier hs-var">tryRules</span></a><span> </span><a href="#local-6989586621679789245"><span class="hs-identifier hs-var">in_env</span></a><span> </span><span class="hs-special">(</span><a href="Rules.html#getRules"><span class="hs-identifier hs-var">getRules</span></a><span> </span><a href="#local-6989586621679789258"><span class="hs-identifier hs-var">rule_base</span></a><span> </span><a href="MkId.html#seqId"><span class="hs-identifier hs-var">seqId</span></a><span class="hs-special">)</span><span> </span><a href="MkId.html#seqId"><span class="hs-identifier hs-var">seqId</span></a><span> </span><a href="#local-6989586621679789253"><span class="hs-identifier hs-var">out_args</span></a><span> </span><a href="#local-6989586621679789254"><span class="hs-identifier hs-var">rule_cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1925"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1926"></a><span>    </span><a name="local-6989586621679789249"><a href="#local-6989586621679789249"><span class="hs-identifier">no_cast_scrut</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789255"><span class="hs-identifier hs-var">drop_casts</span></a><span> </span><a href="#local-6989586621679789246"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-1927"></a><span>    </span><a name="local-6989586621679789250"><a href="#local-6989586621679789250"><span class="hs-identifier">scrut_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621679789249"><span class="hs-identifier hs-var">no_cast_scrut</span></a><span>
</span><a name="line-1928"></a><span>    </span><a name="local-6989586621679789251"><a href="#local-6989586621679789251"><span class="hs-identifier">seq_id_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="MkId.html#seqId"><span class="hs-identifier hs-var">seqId</span></a><span>
</span><a name="line-1929"></a><span>    </span><a name="local-6989586621679789252"><a href="#local-6989586621679789252"><span class="hs-identifier">rhs_ty</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621679789245"><span class="hs-identifier hs-var">in_env</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621679789247"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1930"></a><span>    </span><a name="local-6989586621679789253"><a href="#local-6989586621679789253"><span class="hs-identifier">out_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="SimplUtils.html#TyArg"><span class="hs-identifier hs-var">TyArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">as_arg_ty</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789250"><span class="hs-identifier hs-var">scrut_ty</span></a><span>
</span><a name="line-1931"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">as_hole_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789251"><span class="hs-identifier hs-var">seq_id_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1932"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#TyArg"><span class="hs-identifier hs-var">TyArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">as_arg_ty</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789252"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1933"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">as_hole_ty</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#piResultTy"><span class="hs-identifier hs-var">piResultTy</span></a><span> </span><a href="#local-6989586621679789251"><span class="hs-identifier hs-var">seq_id_ty</span></a><span> </span><a href="#local-6989586621679789250"><span class="hs-identifier hs-var">scrut_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1934"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a><span> </span><a href="#local-6989586621679789249"><span class="hs-identifier hs-var">no_cast_scrut</span></a><span class="hs-special">]</span><span>
</span><a name="line-1935"></a><span>    </span><a name="local-6989586621679789254"><a href="#local-6989586621679789254"><span class="hs-identifier">rule_cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789247"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1936"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789245"><span class="hs-identifier hs-var">in_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789248"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1937"></a><span>    </span><span class="hs-comment">-- Lazily evaluated, so we don't do most of this</span><span>
</span><a name="line-1938"></a><span>
</span><a name="line-1939"></a><span>    </span><a name="local-6989586621679789255"><a href="#local-6989586621679789255"><span class="hs-identifier">drop_casts</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621679789256"><a href="#local-6989586621679789256"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789255"><span class="hs-identifier hs-var">drop_casts</span></a><span> </span><a href="#local-6989586621679789256"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1940"></a><span>    </span><span class="hs-identifier">drop_casts</span><span> </span><a name="local-6989586621679789257"><a href="#local-6989586621679789257"><span class="hs-identifier">e</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789257"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1941"></a><span>
</span><a name="line-1942"></a><span class="hs-comment">{- Note [User-defined RULES for seq]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given
   case (scrut |&gt; co) of _ -&gt; rhs
look for rules that match the expression
   seq @t1 @t2 scrut
where scrut :: t1
      rhs   :: t2

If you find a match, rewrite it, and apply to 'rhs'.

Notice that we can simply drop casts on the fly here, which
makes it more likely that a rule will match.

See Note [User-defined RULES for seq] in MkId.

Note [Occurrence-analyse after rule firing]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
After firing a rule, we occurrence-analyse the instantiated RHS before
simplifying it.  Usually this doesn't make much difference, but it can
be huge.  Here's an example (simplCore/should_compile/T7785)

  map f (map f (map f xs)

= -- Use build/fold form of map, twice
  map f (build (\cn. foldr (mapFB c f) n
                           (build (\cn. foldr (mapFB c f) n xs))))

= -- Apply fold/build rule
  map f (build (\cn. (\cn. foldr (mapFB c f) n xs) (mapFB c f) n))

= -- Beta-reduce
  -- Alas we have no occurrence-analysed, so we don't know
  -- that c is used exactly once
  map f (build (\cn. let c1 = mapFB c f in
                     foldr (mapFB c1 f) n xs))

= -- Use mapFB rule:   mapFB (mapFB c f) g = mapFB c (f.g)
  -- We can do this because (mapFB c n) is a PAP and hence expandable
  map f (build (\cn. let c1 = mapFB c n in
                     foldr (mapFB c (f.f)) n x))

This is not too bad.  But now do the same with the outer map, and
we get another use of mapFB, and t can interact with /both/ remaining
mapFB calls in the above expression.  This is stupid because actually
that 'c1' binding is dead.  The outer map introduces another c2. If
there is a deep stack of maps we get lots of dead bindings, and lots
of redundant work as we repeatedly simplify the result of firing rules.

The easy thing to do is simply to occurrence analyse the result of
the rule firing.  Note that this occ-anals not only the RHS of the
rule, but also the function arguments, which by now are OutExprs.
E.g.
      RULE f (g x) = x+1

Call   f (g BIG)  --&gt;   (\x. x+1) BIG

The rule binders are lambda-bound and applied to the OutExpr arguments
(here BIG) which lack all internal occurrence info.

Is this inefficient?  Not really: we are about to walk over the result
of the rule firing to simplify it, so occurrence analysis is at most
a constant factor.

Possible improvement: occ-anal the rules when putting them in the
database; and in the simplifier just occ-anal the OutExpr arguments.
But that's more complicated and the rule RHS is usually tiny; so I'm
just doing the simple thing.

Historical note: previously we did occ-anal the rules in Rule.hs,
but failed to occ-anal the OutExpr arguments, which led to the
nasty performance problem described above.


Note [Optimising tagToEnum#]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have an enumeration data type:

  data Foo = A | B | C

Then we want to transform

   case tagToEnum# x of   ==&gt;    case x of
     A -&gt; e1                       DEFAULT -&gt; e1
     B -&gt; e2                       1#      -&gt; e2
     C -&gt; e3                       2#      -&gt; e3

thereby getting rid of the tagToEnum# altogether.  If there was a DEFAULT
alternative we retain it (remember it comes first).  If not the case must
be exhaustive, and we reflect that in the transformed version by adding
a DEFAULT.  Otherwise Lint complains that the new case is not exhaustive.
See #8317.

Note [Rules for recursive functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
You might think that we shouldn't apply rules for a loop breaker:
doing so might give rise to an infinite loop, because a RULE is
rather like an extra equation for the function:
     RULE:           f (g x) y = x+y
     Eqn:            f a     y = a-y

But it's too drastic to disable rules for loop breakers.
Even the foldr/build rule would be disabled, because foldr
is recursive, and hence a loop breaker:
     foldr k z (build g) = g k z
So it's up to the programmer: rules can cause divergence


************************************************************************
*                                                                      *
                Rebuilding a case expression
*                                                                      *
************************************************************************

Note [Case elimination]
~~~~~~~~~~~~~~~~~~~~~~~
The case-elimination transformation discards redundant case expressions.
Start with a simple situation:

        case x# of      ===&gt;   let y# = x# in e
          y# -&gt; e

(when x#, y# are of primitive type, of course).  We can't (in general)
do this for algebraic cases, because we might turn bottom into
non-bottom!

The code in SimplUtils.prepareAlts has the effect of generalise this
idea to look for a case where we're scrutinising a variable, and we
know that only the default case can match.  For example:

        case x of
          0#      -&gt; ...
          DEFAULT -&gt; ...(case x of
                         0#      -&gt; ...
                         DEFAULT -&gt; ...) ...

Here the inner case is first trimmed to have only one alternative, the
DEFAULT, after which it's an instance of the previous case.  This
really only shows up in eliminating error-checking code.

Note that SimplUtils.mkCase combines identical RHSs.  So

        case e of       ===&gt; case e of DEFAULT -&gt; r
           True  -&gt; r
           False -&gt; r

Now again the case may be elminated by the CaseElim transformation.
This includes things like (==# a# b#)::Bool so that we simplify
      case ==# a# b# of { True -&gt; x; False -&gt; x }
to just
      x
This particular example shows up in default methods for
comparison operations (e.g. in (&gt;=) for Int.Int32)

Note [Case elimination: lifted case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a case over a lifted type has a single alternative, and is being used
as a strict 'let' (all isDeadBinder bndrs), we may want to do this
transformation:

    case e of r       ===&gt;   let r = e in ...r...
      _ -&gt; ...r...

        (a) 'e' is already evaluated (it may so if e is a variable)
            Specifically we check (exprIsHNF e).  In this case
            we can just allocate the WHNF directly with a let.
or
        (b) 'x' is not used at all and e is ok-for-speculation
             The ok-for-spec bit checks that we don't lose any
             exceptions or divergence.

             NB: it'd be *sound* to switch from case to let if the
             scrutinee was not yet WHNF but was guaranteed to
             converge; but sticking with case means we won't build a
             thunk

or
        (c) 'x' is used strictly in the body, and 'e' is a variable
            Then we can just substitute 'e' for 'x' in the body.
            See Note [Eliminating redundant seqs]

For (b), the &quot;not used at all&quot; test is important.  Consider
   case (case a &gt;# b of { True -&gt; (p,q); False -&gt; (q,p) }) of
     r -&gt; blah
The scrutinee is ok-for-speculation (it looks inside cases), but we do
not want to transform to
   let r = case a &gt;# b of { True -&gt; (p,q); False -&gt; (q,p) }
   in blah
because that builds an unnecessary thunk.

Note [Eliminating redundant seqs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have this:
   case x of r { _ -&gt; ..r.. }
where 'r' is used strictly in (..r..), the case is effectively a 'seq'
on 'x', but since 'r' is used strictly anyway, we can safely transform to
   (...x...)

Note that this can change the error behaviour.  For example, we might
transform
    case x of { _ -&gt; error &quot;bad&quot; }
    --&gt; error &quot;bad&quot;
which is might be puzzling if 'x' currently lambda-bound, but later gets
let-bound to (error &quot;good&quot;).

Nevertheless, the paper &quot;A semantics for imprecise exceptions&quot; allows
this transformation. If you want to fix the evaluation order, use
'pseq'.  See Trac #8900 for an example where the loss of this
transformation bit us in practice.

See also Note [Empty case alternatives] in CoreSyn.

Just for reference, the original code (added Jan 13) looked like this:
     || case_bndr_evald_next rhs

    case_bndr_evald_next :: CoreExpr -&gt; Bool
      -- See Note [Case binder next]
    case_bndr_evald_next (Var v)         = v == case_bndr
    case_bndr_evald_next (Cast e _)      = case_bndr_evald_next e
    case_bndr_evald_next (App e _)       = case_bndr_evald_next e
    case_bndr_evald_next (Case e _ _ _)  = case_bndr_evald_next e
    case_bndr_evald_next _               = False

(This came up when fixing Trac #7542. See also Note [Eta reduction of
an eval'd function] in CoreUtils.)


Note [Case elimination: unlifted case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   case a +# b of r -&gt; ...r...
Then we do case-elimination (to make a let) followed by inlining,
to get
        .....(a +# b)....
If we have
   case indexArray# a i of r -&gt; ...r...
we might like to do the same, and inline the (indexArray# a i).
But indexArray# is not okForSpeculation, so we don't build a let
in rebuildCase (lest it get floated *out*), so the inlining doesn't
happen either.

This really isn't a big deal I think. The let can be


Further notes about case elimination
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:       test :: Integer -&gt; IO ()
                test = print

Turns out that this compiles to:
    Print.test
      = \ eta :: Integer
          eta1 :: Void# -&gt;
          case PrelNum.&lt; eta PrelNum.zeroInteger of wild { __DEFAULT -&gt;
          case hPutStr stdout
                 (PrelNum.jtos eta ($w[] @ Char))
                 eta1
          of wild1 { (# new_s, a4 #) -&gt; PrelIO.lvl23 new_s  }}

Notice the strange '&lt;' which has no effect at all. This is a funny one.
It started like this:

f x y = if x &lt; 0 then jtos x
          else if y==0 then &quot;&quot; else jtos x

At a particular call site we have (f v 1).  So we inline to get

        if v &lt; 0 then jtos x
        else if 1==0 then &quot;&quot; else jtos x

Now simplify the 1==0 conditional:

        if v&lt;0 then jtos v else jtos v

Now common-up the two branches of the case:

        case (v&lt;0) of DEFAULT -&gt; jtos v

Why don't we drop the case?  Because it's strict in v.  It's technically
wrong to drop even unnecessary evaluations, and in practice they
may be a result of 'seq' so we *definitely* don't want to drop those.
I don't really know how to improve this situation.
-}</span><span>
</span><a name="line-2225"></a><span>
</span><a name="line-2226"></a><span class="hs-comment">---------------------------------------------------------</span><span>
</span><a name="line-2227"></a><span class="hs-comment">--      Eliminate the case if possible</span><span>
</span><a name="line-2228"></a><span>
</span><a name="line-2229"></a><span class="hs-identifier">rebuildCase</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reallyRebuildCase</span><span>
</span><a name="line-2230"></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2231"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>          </span><span class="hs-comment">-- Scrutinee</span><span>
</span><a name="line-2232"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span>             </span><span class="hs-comment">-- Case binder</span><span>
</span><a name="line-2233"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- Alternatives (inceasing order)</span><span>
</span><a name="line-2234"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-2235"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2236"></a><span>
</span><a name="line-2237"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2238"></a><span class="hs-comment">--      1. Eliminate the case if there's a known constructor</span><span>
</span><a name="line-2239"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2240"></a><span>
</span><a name="line-2241"></a><a name="rebuildCase"><a href="Simplify.html#rebuildCase"><span class="hs-identifier">rebuildCase</span></a></a><span> </span><a name="local-6989586621679789259"><a href="#local-6989586621679789259"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789260"><a href="#local-6989586621679789260"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789261"><a href="#local-6989586621679789261"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621679789262"><a href="#local-6989586621679789262"><span class="hs-identifier">alts</span></a></a><span> </span><a name="local-6989586621679789263"><a href="#local-6989586621679789263"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2242"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621679789268"><a href="#local-6989586621679789268"><span class="hs-identifier">lit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679789260"><span class="hs-identifier hs-var">scrut</span></a><span>    </span><span class="hs-comment">-- No need for same treatment as constructors</span><span>
</span><a name="line-2243"></a><span>                        </span><span class="hs-comment">-- because literals are inlined more vigorously</span><span>
</span><a name="line-2244"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Literal.html#litIsLifted"><span class="hs-identifier hs-var">litIsLifted</span></a><span> </span><a href="#local-6989586621679789268"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-2245"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#KnownBranch"><span class="hs-identifier hs-var">KnownBranch</span></a><span> </span><a href="#local-6989586621679789261"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2246"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreUtils.html#findAlt"><span class="hs-identifier hs-var">findAlt</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><a href="#local-6989586621679789268"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789262"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2247"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#missingAlt"><span class="hs-identifier hs-var">missingAlt</span></a><span> </span><a href="#local-6989586621679789259"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789261"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789262"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="#local-6989586621679789263"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2248"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679789269"><a href="#local-6989586621679789269"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789270"><a href="#local-6989586621679789270"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679789264"><span class="hs-identifier hs-var">simple_rhs</span></a><span> </span><a href="#local-6989586621679789269"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679789270"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2249"></a><span>
</span><a name="line-2250"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789271"><a href="#local-6989586621679789271"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789272"><a href="#local-6989586621679789272"><span class="hs-identifier">ty_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789273"><a href="#local-6989586621679789273"><span class="hs-identifier">other_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#exprIsConApp_maybe"><span class="hs-identifier hs-var">exprIsConApp_maybe</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#getUnfoldingInRuleMatch"><span class="hs-identifier hs-var">getUnfoldingInRuleMatch</span></a><span> </span><a href="#local-6989586621679789259"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789260"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2251"></a><span>        </span><span class="hs-comment">-- Works when the scrutinee is a variable with a known unfolding</span><span>
</span><a name="line-2252"></a><span>        </span><span class="hs-comment">-- as well as when it's an explicit constructor application</span><span>
</span><a name="line-2253"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#KnownBranch"><span class="hs-identifier hs-var">KnownBranch</span></a><span> </span><a href="#local-6989586621679789261"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2254"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreUtils.html#findAlt"><span class="hs-identifier hs-var">findAlt</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a href="#local-6989586621679789271"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789262"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2255"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#missingAlt"><span class="hs-identifier hs-var">missingAlt</span></a><span> </span><a href="#local-6989586621679789259"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789261"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789262"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="#local-6989586621679789263"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2256"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789274"><a href="#local-6989586621679789274"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789275"><a href="#local-6989586621679789275"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679789264"><span class="hs-identifier hs-var">simple_rhs</span></a><span> </span><a href="#local-6989586621679789274"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679789275"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2257"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679789276"><a href="#local-6989586621679789276"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789277"><a href="#local-6989586621679789277"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#knownCon"><span class="hs-identifier hs-var">knownCon</span></a><span> </span><a href="#local-6989586621679789259"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789260"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621679789271"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621679789272"><span class="hs-identifier hs-var">ty_args</span></a><span> </span><a href="#local-6989586621679789273"><span class="hs-identifier hs-var">other_args</span></a><span>
</span><a name="line-2258"></a><span>                                                </span><a href="#local-6989586621679789261"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789276"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679789277"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789263"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2259"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-2260"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2261"></a><span>    </span><a name="local-6989586621679789264"><a href="#local-6989586621679789264"><span class="hs-identifier">simple_rhs</span></a></a><span> </span><a name="local-6989586621679789265"><a href="#local-6989586621679789265"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679789266"><a href="#local-6989586621679789266"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier hs-var">bs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2262"></a><span>                        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789267"><a href="#local-6989586621679789267"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplNonRecX"><span class="hs-identifier hs-var">simplNonRecX</span></a><span> </span><a href="#local-6989586621679789259"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789261"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789260"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2263"></a><span>                               </span><span class="hs-comment">-- scrut is a constructor application,</span><span>
</span><a name="line-2264"></a><span>                               </span><span class="hs-comment">-- hence satisfies let/app invariant</span><span>
</span><a name="line-2265"></a><span>                           </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789267"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789266"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789263"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2266"></a><span>
</span><a name="line-2267"></a><span>
</span><a name="line-2268"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2269"></a><span class="hs-comment">--      2. Eliminate the case if scrutinee is evaluated</span><span>
</span><a name="line-2270"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2271"></a><span>
</span><a name="line-2272"></a><span class="hs-identifier">rebuildCase</span><span> </span><a name="local-6989586621679789278"><a href="#local-6989586621679789278"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789279"><a href="#local-6989586621679789279"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789280"><a href="#local-6989586621679789280"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621679789281"><a href="#local-6989586621679789281"><span class="hs-identifier">alts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679789282"><a href="#local-6989586621679789282"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789283"><a href="#local-6989586621679789283"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a name="local-6989586621679789284"><a href="#local-6989586621679789284"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2273"></a><span>  </span><span class="hs-comment">-- See if we can get rid of the case altogether</span><span>
</span><a name="line-2274"></a><span>  </span><span class="hs-comment">-- See Note [Case elimination]</span><span>
</span><a name="line-2275"></a><span>  </span><span class="hs-comment">-- mkCase made sure that if all the alternatives are equal,</span><span>
</span><a name="line-2276"></a><span>  </span><span class="hs-comment">-- then there is now only one (DEFAULT) rhs</span><span>
</span><a name="line-2277"></a><span>
</span><a name="line-2278"></a><span>  </span><span class="hs-comment">-- 2a.  Dropping the case altogether, if</span><span>
</span><a name="line-2279"></a><span>  </span><span class="hs-comment">--      a) it binds nothing (so it's really just a 'seq')</span><span>
</span><a name="line-2280"></a><span>  </span><span class="hs-comment">--      b) evaluating the scrutinee has no side effects</span><span>
</span><a name="line-2281"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679789287"><span class="hs-identifier hs-var">is_plain_seq</span></a><span>
</span><a name="line-2282"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprOkForSideEffects"><span class="hs-identifier hs-var">exprOkForSideEffects</span></a><span> </span><a href="#local-6989586621679789279"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2283"></a><span>          </span><span class="hs-comment">-- The entire case is dead, so we can drop it</span><span>
</span><a name="line-2284"></a><span>          </span><span class="hs-comment">-- if the scrutinee converges without having imperative</span><span>
</span><a name="line-2285"></a><span>          </span><span class="hs-comment">-- side effects or raising a Haskell exception</span><span>
</span><a name="line-2286"></a><span>          </span><span class="hs-comment">-- See Note [PrimOp can_fail and has_side_effects] in PrimOp</span><span>
</span><a name="line-2287"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789278"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789283"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789284"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2288"></a><span>
</span><a name="line-2289"></a><span>  </span><span class="hs-comment">-- 2b.  Turn the case into a let, if</span><span>
</span><a name="line-2290"></a><span>  </span><span class="hs-comment">--      a) it binds only the case-binder</span><span>
</span><a name="line-2291"></a><span>  </span><span class="hs-comment">--      b) unlifted case: the scrutinee is ok-for-speculation</span><span>
</span><a name="line-2292"></a><span>  </span><span class="hs-comment">--           lifted case: the scrutinee is in HNF (or will later be demanded)</span><span>
</span><a name="line-2293"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679789286"><span class="hs-identifier hs-var">all_dead_bndrs</span></a><span>
</span><a name="line-2294"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679789285"><span class="hs-identifier hs-var">is_unlifted</span></a><span>
</span><a name="line-2295"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="CoreUtils.html#exprOkForSpeculation"><span class="hs-identifier hs-var">exprOkForSpeculation</span></a><span> </span><a href="#local-6989586621679789279"><span class="hs-identifier hs-var">scrut</span></a><span>  </span><span class="hs-comment">-- See Note [Case elimination: unlifted case]</span><span>
</span><a name="line-2296"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="CoreUtils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a><span> </span><a href="#local-6989586621679789279"><span class="hs-identifier hs-var">scrut</span></a><span>             </span><span class="hs-comment">-- See Note [Case elimination: lifted case]</span><span>
</span><a name="line-2297"></a><span>      </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679789288"><span class="hs-identifier hs-var">scrut_is_demanded_var</span></a><span> </span><a href="#local-6989586621679789279"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#CaseElim"><span class="hs-identifier hs-var">CaseElim</span></a><span> </span><a href="#local-6989586621679789280"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2299"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789290"><a href="#local-6989586621679789290"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplNonRecX"><span class="hs-identifier hs-var">simplNonRecX</span></a><span> </span><a href="#local-6989586621679789278"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789280"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789279"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2300"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789290"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789283"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789284"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2301"></a><span>
</span><a name="line-2302"></a><span>  </span><span class="hs-comment">-- 2c. Try the seq rules if</span><span>
</span><a name="line-2303"></a><span>  </span><span class="hs-comment">--     a) it binds only the case binder</span><span>
</span><a name="line-2304"></a><span>  </span><span class="hs-comment">--     b) a rule for seq applies</span><span>
</span><a name="line-2305"></a><span>  </span><span class="hs-comment">-- See Note [User-defined RULES for seq] in MkId</span><span>
</span><a name="line-2306"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679789287"><span class="hs-identifier hs-var">is_plain_seq</span></a><span>
</span><a name="line-2307"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789291"><a href="#local-6989586621679789291"><span class="hs-identifier">mb_rule</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#trySeqRules"><span class="hs-identifier hs-var">trySeqRules</span></a><span> </span><a href="#local-6989586621679789278"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789279"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621679789283"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789284"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2308"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679789291"><span class="hs-identifier hs-var">mb_rule</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2309"></a><span>           </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789292"><a href="#local-6989586621679789292"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789293"><a href="#local-6989586621679789293"><span class="hs-identifier">rule_rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789294"><a href="#local-6989586621679789294"><span class="hs-identifier">cont'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789292"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789293"><span class="hs-identifier hs-var">rule_rhs</span></a><span> </span><a href="#local-6989586621679789294"><span class="hs-identifier hs-var">cont'</span></a><span>
</span><a name="line-2310"></a><span>           </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#reallyRebuildCase"><span class="hs-identifier hs-var">reallyRebuildCase</span></a><span> </span><a href="#local-6989586621679789278"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789279"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621679789280"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789281"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="#local-6989586621679789284"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2311"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2312"></a><span>    </span><a name="local-6989586621679789285"><a href="#local-6989586621679789285"><span class="hs-identifier">is_unlifted</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621679789280"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2313"></a><span>    </span><a name="local-6989586621679789286"><a href="#local-6989586621679789286"><span class="hs-identifier">all_dead_bndrs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621679789282"><span class="hs-identifier hs-var">bndrs</span></a><span>       </span><span class="hs-comment">-- bndrs are [InId]</span><span>
</span><a name="line-2314"></a><span>    </span><a name="local-6989586621679789287"><a href="#local-6989586621679789287"><span class="hs-identifier">is_plain_seq</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789286"><span class="hs-identifier hs-var">all_dead_bndrs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621679789280"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><span class="hs-comment">-- Evaluation *only* for effect</span><span>
</span><a name="line-2315"></a><span>
</span><a name="line-2316"></a><span>    </span><span class="hs-identifier">scrut_is_demanded_var</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2317"></a><span>            </span><span class="hs-comment">-- See Note [Eliminating redundant seqs]</span><span>
</span><a name="line-2318"></a><span>    </span><a name="local-6989586621679789288"><a href="#local-6989586621679789288"><span class="hs-identifier">scrut_is_demanded_var</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621679789289"><a href="#local-6989586621679789289"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789288"><span class="hs-identifier hs-var">scrut_is_demanded_var</span></a><span> </span><a href="#local-6989586621679789289"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-2319"></a><span>    </span><span class="hs-identifier">scrut_is_demanded_var</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#isStrictDmd"><span class="hs-identifier hs-var">isStrictDmd</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a><span> </span><a href="#local-6989586621679789280"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2320"></a><span>    </span><span class="hs-identifier">scrut_is_demanded_var</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2321"></a><span>
</span><a name="line-2322"></a><span>
</span><a name="line-2323"></a><span class="hs-identifier">rebuildCase</span><span> </span><a name="local-6989586621679789295"><a href="#local-6989586621679789295"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789296"><a href="#local-6989586621679789296"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789297"><a href="#local-6989586621679789297"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621679789298"><a href="#local-6989586621679789298"><span class="hs-identifier">alts</span></a></a><span> </span><a name="local-6989586621679789299"><a href="#local-6989586621679789299"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2324"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#reallyRebuildCase"><span class="hs-identifier hs-var">reallyRebuildCase</span></a><span> </span><a href="#local-6989586621679789295"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789296"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621679789297"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789298"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="#local-6989586621679789299"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2325"></a><span>
</span><a name="line-2326"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2327"></a><span class="hs-comment">--      3. Catch-all case</span><span>
</span><a name="line-2328"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2329"></a><span>
</span><a name="line-2330"></a><a name="reallyRebuildCase"><a href="Simplify.html#reallyRebuildCase"><span class="hs-identifier">reallyRebuildCase</span></a></a><span> </span><a name="local-6989586621679789300"><a href="#local-6989586621679789300"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789301"><a href="#local-6989586621679789301"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789302"><a href="#local-6989586621679789302"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621679789303"><a href="#local-6989586621679789303"><span class="hs-identifier">alts</span></a></a><span> </span><a name="local-6989586621679789304"><a href="#local-6989586621679789304"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2331"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Prepare the continuation;</span><span>
</span><a name="line-2332"></a><span>                </span><span class="hs-comment">-- The new subst_env is in place</span><span>
</span><a name="line-2333"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679789305"><a href="#local-6989586621679789305"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789306"><a href="#local-6989586621679789306"><span class="hs-identifier">dup_cont</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789307"><a href="#local-6989586621679789307"><span class="hs-identifier">nodup_cont</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#prepareCaseCont"><span class="hs-identifier hs-var">prepareCaseCont</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapJoinFloats"><span class="hs-identifier hs-var">zapJoinFloats</span></a><span> </span><a href="#local-6989586621679789300"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2334"></a><span>                                                          </span><a href="#local-6989586621679789303"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="#local-6989586621679789304"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2335"></a><span>
</span><a name="line-2336"></a><span>        </span><span class="hs-comment">-- Simplify the alternatives</span><span>
</span><a name="line-2337"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789308"><a href="#local-6989586621679789308"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789309"><a href="#local-6989586621679789309"><span class="hs-identifier">case_bndr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789310"><a href="#local-6989586621679789310"><span class="hs-identifier">alts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplAlts"><span class="hs-identifier hs-var">simplAlts</span></a><span> </span><a href="#local-6989586621679789305"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789301"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621679789302"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789303"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="#local-6989586621679789306"><span class="hs-identifier hs-var">dup_cont</span></a><span>
</span><a name="line-2338"></a><span>
</span><a name="line-2339"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789311"><a href="#local-6989586621679789311"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-2340"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789312"><a href="#local-6989586621679789312"><span class="hs-identifier">alts_ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789306"><span class="hs-identifier hs-var">dup_cont</span></a><span>
</span><a name="line-2341"></a><span>        </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><a name="line-2342"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789313"><a href="#local-6989586621679789313"><span class="hs-identifier">case_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><a href="#local-6989586621679789312"><span class="hs-identifier hs-var">alts_ty'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>
</span><a name="line-2343"></a><span>                       </span><a href="SimplUtils.html#mkCase"><span class="hs-identifier hs-var">mkCase</span></a><span> </span><a href="#local-6989586621679789311"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679789308"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621679789309"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621679789312"><span class="hs-identifier hs-var">alts_ty'</span></a><span> </span><a href="#local-6989586621679789310"><span class="hs-identifier hs-var">alts'</span></a><span>
</span><a name="line-2344"></a><span>
</span><a name="line-2345"></a><span>        </span><span class="hs-comment">-- Notice that rebuild gets the in-scope set from env', not alt_env</span><span>
</span><a name="line-2346"></a><span>        </span><span class="hs-comment">-- (which in any case is only build in simplAlts)</span><span>
</span><a name="line-2347"></a><span>        </span><span class="hs-comment">-- The case binder *not* scope over the whole returned case-expression</span><span>
</span><a name="line-2348"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789305"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#restoreJoinFloats"><span class="hs-identifier hs-var">restoreJoinFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789300"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2349"></a><span>                  </span><span class="hs-special">(</span><a href="SimplEnv.html#wrapJoinFloats"><span class="hs-identifier hs-var">wrapJoinFloats</span></a><span> </span><a href="#local-6989586621679789305"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789313"><span class="hs-identifier hs-var">case_expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789307"><span class="hs-identifier hs-var">nodup_cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2350"></a><span>
</span><a name="line-2351"></a><span class="hs-comment">{-
simplCaseBinder checks whether the scrutinee is a variable, v.  If so,
try to eliminate uses of v in the RHSs in favour of case_bndr; that
way, there's a chance that v will now only be used once, and hence
inlined.

Historical note: we use to do the &quot;case binder swap&quot; in the Simplifier
so there were additional complications if the scrutinee was a variable.
Now the binder-swap stuff is done in the occurrence analyser; see
OccurAnal Note [Binder swap].

Note [knownCon occ info]
~~~~~~~~~~~~~~~~~~~~~~~~
If the case binder is not dead, then neither are the pattern bound
variables:
        case &lt;any&gt; of x { (a,b) -&gt;
        case x of { (p,q) -&gt; p } }
Here (a,b) both look dead, but come alive after the inner case is eliminated.
The point is that we bring into the envt a binding
        let x = (a,b)
after the outer case, and that makes (a,b) alive.  At least we do unless
the case binder is guaranteed dead.

Note [Case alternative occ info]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we are simply reconstructing a case (the common case), we always
zap the occurrence info on the binders in the alternatives.  Even
if the case binder is dead, the scrutinee is usually a variable, and *that*
can bring the case-alternative binders back to life.
See Note [Add unfolding for scrutinee]

Note [Improving seq]
~~~~~~~~~~~~~~~~~~~
Consider
        type family F :: * -&gt; *
        type instance F Int = Int

We'd like to transform
        case e of (x :: F Int) { DEFAULT -&gt; rhs }
===&gt;
        case e `cast` co of (x'::Int)
           I# x# -&gt; let x = x' `cast` sym co
                    in rhs

so that 'rhs' can take advantage of the form of x'.  Notice that Note
[Case of cast] (in OccurAnal) may then apply to the result.

We'd also like to eliminate empty types (Trac #13468). So if

    data Void
    type instance F Bool = Void

then we'd like to transform
        case (x :: F Bool) of { _ -&gt; error &quot;urk&quot; }
===&gt;
        case (x |&gt; co) of (x' :: Void) of {}

Nota Bene: we used to have a built-in rule for 'seq' that dropped
casts, so that
    case (x |&gt; co) of { _ -&gt; blah }
dropped the cast; in order to improve the chances of trySeqRules
firing.  But that works in the /opposite/ direction to Note [Improving
seq] so there's a danger of flip/flopping.  Better to make trySeqRules
insensitive to the cast, which is now is.

The need for [Improving seq] showed up in Roman's experiments.  Example:
  foo :: F Int -&gt; Int -&gt; Int
  foo t n = t `seq` bar n
     where
       bar 0 = 0
       bar n = bar (n - case t of TI i -&gt; i)
Here we'd like to avoid repeated evaluating t inside the loop, by
taking advantage of the `seq`.

At one point I did transformation in LiberateCase, but it's more
robust here.  (Otherwise, there's a danger that we'll simply drop the
'seq' altogether, before LiberateCase gets to see it.)
-}</span><span>
</span><a name="line-2429"></a><span>
</span><a name="line-2430"></a><span class="hs-identifier">simplAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2431"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-2432"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span>                       </span><span class="hs-comment">-- Case binder</span><span>
</span><a name="line-2433"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- Non-empty</span><span>
</span><a name="line-2434"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-2435"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Includes the continuation</span><span>
</span><a name="line-2436"></a><span class="hs-comment">-- Like simplExpr, this just returns the simplified alternatives;</span><span>
</span><a name="line-2437"></a><span class="hs-comment">-- it does not return an environment</span><span>
</span><a name="line-2438"></a><span class="hs-comment">-- The returned alternatives can be empty, none are possible</span><span>
</span><a name="line-2439"></a><span>
</span><a name="line-2440"></a><a name="simplAlts"><a href="Simplify.html#simplAlts"><span class="hs-identifier">simplAlts</span></a></a><span> </span><a name="local-6989586621679789314"><a href="#local-6989586621679789314"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789315"><a href="#local-6989586621679789315"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789316"><a href="#local-6989586621679789316"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621679789317"><a href="#local-6989586621679789317"><span class="hs-identifier">alts</span></a></a><span> </span><a name="local-6989586621679789318"><a href="#local-6989586621679789318"><span class="hs-identifier">cont'</span></a></a><span>
</span><a name="line-2441"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789319"><a href="#local-6989586621679789319"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#zapFloats"><span class="hs-identifier hs-var">zapFloats</span></a><span> </span><a href="#local-6989586621679789314"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2442"></a><span>
</span><a name="line-2443"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789320"><a href="#local-6989586621679789320"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789321"><a href="#local-6989586621679789321"><span class="hs-identifier">case_bndr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a><span> </span><a href="#local-6989586621679789319"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621679789316"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-2444"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789322"><a href="#local-6989586621679789322"><span class="hs-identifier">case_bndr2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789321"><span class="hs-identifier hs-var">case_bndr1</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdUnfolding"><span class="hs-identifier hs-var">setIdUnfolding</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#evaldUnfolding"><span class="hs-identifier hs-var">evaldUnfolding</span></a><span>
</span><a name="line-2445"></a><span>              </span><a name="local-6989586621679789323"><a href="#local-6989586621679789323"><span class="hs-identifier">env2</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a><span> </span><a href="#local-6989586621679789320"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679789322"><span class="hs-identifier hs-var">case_bndr2</span></a><span>
</span><a name="line-2446"></a><span>              </span><span class="hs-comment">-- See Note [Case binder evaluated-ness]</span><span>
</span><a name="line-2447"></a><span>
</span><a name="line-2448"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789324"><a href="#local-6989586621679789324"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplMonad.html#getFamEnvs"><span class="hs-identifier hs-var">getFamEnvs</span></a><span>
</span><a name="line-2449"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789325"><a href="#local-6989586621679789325"><span class="hs-identifier">alt_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789326"><a href="#local-6989586621679789326"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789327"><a href="#local-6989586621679789327"><span class="hs-identifier">case_bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#improveSeq"><span class="hs-identifier hs-var">improveSeq</span></a><span> </span><a href="#local-6989586621679789324"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621679789323"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621679789315"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2450"></a><span>                                                       </span><a href="#local-6989586621679789316"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789322"><span class="hs-identifier hs-var">case_bndr2</span></a><span> </span><a href="#local-6989586621679789317"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2451"></a><span>
</span><a name="line-2452"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789328"><a href="#local-6989586621679789328"><span class="hs-identifier">imposs_deflt_cons</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789329"><a href="#local-6989586621679789329"><span class="hs-identifier">in_alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplUtils.html#prepareAlts"><span class="hs-identifier hs-var">prepareAlts</span></a><span> </span><a href="#local-6989586621679789326"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621679789327"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621679789317"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2453"></a><span>          </span><span class="hs-comment">-- NB: it's possible that the returned in_alts is empty: this is handled</span><span>
</span><a name="line-2454"></a><span>          </span><span class="hs-comment">-- by the caller (rebuildCase) in the missingAlt function</span><span>
</span><a name="line-2455"></a><span>
</span><a name="line-2456"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789330"><a href="#local-6989586621679789330"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="Simplify.html#simplAlt"><span class="hs-identifier hs-var">simplAlt</span></a><span> </span><a href="#local-6989586621679789325"><span class="hs-identifier hs-var">alt_env'</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679789326"><span class="hs-identifier hs-var">scrut'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789328"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a><span> </span><a href="#local-6989586621679789327"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621679789318"><span class="hs-identifier hs-var">cont'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789329"><span class="hs-identifier hs-var">in_alts</span></a><span>
</span><a name="line-2457"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- pprTrace &quot;simplAlts&quot; (ppr case_bndr $$ ppr alts_ty $$ ppr alts_ty' $$ ppr alts $$ ppr cont') $</span><span>
</span><a name="line-2458"></a><span>          </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789326"><span class="hs-identifier hs-var">scrut'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789327"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789330"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2459"></a><span>
</span><a name="line-2460"></a><span>
</span><a name="line-2461"></a><span class="hs-comment">------------------------------------</span><span>
</span><a name="line-2462"></a><span class="hs-identifier">improveSeq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2463"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-2464"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">)</span><span>
</span><a name="line-2465"></a><span class="hs-comment">-- Note [Improving seq]</span><span>
</span><a name="line-2466"></a><a name="improveSeq"><a href="Simplify.html#improveSeq"><span class="hs-identifier">improveSeq</span></a></a><span> </span><a name="local-6989586621679789331"><a href="#local-6989586621679789331"><span class="hs-identifier">fam_envs</span></a></a><span> </span><a name="local-6989586621679789332"><a href="#local-6989586621679789332"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789333"><a href="#local-6989586621679789333"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789334"><a href="#local-6989586621679789334"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621679789335"><a href="#local-6989586621679789335"><span class="hs-identifier">case_bndr1</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2467"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789336"><a href="#local-6989586621679789336"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789337"><a href="#local-6989586621679789337"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier hs-var">topNormaliseType_maybe</span></a><span> </span><a href="#local-6989586621679789331"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621679789335"><span class="hs-identifier hs-var">case_bndr1</span></a><span class="hs-special">)</span><span>
</span><a name="line-2468"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789338"><a href="#local-6989586621679789338"><span class="hs-identifier">case_bndr2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplMonad.html#newId"><span class="hs-identifier hs-var">newId</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;nt&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789337"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2469"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789339"><a href="#local-6989586621679789339"><span class="hs-identifier">rhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621679789338"><span class="hs-identifier hs-var">case_bndr2</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621679789336"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2470"></a><span>              </span><a name="local-6989586621679789340"><a href="#local-6989586621679789340"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><a href="#local-6989586621679789332"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789334"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789339"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2471"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789340"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789333"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789336"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789338"><span class="hs-identifier hs-var">case_bndr2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2472"></a><span>
</span><a name="line-2473"></a><span class="hs-identifier">improveSeq</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789341"><a href="#local-6989586621679789341"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789342"><a href="#local-6989586621679789342"><span class="hs-identifier">scrut</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789343"><a href="#local-6989586621679789343"><span class="hs-identifier">case_bndr1</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-2474"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789341"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789342"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789343"><span class="hs-identifier hs-var">case_bndr1</span></a><span class="hs-special">)</span><span>
</span><a name="line-2475"></a><span>
</span><a name="line-2476"></a><span>
</span><a name="line-2477"></a><span class="hs-comment">------------------------------------</span><span>
</span><a name="line-2478"></a><span class="hs-identifier">simplAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2479"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>  </span><span class="hs-comment">-- The scrutinee</span><span>
</span><a name="line-2480"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- These constructors can't be present when</span><span>
</span><a name="line-2481"></a><span>                           </span><span class="hs-comment">-- matching the DEFAULT alternative</span><span>
</span><a name="line-2482"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>          </span><span class="hs-comment">-- The case binder</span><span>
</span><a name="line-2483"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-2484"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span>
</span><a name="line-2485"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a><span>
</span><a name="line-2486"></a><span>
</span><a name="line-2487"></a><a name="simplAlt"><a href="Simplify.html#simplAlt"><span class="hs-identifier">simplAlt</span></a></a><span> </span><a name="local-6989586621679789344"><a href="#local-6989586621679789344"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789345"><a href="#local-6989586621679789345"><span class="hs-identifier">imposs_deflt_cons</span></a></a><span> </span><a name="local-6989586621679789346"><a href="#local-6989586621679789346"><span class="hs-identifier">case_bndr'</span></a></a><span> </span><a name="local-6989586621679789347"><a href="#local-6989586621679789347"><span class="hs-identifier">cont'</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789348"><a href="#local-6989586621679789348"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789349"><a href="#local-6989586621679789349"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2488"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">bndrs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2489"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789350"><a href="#local-6989586621679789350"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#addBinderUnfolding"><span class="hs-identifier hs-var">addBinderUnfolding</span></a><span> </span><a href="#local-6989586621679789344"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789346"><span class="hs-identifier hs-var">case_bndr'</span></a><span>
</span><a name="line-2490"></a><span>                                        </span><span class="hs-special">(</span><a href="CoreSyn.html#mkOtherCon"><span class="hs-identifier hs-var">mkOtherCon</span></a><span> </span><a href="#local-6989586621679789345"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-2491"></a><span>                </span><span class="hs-comment">-- Record the constructors that the case-binder *can't* be.</span><span>
</span><a name="line-2492"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789351"><a href="#local-6989586621679789351"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a><span> </span><a href="#local-6989586621679789350"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789349"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789347"><span class="hs-identifier hs-var">cont'</span></a><span>
</span><a name="line-2493"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789351"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2494"></a><span>
</span><a name="line-2495"></a><span class="hs-identifier">simplAlt</span><span> </span><a name="local-6989586621679789352"><a href="#local-6989586621679789352"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789353"><a href="#local-6989586621679789353"><span class="hs-identifier">scrut'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789354"><a href="#local-6989586621679789354"><span class="hs-identifier">case_bndr'</span></a></a><span> </span><a name="local-6989586621679789355"><a href="#local-6989586621679789355"><span class="hs-identifier">cont'</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><a name="local-6989586621679789356"><a href="#local-6989586621679789356"><span class="hs-identifier">lit</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789357"><a href="#local-6989586621679789357"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789358"><a href="#local-6989586621679789358"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2496"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">bndrs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2497"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789359"><a href="#local-6989586621679789359"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#addAltUnfoldings"><span class="hs-identifier hs-var">addAltUnfoldings</span></a><span> </span><a href="#local-6989586621679789352"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789353"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621679789354"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-6989586621679789356"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-2498"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789360"><a href="#local-6989586621679789360"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a><span> </span><a href="#local-6989586621679789359"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789358"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789355"><span class="hs-identifier hs-var">cont'</span></a><span>
</span><a name="line-2499"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><a href="#local-6989586621679789356"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789360"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2500"></a><span>
</span><a name="line-2501"></a><span class="hs-identifier">simplAlt</span><span> </span><a name="local-6989586621679789361"><a href="#local-6989586621679789361"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789362"><a href="#local-6989586621679789362"><span class="hs-identifier">scrut'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789363"><a href="#local-6989586621679789363"><span class="hs-identifier">case_bndr'</span></a></a><span> </span><a name="local-6989586621679789364"><a href="#local-6989586621679789364"><span class="hs-identifier">cont'</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-6989586621679789365"><a href="#local-6989586621679789365"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789366"><a href="#local-6989586621679789366"><span class="hs-identifier">vs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789367"><a href="#local-6989586621679789367"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2502"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Deal with the pattern-bound variables</span><span>
</span><a name="line-2503"></a><span>                </span><span class="hs-comment">-- Mark the ones that are in ! positions in the</span><span>
</span><a name="line-2504"></a><span>                </span><span class="hs-comment">-- data constructor as certainly-evaluated.</span><span>
</span><a name="line-2505"></a><span>                </span><span class="hs-comment">-- NB: simplLamBinders preserves this eval info</span><span>
</span><a name="line-2506"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789383"><a href="#local-6989586621679789383"><span class="hs-identifier">vs_with_evals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789368"><span class="hs-identifier hs-var">add_evals</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a><span> </span><a href="#local-6989586621679789365"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2507"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789384"><a href="#local-6989586621679789384"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789385"><a href="#local-6989586621679789385"><span class="hs-identifier">vs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplLamBndrs"><span class="hs-identifier hs-var">simplLamBndrs</span></a><span> </span><a href="#local-6989586621679789361"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789383"><span class="hs-identifier hs-var">vs_with_evals</span></a><span>
</span><a name="line-2508"></a><span>
</span><a name="line-2509"></a><span>                </span><span class="hs-comment">-- Bind the case-binder to (con args)</span><span>
</span><a name="line-2510"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789386"><a href="#local-6989586621679789386"><span class="hs-identifier">inst_tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621679789363"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2511"></a><span>              </span><span class="hs-identifier">con_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-2512"></a><span>              </span><a name="local-6989586621679789387"><a href="#local-6989586621679789387"><span class="hs-identifier">con_app</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkConApp2"><span class="hs-identifier hs-var">mkConApp2</span></a><span> </span><a href="#local-6989586621679789365"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621679789386"><span class="hs-identifier hs-var">inst_tys'</span></a><span> </span><a href="#local-6989586621679789385"><span class="hs-identifier hs-var">vs'</span></a><span>
</span><a name="line-2513"></a><span>
</span><a name="line-2514"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789388"><a href="#local-6989586621679789388"><span class="hs-identifier">env''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#addAltUnfoldings"><span class="hs-identifier hs-var">addAltUnfoldings</span></a><span> </span><a href="#local-6989586621679789384"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789362"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621679789363"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621679789387"><span class="hs-identifier hs-var">con_app</span></a><span>
</span><a name="line-2515"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789389"><a href="#local-6989586621679789389"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a><span> </span><a href="#local-6989586621679789388"><span class="hs-identifier hs-var">env''</span></a><span> </span><a href="#local-6989586621679789367"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789364"><span class="hs-identifier hs-var">cont'</span></a><span>
</span><a name="line-2516"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a href="#local-6989586621679789365"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789385"><span class="hs-identifier hs-var">vs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789389"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2517"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2518"></a><span>        </span><span class="hs-comment">-- add_evals records the evaluated-ness of the bound variables of</span><span>
</span><a name="line-2519"></a><span>        </span><span class="hs-comment">-- a case pattern.  This is *important*.  Consider</span><span>
</span><a name="line-2520"></a><span>        </span><span class="hs-comment">--      data T = T !Int !Int</span><span>
</span><a name="line-2521"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-2522"></a><span>        </span><span class="hs-comment">--      case x of { T a b -&gt; T (a+1) b }</span><span>
</span><a name="line-2523"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-2524"></a><span>        </span><span class="hs-comment">-- We really must record that b is already evaluated so that we don't</span><span>
</span><a name="line-2525"></a><span>        </span><span class="hs-comment">-- go and re-evaluate it when constructing the result.</span><span>
</span><a name="line-2526"></a><span>        </span><span class="hs-comment">-- See Note [Data-con worker strictness] in MkId.hs</span><span>
</span><a name="line-2527"></a><span>    </span><a name="local-6989586621679789368"><a href="#local-6989586621679789368"><span class="hs-identifier">add_evals</span></a></a><span> </span><a name="local-6989586621679789369"><a href="#local-6989586621679789369"><span class="hs-identifier">the_strs</span></a></a><span>
</span><a name="line-2528"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789370"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789366"><span class="hs-identifier hs-var">vs</span></a><span> </span><a href="#local-6989586621679789369"><span class="hs-identifier hs-var">the_strs</span></a><span>
</span><a name="line-2529"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-2530"></a><span>          </span><a name="local-6989586621679789370"><a href="#local-6989586621679789370"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2531"></a><span>          </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789372"><a href="#local-6989586621679789372"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789373"><a href="#local-6989586621679789373"><span class="hs-identifier">vs'</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679789374"><a href="#local-6989586621679789374"><span class="hs-identifier">strs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621679789372"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789372"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679789370"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789373"><span class="hs-identifier hs-var">vs'</span></a><span> </span><a href="#local-6989586621679789374"><span class="hs-identifier hs-var">strs</span></a><span>
</span><a name="line-2532"></a><span>          </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789375"><a href="#local-6989586621679789375"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789376"><a href="#local-6989586621679789376"><span class="hs-identifier">vs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789377"><a href="#local-6989586621679789377"><span class="hs-identifier">str</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789378"><a href="#local-6989586621679789378"><span class="hs-identifier">strs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789371"><span class="hs-identifier hs-var">zap</span></a><span> </span><a href="#local-6989586621679789377"><span class="hs-identifier hs-var">str</span></a><span> </span><a href="#local-6989586621679789375"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679789370"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789376"><span class="hs-identifier hs-var">vs'</span></a><span> </span><a href="#local-6989586621679789378"><span class="hs-identifier hs-var">strs</span></a><span>
</span><a name="line-2533"></a><span>          </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;cat_evals&quot;</span><span>
</span><a name="line-2534"></a><span>                    </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789365"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-2535"></a><span>                     </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789366"><span class="hs-identifier hs-var">vs</span></a><span>  </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-2536"></a><span>                     </span><a href="#local-6989586621679789379"><span class="hs-identifier hs-var">ppr_with_length</span></a><span> </span><a href="#local-6989586621679789369"><span class="hs-identifier hs-var">the_strs</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-2537"></a><span>                     </span><a href="#local-6989586621679789379"><span class="hs-identifier hs-var">ppr_with_length</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a><span> </span><a href="#local-6989586621679789365"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-2538"></a><span>                     </span><a href="#local-6989586621679789379"><span class="hs-identifier hs-var">ppr_with_length</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a><span> </span><a href="#local-6989586621679789365"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2539"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-2540"></a><span>              </span><a name="local-6989586621679789379"><a href="#local-6989586621679789379"><span class="hs-identifier">ppr_with_length</span></a></a><span> </span><a name="local-6989586621679789380"><a href="#local-6989586621679789380"><span class="hs-identifier">list</span></a></a><span>
</span><a name="line-2541"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789380"><span class="hs-identifier hs-var">list</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;length =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621679789380"><span class="hs-identifier hs-var">list</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2542"></a><span>                                    </span><span class="hs-comment">-- NB: If this panic triggers, note that</span><span>
</span><a name="line-2543"></a><span>                                    </span><span class="hs-comment">-- NoStrictnessMark doesn't print!</span><span>
</span><a name="line-2544"></a><span>
</span><a name="line-2545"></a><span>          </span><a name="local-6989586621679789371"><a href="#local-6989586621679789371"><span class="hs-identifier">zap</span></a></a><span> </span><a name="local-6989586621679789381"><a href="#local-6989586621679789381"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621679789382"><a href="#local-6989586621679789382"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setCaseBndrEvald"><span class="hs-identifier hs-var">setCaseBndrEvald</span></a><span> </span><a href="#local-6989586621679789381"><span class="hs-identifier hs-var">str</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-comment">-- Add eval'dness info</span><span>
</span><a name="line-2546"></a><span>                      </span><a href="Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a><span> </span><a href="#local-6989586621679789382"><span class="hs-identifier hs-var">v</span></a><span>         </span><span class="hs-comment">-- And kill occ info;</span><span>
</span><a name="line-2547"></a><span>                                             </span><span class="hs-comment">-- see Note [Case alternative occ info]</span><span>
</span><a name="line-2548"></a><span>
</span><a name="line-2549"></a><span class="hs-identifier">addAltUnfoldings</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2550"></a><a name="addAltUnfoldings"><a href="Simplify.html#addAltUnfoldings"><span class="hs-identifier">addAltUnfoldings</span></a></a><span> </span><a name="local-6989586621679789390"><a href="#local-6989586621679789390"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789391"><a href="#local-6989586621679789391"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789392"><a href="#local-6989586621679789392"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621679789393"><a href="#local-6989586621679789393"><span class="hs-identifier">con_app</span></a></a><span>
</span><a name="line-2551"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789394"><a href="#local-6989586621679789394"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-2552"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789395"><a href="#local-6989586621679789395"><span class="hs-identifier">con_app_unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUnfold.html#mkSimpleUnfolding"><span class="hs-identifier hs-var">mkSimpleUnfolding</span></a><span> </span><a href="#local-6989586621679789394"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679789393"><span class="hs-identifier hs-var">con_app</span></a><span>
</span><a name="line-2553"></a><span>             </span><a name="local-6989586621679789396"><a href="#local-6989586621679789396"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#addBinderUnfolding"><span class="hs-identifier hs-var">addBinderUnfolding</span></a><span> </span><a href="#local-6989586621679789390"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789392"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789395"><span class="hs-identifier hs-var">con_app_unf</span></a><span>
</span><a name="line-2554"></a><span>
</span><a name="line-2555"></a><span>             </span><span class="hs-comment">-- See Note [Add unfolding for scrutinee]</span><span>
</span><a name="line-2556"></a><span>             </span><a name="local-6989586621679789397"><a href="#local-6989586621679789397"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679789391"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2557"></a><span>                      </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679789398"><a href="#local-6989586621679789398"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#addBinderUnfolding"><span class="hs-identifier hs-var">addBinderUnfolding</span></a><span> </span><a href="#local-6989586621679789396"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679789398"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679789395"><span class="hs-identifier hs-var">con_app_unf</span></a><span>
</span><a name="line-2558"></a><span>                      </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679789399"><a href="#local-6989586621679789399"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679789400"><a href="#local-6989586621679789400"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Simplify.html#addBinderUnfolding"><span class="hs-identifier hs-var">addBinderUnfolding</span></a><span> </span><a href="#local-6989586621679789396"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679789399"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2559"></a><span>                                                </span><a href="CoreUnfold.html#mkSimpleUnfolding"><span class="hs-identifier hs-var">mkSimpleUnfolding</span></a><span> </span><a href="#local-6989586621679789394"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a href="#local-6989586621679789393"><span class="hs-identifier hs-var">con_app</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621679789400"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2560"></a><span>                      </span><span class="hs-identifier">_</span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679789396"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-2561"></a><span>
</span><a name="line-2562"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="SimplMonad.html#traceSmpl"><span class="hs-identifier hs-var">traceSmpl</span></a><span> </span><span class="hs-string">&quot;addAltUnf&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789392"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789391"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789393"><span class="hs-identifier hs-var">con_app</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2563"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789397"><span class="hs-identifier hs-var">env2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2564"></a><span>
</span><a name="line-2565"></a><span class="hs-identifier">addBinderUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2566"></a><a name="addBinderUnfolding"><a href="Simplify.html#addBinderUnfolding"><span class="hs-identifier">addBinderUnfolding</span></a></a><span> </span><a name="local-6989586621679789401"><a href="#local-6989586621679789401"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789402"><a href="#local-6989586621679789402"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679789403"><a href="#local-6989586621679789403"><span class="hs-identifier">unf</span></a></a><span>
</span><a name="line-2567"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679789404"><a href="#local-6989586621679789404"><span class="hs-identifier">tmpl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#maybeUnfoldingTemplate"><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span></a><span> </span><a href="#local-6989586621679789403"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-2568"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eqType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">idType</span><span> </span><span class="hs-identifier">bndr</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">exprType</span><span> </span><span class="hs-identifier">tmpl</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-2569"></a><span>          </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">idType</span><span> </span><span class="hs-identifier">bndr</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">tmpl</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">exprType</span><span> </span><span class="hs-identifier">tmpl</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2570"></a><span>    </span><a href="SimplEnv.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a><span> </span><a href="#local-6989586621679789401"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789402"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdUnfolding"><span class="hs-identifier hs-var">setIdUnfolding</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789403"><span class="hs-identifier hs-var">unf</span></a><span class="hs-special">)</span><span>
</span><a name="line-2571"></a><span>
</span><a name="line-2572"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2573"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a><span> </span><a href="#local-6989586621679789401"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789402"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdUnfolding"><span class="hs-identifier hs-var">setIdUnfolding</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789403"><span class="hs-identifier hs-var">unf</span></a><span class="hs-special">)</span><span>
</span><a name="line-2574"></a><span>
</span><a name="line-2575"></a><span class="hs-identifier">zapBndrOccInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-2576"></a><span class="hs-comment">-- Consider  case e of b { (a,b) -&gt; ... }</span><span>
</span><a name="line-2577"></a><span class="hs-comment">-- Then if we bind b to (a,b) in &quot;...&quot;, and b is not dead,</span><span>
</span><a name="line-2578"></a><span class="hs-comment">-- then we must zap the deadness info on a,b</span><span>
</span><a name="line-2579"></a><a name="zapBndrOccInfo"><a href="Simplify.html#zapBndrOccInfo"><span class="hs-identifier">zapBndrOccInfo</span></a></a><span> </span><a name="local-6989586621679789405"><a href="#local-6989586621679789405"><span class="hs-identifier">keep_occ_info</span></a></a><span> </span><a name="local-6989586621679789406"><a href="#local-6989586621679789406"><span class="hs-identifier">pat_id</span></a></a><span>
</span><a name="line-2580"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679789405"><span class="hs-identifier hs-var">keep_occ_info</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789406"><span class="hs-identifier hs-var">pat_id</span></a><span>
</span><a name="line-2581"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a><span> </span><a href="#local-6989586621679789406"><span class="hs-identifier hs-var">pat_id</span></a><span>
</span><a name="line-2582"></a><span>
</span><a name="line-2583"></a><span class="hs-comment">{- Note [Case binder evaluated-ness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We pin on a (OtherCon []) unfolding to the case-binder of a Case,
even though it'll be over-ridden in every case alternative with a more
informative unfolding.  Why?  Because suppose a later, less clever, pass
simply replaces all occurrences of the case binder with the binder itself;
then Lint may complain about the let/app invariant.  Example
    case e of b { DEFAULT -&gt; let v = reallyUnsafePtrEq# b y in ....
                ; K       -&gt; blah }

The let/app invariant requires that y is evaluated in the call to
reallyUnsafePtrEq#, which it is.  But we still want that to be true if we
propagate binders to occurrences.

This showed up in Trac #13027.

Note [Add unfolding for scrutinee]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general it's unlikely that a variable scrutinee will appear
in the case alternatives   case x of { ...x unlikely to appear... }
because the binder-swap in OccAnal has got rid of all such occcurrences
See Note [Binder swap] in OccAnal.

BUT it is still VERY IMPORTANT to add a suitable unfolding for a
variable scrutinee, in simplAlt.  Here's why
   case x of y
     (a,b) -&gt; case b of c
                I# v -&gt; ...(f y)...
There is no occurrence of 'b' in the (...(f y)...).  But y gets
the unfolding (a,b), and *that* mentions b.  If f has a RULE
    RULE f (p, I# q) = ...
we want that rule to match, so we must extend the in-scope env with a
suitable unfolding for 'y'.  It's *essential* for rule matching; but
it's also good for case-elimintation -- suppose that 'f' was inlined
and did multi-level case analysis, then we'd solve it in one
simplifier sweep instead of two.

Exactly the same issue arises in SpecConstr;
see Note [Add scrutinee to ValueEnv too] in SpecConstr

HOWEVER, given
  case x of y { Just a -&gt; r1; Nothing -&gt; r2 }
we do not want to add the unfolding x -&gt; y to 'x', which might seem cool,
since 'y' itself has different unfoldings in r1 and r2.  Reason: if we
did that, we'd have to zap y's deadness info and that is a very useful
piece of information.

So instead we add the unfolding x -&gt; Just a, and x -&gt; Nothing in the
respective RHSs.


************************************************************************
*                                                                      *
\subsection{Known constructor}
*                                                                      *
************************************************************************

We are a bit careful with occurrence info.  Here's an example

        (\x* -&gt; case x of (a*, b) -&gt; f a) (h v, e)

where the * means &quot;occurs once&quot;.  This effectively becomes
        case (h v, e) of (a*, b) -&gt; f a)
and then
        let a* = h v; b = e in f a
and then
        f (h v)

All this should happen in one sweep.
-}</span><span>
</span><a name="line-2653"></a><span>
</span><a name="line-2654"></a><span class="hs-identifier">knownCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2655"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>                             </span><span class="hs-comment">-- The scrutinee</span><span>
</span><a name="line-2656"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#OutType"><span class="hs-identifier hs-type">OutType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- The scrutinee (in pieces)</span><span>
</span><a name="line-2657"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span>          </span><span class="hs-comment">-- The alternative</span><span>
</span><a name="line-2658"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-2659"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2660"></a><span>
</span><a name="line-2661"></a><a name="knownCon"><a href="Simplify.html#knownCon"><span class="hs-identifier">knownCon</span></a></a><span> </span><a name="local-6989586621679789407"><a href="#local-6989586621679789407"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789408"><a href="#local-6989586621679789408"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679789409"><a href="#local-6989586621679789409"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621679789410"><a href="#local-6989586621679789410"><span class="hs-identifier">dc_ty_args</span></a></a><span> </span><a name="local-6989586621679789411"><a href="#local-6989586621679789411"><span class="hs-identifier">dc_args</span></a></a><span> </span><a name="local-6989586621679789412"><a href="#local-6989586621679789412"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679789413"><a href="#local-6989586621679789413"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679789414"><a href="#local-6989586621679789414"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621679789415"><a href="#local-6989586621679789415"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2662"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789440"><a href="#local-6989586621679789440"><span class="hs-identifier">env'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679789417"><span class="hs-identifier hs-var">bind_args</span></a><span> </span><a href="#local-6989586621679789407"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789413"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679789411"><span class="hs-identifier hs-var">dc_args</span></a><span>
</span><a name="line-2663"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789441"><a href="#local-6989586621679789441"><span class="hs-identifier">env''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679789418"><span class="hs-identifier hs-var">bind_case_bndr</span></a><span> </span><a href="#local-6989586621679789440"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-2664"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a><span> </span><a href="#local-6989586621679789441"><span class="hs-identifier hs-var">env''</span></a><span> </span><a href="#local-6989586621679789414"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789415"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2665"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2666"></a><span>    </span><a name="local-6989586621679789416"><a href="#local-6989586621679789416"><span class="hs-identifier">zap_occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#zapBndrOccInfo"><span class="hs-identifier hs-var">zapBndrOccInfo</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621679789412"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- bndr is an InId</span><span>
</span><a name="line-2667"></a><span>
</span><a name="line-2668"></a><span>                  </span><span class="hs-comment">-- Ugh!</span><span>
</span><a name="line-2669"></a><span>    </span><a name="local-6989586621679789417"><a href="#local-6989586621679789417"><span class="hs-identifier">bind_args</span></a></a><span> </span><a name="local-6989586621679789419"><a href="#local-6989586621679789419"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789419"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-2670"></a><span>
</span><a name="line-2671"></a><span>    </span><span class="hs-identifier">bind_args</span><span> </span><a name="local-6989586621679789420"><a href="#local-6989586621679789420"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789421"><a href="#local-6989586621679789421"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789422"><a href="#local-6989586621679789422"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621679789423"><a href="#local-6989586621679789423"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679789424"><a href="#local-6989586621679789424"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2672"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">b</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2673"></a><span>        </span><a href="#local-6989586621679789417"><span class="hs-identifier hs-var">bind_args</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621679789420"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789421"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679789423"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789422"><span class="hs-identifier hs-var">bs'</span></a><span> </span><a href="#local-6989586621679789424"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2674"></a><span>
</span><a name="line-2675"></a><span>    </span><span class="hs-identifier">bind_args</span><span> </span><a name="local-6989586621679789425"><a href="#local-6989586621679789425"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789426"><a href="#local-6989586621679789426"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789427"><a href="#local-6989586621679789427"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621679789428"><a href="#local-6989586621679789428"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679789429"><a href="#local-6989586621679789429"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2676"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">b</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2677"></a><span>        </span><a href="#local-6989586621679789417"><span class="hs-identifier hs-var">bind_args</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><a href="#local-6989586621679789425"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789426"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679789428"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789427"><span class="hs-identifier hs-var">bs'</span></a><span> </span><a href="#local-6989586621679789429"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2678"></a><span>
</span><a name="line-2679"></a><span>    </span><span class="hs-identifier">bind_args</span><span> </span><a name="local-6989586621679789430"><a href="#local-6989586621679789430"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789431"><a href="#local-6989586621679789431"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789432"><a href="#local-6989586621679789432"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789433"><a href="#local-6989586621679789433"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679789434"><a href="#local-6989586621679789434"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2680"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span> </span><span class="hs-identifier hs-var">b</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2681"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789435"><a href="#local-6989586621679789435"><span class="hs-identifier">b'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789416"><span class="hs-identifier hs-var">zap_occ</span></a><span> </span><a href="#local-6989586621679789431"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-2682"></a><span>             </span><span class="hs-comment">-- Note that the binder might be &quot;dead&quot;, because it doesn't</span><span>
</span><a name="line-2683"></a><span>             </span><span class="hs-comment">-- occur in the RHS; and simplNonRecX may therefore discard</span><span>
</span><a name="line-2684"></a><span>             </span><span class="hs-comment">-- it via postInlineUnconditionally.</span><span>
</span><a name="line-2685"></a><span>             </span><span class="hs-comment">-- Nevertheless we must keep it if the case-binder is alive,</span><span>
</span><a name="line-2686"></a><span>             </span><span class="hs-comment">-- because it may be used in the con_app.  See Note [knownCon occ info]</span><span>
</span><a name="line-2687"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789436"><a href="#local-6989586621679789436"><span class="hs-identifier">env''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplNonRecX"><span class="hs-identifier hs-var">simplNonRecX</span></a><span> </span><a href="#local-6989586621679789430"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789435"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621679789433"><span class="hs-identifier hs-var">arg</span></a><span>  </span><span class="hs-comment">-- arg satisfies let/app invariant</span><span>
</span><a name="line-2688"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679789417"><span class="hs-identifier hs-var">bind_args</span></a><span> </span><a href="#local-6989586621679789436"><span class="hs-identifier hs-var">env''</span></a><span> </span><a href="#local-6989586621679789432"><span class="hs-identifier hs-var">bs'</span></a><span> </span><a href="#local-6989586621679789434"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2689"></a><span>
</span><a name="line-2690"></a><span>    </span><span class="hs-identifier">bind_args</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2691"></a><span>      </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;bind_args&quot;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789409"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789413"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789411"><span class="hs-identifier hs-var">dc_args</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-2692"></a><span>                             </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;scrut:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679789408"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2693"></a><span>
</span><a name="line-2694"></a><span>       </span><span class="hs-comment">-- It's useful to bind bndr to scrut, rather than to a fresh</span><span>
</span><a name="line-2695"></a><span>       </span><span class="hs-comment">-- binding      x = Con arg1 .. argn</span><span>
</span><a name="line-2696"></a><span>       </span><span class="hs-comment">-- because very often the scrut is a variable, so we avoid</span><span>
</span><a name="line-2697"></a><span>       </span><span class="hs-comment">-- creating, and then subsequently eliminating, a let-binding</span><span>
</span><a name="line-2698"></a><span>       </span><span class="hs-comment">-- BUT, if scrut is a not a variable, we must be careful</span><span>
</span><a name="line-2699"></a><span>       </span><span class="hs-comment">-- about duplicating the arg redexes; in that case, make</span><span>
</span><a name="line-2700"></a><span>       </span><span class="hs-comment">-- a new con-app from the args</span><span>
</span><a name="line-2701"></a><span>    </span><a name="local-6989586621679789418"><a href="#local-6989586621679789418"><span class="hs-identifier">bind_case_bndr</span></a></a><span> </span><a name="local-6989586621679789437"><a href="#local-6989586621679789437"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-2702"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621679789412"><span class="hs-identifier hs-var">bndr</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789437"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2703"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-6989586621679789408"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><a href="#local-6989586621679789437"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789412"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a><span> </span><a href="#local-6989586621679789408"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2704"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789438"><a href="#local-6989586621679789438"><span class="hs-identifier">dc_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="Simplify.html#simplVar"><span class="hs-identifier hs-var">simplVar</span></a><span> </span><a href="#local-6989586621679789437"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789413"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-2705"></a><span>                                         </span><span class="hs-comment">-- dc_ty_args are aready OutTypes,</span><span>
</span><a name="line-2706"></a><span>                                         </span><span class="hs-comment">-- but bs are InBndrs</span><span>
</span><a name="line-2707"></a><span>                                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789439"><a href="#local-6989586621679789439"><span class="hs-identifier">con_app</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a><span> </span><a href="#local-6989586621679789409"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2708"></a><span>                                                 </span><span class="hs-special">`</span><a href="CoreSyn.html#mkTyApps"><span class="hs-identifier hs-var">mkTyApps</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789410"><span class="hs-identifier hs-var">dc_ty_args</span></a><span>
</span><a name="line-2709"></a><span>                                                 </span><span class="hs-special">`</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">`</span><span>   </span><a href="#local-6989586621679789438"><span class="hs-identifier hs-var">dc_args</span></a><span>
</span><a name="line-2710"></a><span>                                 </span><span class="hs-special">;</span><span> </span><a href="Simplify.html#simplNonRecX"><span class="hs-identifier hs-var">simplNonRecX</span></a><span> </span><a href="#local-6989586621679789437"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789412"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679789439"><span class="hs-identifier hs-var">con_app</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2711"></a><span>
</span><a name="line-2712"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-2713"></a><span class="hs-identifier">missingAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2714"></a><span>                </span><span class="hs-comment">-- This isn't strictly an error, although it is unusual.</span><span>
</span><a name="line-2715"></a><span>                </span><span class="hs-comment">-- It's possible that the simplifier might &quot;see&quot; that</span><span>
</span><a name="line-2716"></a><span>                </span><span class="hs-comment">-- an inner case has no accessible alternatives before</span><span>
</span><a name="line-2717"></a><span>                </span><span class="hs-comment">-- it &quot;sees&quot; that the entire branch of an outer case is</span><span>
</span><a name="line-2718"></a><span>                </span><span class="hs-comment">-- inaccessible.  So we simply put an error case here instead.</span><span>
</span><a name="line-2719"></a><a name="missingAlt"><a href="Simplify.html#missingAlt"><span class="hs-identifier">missingAlt</span></a></a><span> </span><a name="local-6989586621679789442"><a href="#local-6989586621679789442"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789443"><a href="#local-6989586621679789443"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789444"><a href="#local-6989586621679789444"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2720"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;missingAlt&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">case_bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2721"></a><span>    </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><a name="line-2722"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789445"><a href="#local-6989586621679789445"><span class="hs-identifier">cont_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789444"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2723"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><a href="#local-6989586621679789445"><span class="hs-identifier hs-var">cont_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789442"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="MkCore.html#mkImpossibleExpr"><span class="hs-identifier hs-var">mkImpossibleExpr</span></a><span> </span><a href="#local-6989586621679789445"><span class="hs-identifier hs-var">cont_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2724"></a><span>
</span><a name="line-2725"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Duplicating continuations}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2732"></a><span>
</span><a name="line-2733"></a><span class="hs-identifier">prepareCaseCont</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2734"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-2735"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-2736"></a><span>                           </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Dupable part</span><span>
</span><a name="line-2737"></a><span>                           </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Non-dupable part</span><span>
</span><a name="line-2738"></a><span class="hs-comment">-- We are considering</span><span>
</span><a name="line-2739"></a><span class="hs-comment">--     K[case _ of { p1 -&gt; r1; ...; pn -&gt; rn }]</span><span>
</span><a name="line-2740"></a><span class="hs-comment">-- where K is some enclosing continuation for the case</span><span>
</span><a name="line-2741"></a><span class="hs-comment">-- Goal: split K into two pieces Kdup,Knodup so that</span><span>
</span><a name="line-2742"></a><span class="hs-comment">--       a) Kdup can be duplicated</span><span>
</span><a name="line-2743"></a><span class="hs-comment">--       b) Knodup[Kdup[e]] = K[e]</span><span>
</span><a name="line-2744"></a><span class="hs-comment">-- The idea is that we'll transform thus:</span><span>
</span><a name="line-2745"></a><span class="hs-comment">--          Knodup[ (case _ of { p1 -&gt; Kdup[r1]; ...; pn -&gt; Kdup[rn] }</span><span>
</span><a name="line-2746"></a><span class="hs-comment">--</span><span>
</span><a name="line-2747"></a><span class="hs-comment">-- We may also return some extra value bindings in SimplEnv (that scope over</span><span>
</span><a name="line-2748"></a><span class="hs-comment">-- the entire continuation) as well as some join points (thus must *not* float</span><span>
</span><a name="line-2749"></a><span class="hs-comment">-- past the continuation!).</span><span>
</span><a name="line-2750"></a><span class="hs-comment">-- Hence, the full story is this:</span><span>
</span><a name="line-2751"></a><span class="hs-comment">--     K[case _ of { p1 -&gt; r1; ...; pn -&gt; rn }] ==&gt;</span><span>
</span><a name="line-2752"></a><span class="hs-comment">--     F_v[Knodup[F_j[ (case _ of { p1 -&gt; Kdup[r1]; ...; pn -&gt; Kdup[rn] }) ]]]</span><span>
</span><a name="line-2753"></a><span class="hs-comment">-- Here F_v represents some values that got floated out and F_j represents some</span><span>
</span><a name="line-2754"></a><span class="hs-comment">-- join points that got floated out.</span><span>
</span><a name="line-2755"></a><span class="hs-comment">--</span><span>
</span><a name="line-2756"></a><span class="hs-comment">-- When case-of-case is off, just make the entire continuation non-dupable</span><span>
</span><a name="line-2757"></a><span>
</span><a name="line-2758"></a><a name="prepareCaseCont"><a href="Simplify.html#prepareCaseCont"><span class="hs-identifier">prepareCaseCont</span></a></a><span> </span><a name="local-6989586621679789446"><a href="#local-6989586621679789446"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789447"><a href="#local-6989586621679789447"><span class="hs-identifier">alts</span></a></a><span> </span><a name="local-6989586621679789448"><a href="#local-6989586621679789448"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2759"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_case_case</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621679789446"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2760"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789446"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679789448"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789448"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-2761"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Simplify.html#altsWouldDup"><span class="hs-identifier hs-var">altsWouldDup</span></a><span> </span><a href="#local-6989586621679789447"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2762"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789446"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789448"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789448"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2763"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2764"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#mkDupableCont"><span class="hs-identifier hs-var">mkDupableCont</span></a><span> </span><a href="#local-6989586621679789446"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789448"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2765"></a><span>
</span><a name="line-2766"></a><span class="hs-identifier">prepareLetCont</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-2767"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-2768"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-2769"></a><span>                          </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Dupable part</span><span>
</span><a name="line-2770"></a><span>                          </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Non-dupable part</span><span>
</span><a name="line-2771"></a><span>
</span><a name="line-2772"></a><span class="hs-comment">-- Similar to prepareCaseCont, only for</span><span>
</span><a name="line-2773"></a><span class="hs-comment">--     K[let { j1 = r1; ...; jn -&gt; rn } in _]</span><span>
</span><a name="line-2774"></a><span class="hs-comment">-- If the js are join points, this will turn into</span><span>
</span><a name="line-2775"></a><span class="hs-comment">--     Knodup[join { j1 = Kdup[r1]; ...; jn = Kdup[rn] } in Kdup[_]].</span><span>
</span><a name="line-2776"></a><span class="hs-comment">--</span><span>
</span><a name="line-2777"></a><span class="hs-comment">-- When case-of-case is off and it's a join binding, just make the entire</span><span>
</span><a name="line-2778"></a><span class="hs-comment">-- continuation non-dupable. This is necessary because otherwise</span><span>
</span><a name="line-2779"></a><span class="hs-comment">--     case (join j = ... in case e of { A -&gt; jump j 1; ... }) of { B -&gt; ... }</span><span>
</span><a name="line-2780"></a><span class="hs-comment">-- becomes</span><span>
</span><a name="line-2781"></a><span class="hs-comment">--     join j = case ... of { B -&gt; ... } in</span><span>
</span><a name="line-2782"></a><span class="hs-comment">--     case (case e of { A -&gt; jump j 1; ... }) of { B -&gt; ... },</span><span>
</span><a name="line-2783"></a><span class="hs-comment">-- and the reference to j is invalid.</span><span>
</span><a name="line-2784"></a><span>
</span><a name="line-2785"></a><a name="prepareLetCont"><a href="Simplify.html#prepareLetCont"><span class="hs-identifier">prepareLetCont</span></a></a><span> </span><a name="local-6989586621679789449"><a href="#local-6989586621679789449"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789450"><a href="#local-6989586621679789450"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621679789451"><a href="#local-6989586621679789451"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2786"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-6989586621679789450"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2787"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789449"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789451"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789451"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2788"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_case_case</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621679789449"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2789"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789449"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679789451"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789451"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-2790"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2791"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#mkDupableCont"><span class="hs-identifier hs-var">mkDupableCont</span></a><span> </span><a href="#local-6989586621679789449"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789451"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2792"></a><span>
</span><a name="line-2793"></a><span class="hs-comment">-- Predict the result type of the dupable cont returned by prepareLetCont (= the</span><span>
</span><a name="line-2794"></a><span class="hs-comment">-- hole type of the non-dupable part). Ugly, but sadly necessary so that we can</span><span>
</span><a name="line-2795"></a><span class="hs-comment">-- know what the new type of a recursive join point will be before we start</span><span>
</span><a name="line-2796"></a><span class="hs-comment">-- simplifying it.</span><span>
</span><a name="line-2797"></a><span class="hs-identifier">resultTypeOfDupableCont</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreMonad.html#SimplifierMode"><span class="hs-identifier hs-type">SimplifierMode</span></a><span>
</span><a name="line-2798"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">]</span><span>
</span><a name="line-2799"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-2800"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutType"><span class="hs-identifier hs-type">OutType</span></a><span>   </span><span class="hs-comment">-- INVARIANT: Result type of dupable cont</span><span>
</span><a name="line-2801"></a><span>                                     </span><span class="hs-comment">-- returned by prepareLetCont</span><span>
</span><a name="line-2802"></a><span class="hs-comment">-- IMPORTANT: This must be kept in sync with mkDupableCont!</span><span>
</span><a name="line-2803"></a><a name="resultTypeOfDupableCont"><a href="Simplify.html#resultTypeOfDupableCont"><span class="hs-identifier">resultTypeOfDupableCont</span></a></a><span> </span><a name="local-6989586621679789452"><a href="#local-6989586621679789452"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679789453"><a href="#local-6989586621679789453"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621679789454"><a href="#local-6989586621679789454"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2804"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a><span> </span><a href="#local-6989586621679789453"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789454"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2805"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_case_case</span><span> </span><a href="#local-6989586621679789452"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span>   </span><a href="#local-6989586621679789454"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2806"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789455"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789454"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2807"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2808"></a><span>    </span><a name="local-6989586621679789455"><a href="#local-6989586621679789455"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679789456"><a href="#local-6989586621679789456"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a><span> </span><a href="#local-6989586621679789456"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789456"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2809"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;typeOfDupableCont&quot;</span><span> </span><span class="hs-comment">-- Handled by previous eqn</span><span>
</span><a name="line-2810"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><span class="hs-identifier">_</span><span>  </span><a name="local-6989586621679789457"><a href="#local-6989586621679789457"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789455"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789457"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2811"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679789458"><a href="#local-6989586621679789458"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679789458"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2812"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679789459"><a href="#local-6989586621679789459"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679789459"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2813"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679789460"><a href="#local-6989586621679789460"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789455"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789460"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2814"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679789461"><a href="#local-6989586621679789461"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789455"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sc_cont</span><span> </span><a href="#local-6989586621679789461"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-2815"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679789462"><a href="#local-6989586621679789462"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789455"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sc_cont</span><span> </span><a href="#local-6989586621679789462"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-2816"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789463"><a href="#local-6989586621679789463"><span class="hs-identifier">alts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789464"><a href="#local-6989586621679789464"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2817"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_case_case</span><span> </span><a href="#local-6989586621679789452"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679789464"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2818"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Simplify.html#altsWouldDup"><span class="hs-identifier hs-var">altsWouldDup</span></a><span> </span><a href="#local-6989586621679789463"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789464"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2819"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789455"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789464"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2820"></a><span>
</span><a name="line-2821"></a><span class="hs-identifier">altsWouldDup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- True iff strictly &gt; 1 non-bottom alternative</span><span>
</span><a name="line-2822"></a><a name="altsWouldDup"><a href="Simplify.html#altsWouldDup"><span class="hs-identifier">altsWouldDup</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>        </span><span class="hs-comment">-- See Note [Bottom alternatives]</span><span>
</span><a name="line-2823"></a><span class="hs-identifier">altsWouldDup</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2824"></a><span class="hs-identifier">altsWouldDup</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789465"><a href="#local-6989586621679789465"><span class="hs-identifier">alt</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789466"><a href="#local-6989586621679789466"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2825"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679789467"><span class="hs-identifier hs-var">is_bot_alt</span></a><span> </span><a href="#local-6989586621679789465"><span class="hs-identifier hs-var">alt</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#altsWouldDup"><span class="hs-identifier hs-var">altsWouldDup</span></a><span> </span><a href="#local-6989586621679789466"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2826"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="#local-6989586621679789467"><span class="hs-identifier hs-var">is_bot_alt</span></a><span> </span><a href="#local-6989586621679789466"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2827"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2828"></a><span>    </span><a name="local-6989586621679789467"><a href="#local-6989586621679789467"><span class="hs-identifier">is_bot_alt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679789468"><a href="#local-6989586621679789468"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsBottom"><span class="hs-identifier hs-var">exprIsBottom</span></a><span> </span><a href="#local-6989586621679789468"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2829"></a><span>
</span><a name="line-2830"></a><span class="hs-comment">{-
Note [Bottom alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~
When we have
     case (case x of { A -&gt; error .. ; B -&gt; e; C -&gt; error ..)
       of alts
then we can just duplicate those alts because the A and C cases
will disappear immediately.  This is more direct than creating
join points and inlining them away.  See Trac #4930.
-}</span><span>
</span><a name="line-2840"></a><span>
</span><a name="line-2841"></a><span class="hs-identifier">mkDupableCont</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-2842"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">)</span><span>
</span><a name="line-2843"></a><span>
</span><a name="line-2844"></a><a name="mkDupableCont"><a href="Simplify.html#mkDupableCont"><span class="hs-identifier">mkDupableCont</span></a></a><span> </span><a name="local-6989586621679789469"><a href="#local-6989586621679789469"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789470"><a href="#local-6989586621679789470"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-2845"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a><span> </span><a href="#local-6989586621679789470"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2846"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789469"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789470"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621679789470"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2847"></a><span>
</span><a name="line-2848"></a><span class="hs-identifier">mkDupableCont</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkDupableCont&quot;</span><span>     </span><span class="hs-comment">-- Handled by previous eqn</span><span>
</span><a name="line-2849"></a><span>
</span><a name="line-2850"></a><span class="hs-identifier">mkDupableCont</span><span> </span><a name="local-6989586621679789471"><a href="#local-6989586621679789471"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a name="local-6989586621679789472"><a href="#local-6989586621679789472"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679789473"><a href="#local-6989586621679789473"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2851"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789474"><a href="#local-6989586621679789474"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789475"><a href="#local-6989586621679789475"><span class="hs-identifier">dup</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789476"><a href="#local-6989586621679789476"><span class="hs-identifier">nodup</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#mkDupableCont"><span class="hs-identifier hs-var">mkDupableCont</span></a><span> </span><a href="#local-6989586621679789471"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789473"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2852"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789474"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a href="#local-6989586621679789472"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621679789475"><span class="hs-identifier hs-var">dup</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789476"><span class="hs-identifier hs-var">nodup</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2853"></a><span>
</span><a name="line-2854"></a><span class="hs-comment">-- Duplicating ticks for now, not sure if this is good or not</span><span>
</span><a name="line-2855"></a><span class="hs-identifier">mkDupableCont</span><span> </span><a name="local-6989586621679789477"><a href="#local-6989586621679789477"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789478"><a href="#local-6989586621679789478"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2856"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789477"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679789478"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789478"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-2857"></a><span>
</span><a name="line-2858"></a><span class="hs-identifier">mkDupableCont</span><span> </span><a name="local-6989586621679789479"><a href="#local-6989586621679789479"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789480"><a href="#local-6989586621679789480"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2859"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789479"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679789480"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789480"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-2860"></a><span>        </span><span class="hs-comment">-- See Note [Duplicating StrictBind]</span><span>
</span><a name="line-2861"></a><span>
</span><a name="line-2862"></a><span class="hs-identifier">mkDupableCont</span><span> </span><a name="local-6989586621679789481"><a href="#local-6989586621679789481"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><a name="local-6989586621679789482"><a href="#local-6989586621679789482"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621679789483"><a href="#local-6989586621679789483"><span class="hs-identifier">cci</span></a></a><span> </span><a name="local-6989586621679789484"><a href="#local-6989586621679789484"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2863"></a><span>        </span><span class="hs-comment">-- See Note [Duplicating StrictArg]</span><span>
</span><a name="line-2864"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789485"><a href="#local-6989586621679789485"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789486"><a href="#local-6989586621679789486"><span class="hs-identifier">dup</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789487"><a href="#local-6989586621679789487"><span class="hs-identifier">nodup</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#mkDupableCont"><span class="hs-identifier hs-var">mkDupableCont</span></a><span> </span><a href="#local-6989586621679789481"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789484"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2865"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789488"><a href="#local-6989586621679789488"><span class="hs-identifier">env''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789489"><a href="#local-6989586621679789489"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a><span> </span><a href="Simplify.html#makeTrivialArg"><span class="hs-identifier hs-var">makeTrivialArg</span></a><span> </span><a href="#local-6989586621679789485"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ai_args</span><span> </span><a href="#local-6989586621679789482"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-2866"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789488"><span class="hs-identifier hs-var">env''</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789482"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789489"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789483"><span class="hs-identifier hs-var">cci</span></a><span> </span><a href="#local-6989586621679789486"><span class="hs-identifier hs-var">dup</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789487"><span class="hs-identifier hs-var">nodup</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2867"></a><span>
</span><a name="line-2868"></a><span class="hs-identifier">mkDupableCont</span><span> </span><a name="local-6989586621679789490"><a href="#local-6989586621679789490"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789491"><a href="#local-6989586621679789491"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789492"><a href="#local-6989586621679789492"><span class="hs-identifier">tail</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2869"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789493"><a href="#local-6989586621679789493"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789494"><a href="#local-6989586621679789494"><span class="hs-identifier">dup_cont</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789495"><a href="#local-6989586621679789495"><span class="hs-identifier">nodup_cont</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#mkDupableCont"><span class="hs-identifier hs-var">mkDupableCont</span></a><span> </span><a href="#local-6989586621679789490"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789492"><span class="hs-identifier hs-var">tail</span></a><span>
</span><a name="line-2870"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789493"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789491"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789494"><span class="hs-identifier hs-var">dup_cont</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789495"><span class="hs-identifier hs-var">nodup_cont</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2871"></a><span>
</span><a name="line-2872"></a><span class="hs-identifier">mkDupableCont</span><span> </span><a name="local-6989586621679789496"><a href="#local-6989586621679789496"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789497"><a href="#local-6989586621679789497"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789498"><a href="#local-6989586621679789498"><span class="hs-identifier">dup</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789499"><a href="#local-6989586621679789499"><span class="hs-identifier">se</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789500"><a href="#local-6989586621679789500"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2873"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- e.g.         [...hole...] (...arg...)</span><span>
</span><a name="line-2874"></a><span>        </span><span class="hs-comment">--      ==&gt;</span><span>
</span><a name="line-2875"></a><span>        </span><span class="hs-comment">--              let a = ...arg...</span><span>
</span><a name="line-2876"></a><span>        </span><span class="hs-comment">--              in [...hole...] a</span><span>
</span><a name="line-2877"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789501"><a href="#local-6989586621679789501"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789502"><a href="#local-6989586621679789502"><span class="hs-identifier">dup_cont</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789503"><a href="#local-6989586621679789503"><span class="hs-identifier">nodup_cont</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#mkDupableCont"><span class="hs-identifier hs-var">mkDupableCont</span></a><span> </span><a href="#local-6989586621679789496"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789500"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2878"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679789504"><a href="#local-6989586621679789504"><span class="hs-identifier">se'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789505"><a href="#local-6989586621679789505"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplArg"><span class="hs-identifier hs-var">simplArg</span></a><span> </span><a href="#local-6989586621679789501"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789498"><span class="hs-identifier hs-var">dup</span></a><span> </span><a href="#local-6989586621679789499"><span class="hs-identifier hs-var">se</span></a><span> </span><a href="#local-6989586621679789497"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-2879"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789506"><a href="#local-6989586621679789506"><span class="hs-identifier">env''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789507"><a href="#local-6989586621679789507"><span class="hs-identifier">arg''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#makeTrivial"><span class="hs-identifier hs-var">makeTrivial</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="#local-6989586621679789501"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;karg&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789505"><span class="hs-identifier hs-var">arg'</span></a><span>
</span><a name="line-2880"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789508"><a href="#local-6989586621679789508"><span class="hs-identifier">app_cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789507"><span class="hs-identifier hs-var">arg''</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789504"><span class="hs-identifier hs-var">se'</span></a><span>
</span><a name="line-2881"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789502"><span class="hs-identifier hs-var">dup_cont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2882"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789506"><span class="hs-identifier hs-var">env''</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789508"><span class="hs-identifier hs-var">app_cont</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789503"><span class="hs-identifier hs-var">nodup_cont</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2883"></a><span>
</span><a name="line-2884"></a><span class="hs-identifier">mkDupableCont</span><span> </span><a name="local-6989586621679789509"><a href="#local-6989586621679789509"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789510"><a href="#local-6989586621679789510"><span class="hs-identifier">case_bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789511"><a href="#local-6989586621679789511"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-2885"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789512"><a href="#local-6989586621679789512"><span class="hs-identifier">se</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789513"><a href="#local-6989586621679789513"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2886"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- e.g.         (case [...hole...] of { pi -&gt; ei })</span><span>
</span><a name="line-2887"></a><span>        </span><span class="hs-comment">--      ===&gt;</span><span>
</span><a name="line-2888"></a><span>        </span><span class="hs-comment">--              let ji = \xij -&gt; ei</span><span>
</span><a name="line-2889"></a><span>        </span><span class="hs-comment">--              in case [...hole...] of { pi -&gt; ji xij }</span><span>
</span><a name="line-2890"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreMonad.html#CaseOfCase"><span class="hs-identifier hs-var">CaseOfCase</span></a><span> </span><a href="#local-6989586621679789510"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2891"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789514"><a href="#local-6989586621679789514"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789515"><a href="#local-6989586621679789515"><span class="hs-identifier">dup_cont</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789516"><a href="#local-6989586621679789516"><span class="hs-identifier">nodup_cont</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#prepareCaseCont"><span class="hs-identifier hs-var">prepareCaseCont</span></a><span> </span><a href="#local-6989586621679789509"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789511"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="#local-6989586621679789513"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-2892"></a><span>                </span><span class="hs-comment">-- NB: We call prepareCaseCont here.  If there is only one</span><span>
</span><a name="line-2893"></a><span>                </span><span class="hs-comment">-- alternative, then dup_cont may be big, but that's ok</span><span>
</span><a name="line-2894"></a><span>                </span><span class="hs-comment">-- because we push it into the single alternative, and then</span><span>
</span><a name="line-2895"></a><span>                </span><span class="hs-comment">-- use mkDupableAlt to turn that simplified alternative into</span><span>
</span><a name="line-2896"></a><span>                </span><span class="hs-comment">-- a join point if it's too big to duplicate.</span><span>
</span><a name="line-2897"></a><span>                </span><span class="hs-comment">-- And this is important: see Note [Fusing case continuations]</span><span>
</span><a name="line-2898"></a><span>
</span><a name="line-2899"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789517"><a href="#local-6989586621679789517"><span class="hs-identifier">alt_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789512"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#setInScopeAndZapFloats"><span class="hs-identifier hs-var">setInScopeAndZapFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789514"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-2900"></a><span>
</span><a name="line-2901"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789518"><a href="#local-6989586621679789518"><span class="hs-identifier">alt_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789519"><a href="#local-6989586621679789519"><span class="hs-identifier">case_bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a><span> </span><a href="#local-6989586621679789517"><span class="hs-identifier hs-var">alt_env</span></a><span> </span><a href="#local-6989586621679789510"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-2902"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789520"><a href="#local-6989586621679789520"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="Simplify.html#simplAlt"><span class="hs-identifier hs-var">simplAlt</span></a><span> </span><a href="#local-6989586621679789518"><span class="hs-identifier hs-var">alt_env'</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679789519"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621679789515"><span class="hs-identifier hs-var">dup_cont</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789511"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2903"></a><span>        </span><span class="hs-comment">-- Safe to say that there are no handled-cons for the DEFAULT case</span><span>
</span><a name="line-2904"></a><span>                </span><span class="hs-comment">-- NB: simplBinder does not zap deadness occ-info, so</span><span>
</span><a name="line-2905"></a><span>                </span><span class="hs-comment">-- a dead case_bndr' will still advertise its deadness</span><span>
</span><a name="line-2906"></a><span>                </span><span class="hs-comment">-- This is really important because in</span><span>
</span><a name="line-2907"></a><span>                </span><span class="hs-comment">--      case e of b { (# p,q #) -&gt; ... }</span><span>
</span><a name="line-2908"></a><span>                </span><span class="hs-comment">-- b is always dead, and indeed we are not allowed to bind b to (# p,q #),</span><span>
</span><a name="line-2909"></a><span>                </span><span class="hs-comment">-- which might happen if e was an explicit unboxed pair and b wasn't marked dead.</span><span>
</span><a name="line-2910"></a><span>                </span><span class="hs-comment">-- In the new alts we build, we have the new case binder, so it must retain</span><span>
</span><a name="line-2911"></a><span>                </span><span class="hs-comment">-- its deadness.</span><span>
</span><a name="line-2912"></a><span>        </span><span class="hs-comment">-- NB: we don't use alt_env further; it has the substEnv for</span><span>
</span><a name="line-2913"></a><span>        </span><span class="hs-comment">--     the alternatives, and we don't want that</span><span>
</span><a name="line-2914"></a><span>
</span><a name="line-2915"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789521"><a href="#local-6989586621679789521"><span class="hs-identifier">env''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789522"><a href="#local-6989586621679789522"><span class="hs-identifier">alts''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#mkDupableAlts"><span class="hs-identifier hs-var">mkDupableAlts</span></a><span> </span><a href="#local-6989586621679789514"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679789519"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621679789520"><span class="hs-identifier hs-var">alts'</span></a><span>
</span><a name="line-2916"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789521"><span class="hs-identifier hs-var">env''</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Note [Duplicated env]</span><span>
</span><a name="line-2917"></a><span>                  </span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a><span>
</span><a name="line-2918"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789519"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789522"><span class="hs-identifier hs-var">alts''</span></a><span>
</span><a name="line-2919"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span> </span><a href="#local-6989586621679789521"><span class="hs-identifier hs-var">env''</span></a><span>
</span><a name="line-2920"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621679789516"><span class="hs-identifier hs-var">nodup_cont</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-2921"></a><span>                  </span><a href="#local-6989586621679789516"><span class="hs-identifier hs-var">nodup_cont</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2922"></a><span>
</span><a name="line-2923"></a><span>
</span><a name="line-2924"></a><span class="hs-identifier">mkDupableAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-2925"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2926"></a><span class="hs-comment">-- Absorbs the continuation into the new alternatives</span><span>
</span><a name="line-2927"></a><span>
</span><a name="line-2928"></a><a name="mkDupableAlts"><a href="Simplify.html#mkDupableAlts"><span class="hs-identifier">mkDupableAlts</span></a></a><span> </span><a name="local-6989586621679789523"><a href="#local-6989586621679789523"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789524"><a href="#local-6989586621679789524"><span class="hs-identifier">case_bndr'</span></a></a><span> </span><a name="local-6989586621679789525"><a href="#local-6989586621679789525"><span class="hs-identifier">the_alts</span></a></a><span>
</span><a name="line-2929"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789526"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789523"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789525"><span class="hs-identifier hs-var">the_alts</span></a><span>
</span><a name="line-2930"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2931"></a><span>    </span><a name="local-6989586621679789526"><a href="#local-6989586621679789526"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679789527"><a href="#local-6989586621679789527"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789527"><span class="hs-identifier hs-var">env0</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2932"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679789528"><a href="#local-6989586621679789528"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789529"><a href="#local-6989586621679789529"><span class="hs-identifier">alt</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679789530"><a href="#local-6989586621679789530"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2933"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789531"><a href="#local-6989586621679789531"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789532"><a href="#local-6989586621679789532"><span class="hs-identifier">alt'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#mkDupableAlt"><span class="hs-identifier hs-var">mkDupableAlt</span></a><span> </span><a href="#local-6989586621679789528"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621679789524"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621679789529"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-2934"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789533"><a href="#local-6989586621679789533"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789534"><a href="#local-6989586621679789534"><span class="hs-identifier">alts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679789526"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679789531"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679789530"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2935"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789533"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789532"><span class="hs-identifier hs-var">alt'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679789534"><span class="hs-identifier hs-var">alts'</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2936"></a><span>
</span><a name="line-2937"></a><span class="hs-identifier">mkDupableAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2938"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2939"></a><a name="mkDupableAlt"><a href="Simplify.html#mkDupableAlt"><span class="hs-identifier">mkDupableAlt</span></a></a><span> </span><a name="local-6989586621679789535"><a href="#local-6989586621679789535"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789536"><a href="#local-6989586621679789536"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679789537"><a href="#local-6989586621679789537"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789538"><a href="#local-6989586621679789538"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789539"><a href="#local-6989586621679789539"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2940"></a><span>  </span><a name="local-6989586621679789540"><a href="#local-6989586621679789540"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-2941"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="CoreUtils.html#exprIsDupable"><span class="hs-identifier hs-var">exprIsDupable</span></a><span> </span><a href="#local-6989586621679789540"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679789539"><span class="hs-identifier hs-var">rhs'</span></a><span>  </span><span class="hs-comment">-- Note [Small alternative rhs]</span><span>
</span><a name="line-2942"></a><span>   </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789535"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789537"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789538"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789539"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2943"></a><span>   </span><span class="hs-keyword">else</span><span>
</span><a name="line-2944"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789541"><a href="#local-6989586621679789541"><span class="hs-identifier">rhs_ty'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621679789539"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-2945"></a><span>              </span><a name="local-6989586621679789542"><a href="#local-6989586621679789542"><span class="hs-identifier">scrut_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621679789536"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-2946"></a><span>              </span><a name="local-6989586621679789543"><a href="#local-6989586621679789543"><span class="hs-identifier">case_bndr_w_unf</span></a></a><span>
</span><a name="line-2947"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679789537"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2948"></a><span>                      </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679789536"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-2949"></a><span>                      </span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-6989586621679789547"><a href="#local-6989586621679789547"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Id.html#setIdUnfolding"><span class="hs-identifier hs-var">setIdUnfolding</span></a><span> </span><a href="#local-6989586621679789536"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679789548"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-2950"></a><span>                          </span><span class="hs-keyword">where</span><span>
</span><a name="line-2951"></a><span>                                 </span><span class="hs-comment">-- See Note [Case binders and join points]</span><span>
</span><a name="line-2952"></a><span>                             </span><a name="local-6989586621679789548"><a href="#local-6989586621679789548"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUnfold.html#mkInlineUnfolding"><span class="hs-identifier hs-var">mkInlineUnfolding</span></a><span> </span><a href="#local-6989586621679789549"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2953"></a><span>                             </span><a name="local-6989586621679789549"><a href="#local-6989586621679789549"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkConApp2"><span class="hs-identifier hs-var">mkConApp2</span></a><span> </span><a href="#local-6989586621679789547"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a><span> </span><a href="#local-6989586621679789542"><span class="hs-identifier hs-var">scrut_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789538"><span class="hs-identifier hs-var">bndrs'</span></a><span>
</span><a name="line-2954"></a><span>
</span><a name="line-2955"></a><span>                      </span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;mkDupableAlt&quot;</span><span>
</span><a name="line-2956"></a><span>                                                </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">case_bndr</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">con</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2957"></a><span>                                   </span><a href="#local-6989586621679789536"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-2958"></a><span>                           </span><span class="hs-comment">-- The case binder is alive but trivial, so why has</span><span>
</span><a name="line-2959"></a><span>                           </span><span class="hs-comment">-- it not been substituted away?</span><span>
</span><a name="line-2960"></a><span>
</span><a name="line-2961"></a><span>              </span><a name="local-6989586621679789544"><a href="#local-6989586621679789544"><span class="hs-identifier">final_bndrs'</span></a></a><span>
</span><a name="line-2962"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621679789536"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="#local-6989586621679789545"><span class="hs-identifier hs-var">abstract_over</span></a><span> </span><a href="#local-6989586621679789538"><span class="hs-identifier hs-var">bndrs'</span></a><span>
</span><a name="line-2963"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789538"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679789543"><span class="hs-identifier hs-var">case_bndr_w_unf</span></a><span class="hs-special">]</span><span>
</span><a name="line-2964"></a><span>
</span><a name="line-2965"></a><span>              </span><a name="local-6989586621679789545"><a href="#local-6989586621679789545"><span class="hs-identifier">abstract_over</span></a></a><span> </span><a name="local-6989586621679789550"><a href="#local-6989586621679789550"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-2966"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621679789550"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- Abstract over all type variables just in case</span><span>
</span><a name="line-2967"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621679789550"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2968"></a><span>                        </span><span class="hs-comment">-- The deadness info on the new Ids is preserved by simplBinders</span><span>
</span><a name="line-2969"></a><span>              </span><a name="local-6989586621679789546"><a href="#local-6989586621679789546"><span class="hs-identifier">final_args</span></a></a><span>    </span><span class="hs-comment">-- Note [Join point abstraction]</span><span>
</span><a name="line-2970"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#varsToCoreExprs"><span class="hs-identifier hs-var">varsToCoreExprs</span></a><span> </span><a href="#local-6989586621679789544"><span class="hs-identifier hs-var">final_bndrs'</span></a><span>
</span><a name="line-2971"></a><span>
</span><a name="line-2972"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789551"><a href="#local-6989586621679789551"><span class="hs-identifier">join_bndr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplMonad.html#newId"><span class="hs-identifier hs-var">newId</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;$j&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Type.html#mkLamTypes"><span class="hs-identifier hs-var">mkLamTypes</span></a><span> </span><a href="#local-6989586621679789544"><span class="hs-identifier hs-var">final_bndrs'</span></a><span> </span><a href="#local-6989586621679789541"><span class="hs-identifier hs-var">rhs_ty'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2973"></a><span>                </span><span class="hs-comment">-- Note [Funky mkLamTypes]</span><span>
</span><a name="line-2974"></a><span>
</span><a name="line-2975"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><span class="hs-comment">-- We make the lambdas into one-shot-lambdas.  The</span><span>
</span><a name="line-2976"></a><span>                </span><span class="hs-comment">-- join point is sure to be applied at most once, and doing so</span><span>
</span><a name="line-2977"></a><span>                </span><span class="hs-comment">-- prevents the body of the join point being floated out by</span><span>
</span><a name="line-2978"></a><span>                </span><span class="hs-comment">-- the full laziness pass</span><span>
</span><a name="line-2979"></a><span>                </span><a name="local-6989586621679789552"><a href="#local-6989586621679789552"><span class="hs-identifier">really_final_bndrs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621679789553"><span class="hs-identifier hs-var">one_shot</span></a><span> </span><a href="#local-6989586621679789544"><span class="hs-identifier hs-var">final_bndrs'</span></a><span>
</span><a name="line-2980"></a><span>                </span><a name="local-6989586621679789553"><a href="#local-6989586621679789553"><span class="hs-identifier">one_shot</span></a></a><span> </span><a name="local-6989586621679789560"><a href="#local-6989586621679789560"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621679789560"><span class="hs-identifier hs-var">v</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setOneShotLambda"><span class="hs-identifier hs-var">setOneShotLambda</span></a><span> </span><a href="#local-6989586621679789560"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-2981"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789560"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-2982"></a><span>                </span><a name="local-6989586621679789554"><a href="#local-6989586621679789554"><span class="hs-identifier">join_rhs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621679789552"><span class="hs-identifier hs-var">really_final_bndrs</span></a><span> </span><a href="#local-6989586621679789539"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-2983"></a><span>                </span><a name="local-6989586621679789555"><a href="#local-6989586621679789555"><span class="hs-identifier">arity</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789544"><span class="hs-identifier hs-var">final_bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2984"></a><span>                </span><a name="local-6989586621679789556"><a href="#local-6989586621679789556"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621679789544"><span class="hs-identifier hs-var">final_bndrs'</span></a><span>
</span><a name="line-2985"></a><span>                </span><a name="local-6989586621679789557"><a href="#local-6989586621679789557"><span class="hs-identifier">final_join_bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789551"><span class="hs-identifier hs-var">join_bndr</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdArity"><span class="hs-identifier hs-var">setIdArity</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789555"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-2986"></a><span>                                    </span><span class="hs-special">`</span><a href="Id.html#asJoinId"><span class="hs-identifier hs-var">asJoinId</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789556"><span class="hs-identifier hs-var">join_arity</span></a><span>
</span><a name="line-2987"></a><span>                </span><a name="local-6989586621679789558"><a href="#local-6989586621679789558"><span class="hs-identifier">join_call</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621679789557"><span class="hs-identifier hs-var">final_join_bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789546"><span class="hs-identifier hs-var">final_args</span></a><span>
</span><a name="line-2988"></a><span>                </span><a name="local-6989586621679789559"><a href="#local-6989586621679789559"><span class="hs-identifier">final_join_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621679789557"><span class="hs-identifier hs-var">final_join_bndr</span></a><span> </span><a href="#local-6989586621679789554"><span class="hs-identifier hs-var">join_rhs</span></a><span>
</span><a name="line-2989"></a><span>
</span><a name="line-2990"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789561"><a href="#local-6989586621679789561"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#addPolyBind"><span class="hs-identifier hs-var">addPolyBind</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a href="#local-6989586621679789535"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789559"><span class="hs-identifier hs-var">final_join_bind</span></a><span>
</span><a name="line-2991"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789561"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789537"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789538"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789558"><span class="hs-identifier hs-var">join_call</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2992"></a><span>                </span><span class="hs-comment">-- See Note [Duplicated env]</span><span>
</span><a name="line-2993"></a><span>
</span><a name="line-2994"></a><span class="hs-comment">{-
Note [Fusing case continuations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's important to fuse two successive case continuations when the
first has one alternative.  That's why we call prepareCaseCont here.
Consider this, which arises from thunk splitting (see Note [Thunk
splitting] in WorkWrap):

      let
        x* = case (case v of {pn -&gt; rn}) of
               I# a -&gt; I# a
      in body

The simplifier will find
    (Var v) with continuation
            Select (pn -&gt; rn) (
            Select [I# a -&gt; I# a] (
            StrictBind body Stop

So we'll call mkDupableCont on
   Select [I# a -&gt; I# a] (StrictBind body Stop)
There is just one alternative in the first Select, so we want to
simplify the rhs (I# a) with continuation (StricgtBind body Stop)
Supposing that body is big, we end up with
          let $j a = &lt;let x = I# a in body&gt;
          in case v of { pn -&gt; case rn of
                                 I# a -&gt; $j a }
This is just what we want because the rn produces a box that
the case rn cancels with.

See Trac #4957 a fuller example.

Note [Case binders and join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
   case (case .. ) of c {
     I# c# -&gt; ....c....

If we make a join point with c but not c# we get
  $j = \c -&gt; ....c....

But if later inlining scrutinises the c, thus

  $j = \c -&gt; ... case c of { I# y -&gt; ... } ...

we won't see that 'c' has already been scrutinised.  This actually
happens in the 'tabulate' function in wave4main, and makes a significant
difference to allocation.

An alternative plan is this:

   $j = \c# -&gt; let c = I# c# in ...c....

but that is bad if 'c' is *not* later scrutinised.

So instead we do both: we pass 'c' and 'c#' , and record in c's inlining
(a stable unfolding) that it's really I# c#, thus

   $j = \c# -&gt; \c[=I# c#] -&gt; ...c....

Absence analysis may later discard 'c'.

NB: take great care when doing strictness analysis;
    see Note [Lambda-bound unfoldings] in DmdAnal.

Also note that we can still end up passing stuff that isn't used.  Before
strictness analysis we have
   let $j x y c{=(x,y)} = (h c, ...)
   in ...
After strictness analysis we see that h is strict, we end up with
   let $j x y c{=(x,y)} = ($wh x y, ...)
and c is unused.

Note [Duplicated env]
~~~~~~~~~~~~~~~~~~~~~
Some of the alternatives are simplified, but have not been turned into a join point
So they *must* have an zapped subst-env.  So we can't use completeNonRecX to
bind the join point, because it might to do PostInlineUnconditionally, and
we'd lose that when zapping the subst-env.  We could have a per-alt subst-env,
but zapping it (as we do in mkDupableCont, the Select case) is safe, and
at worst delays the join-point inlining.

Note [Small alternative rhs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It is worth checking for a small RHS because otherwise we
get extra let bindings that may cause an extra iteration of the simplifier to
inline back in place.  Quite often the rhs is just a variable or constructor.
The Ord instance of Maybe in PrelMaybe.hs, for example, took several extra
iterations because the version with the let bindings looked big, and so wasn't
inlined, but after the join points had been inlined it looked smaller, and so
was inlined.

NB: we have to check the size of rhs', not rhs.
Duplicating a small InAlt might invalidate occurrence information
However, if it *is* dupable, we return the *un* simplified alternative,
because otherwise we'd need to pair it up with an empty subst-env....
but we only have one env shared between all the alts.
(Remember we must zap the subst-env before re-simplifying something).
Rather than do this we simply agree to re-simplify the original (small) thing later.

Note [Funky mkLamTypes]
~~~~~~~~~~~~~~~~~~~~~~
Notice the funky mkLamTypes.  If the constructor has existentials
it's possible that the join point will be abstracted over
type variables as well as term variables.
 Example:  Suppose we have
        data T = forall t.  C [t]
 Then faced with
        case (case e of ...) of
            C t xs::[t] -&gt; rhs
 We get the join point
        let j :: forall t. [t] -&gt; ...
            j = /\t \xs::[t] -&gt; rhs
        in
        case (case e of ...) of
            C t xs::[t] -&gt; j t xs

Note [Join point abstraction]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

NB: This note is now historical. Now that &quot;join point&quot; is not a fuzzy concept
but a formal syntactic construct (as distinguished by the JoinId constructor of
IdDetails), each of these concerns is handled separately, with no need for a
vestigial extra argument.

Join points always have at least one value argument,
for several reasons

* If we try to lift a primitive-typed something out
  for let-binding-purposes, we will *caseify* it (!),
  with potentially-disastrous strictness results.  So
  instead we turn it into a function: \v -&gt; e
  where v::Void#.  The value passed to this function is void,
  which generates (almost) no code.

* CPR.  We used to say &quot;&amp;&amp; isUnliftedType rhs_ty'&quot; here, but now
  we make the join point into a function whenever used_bndrs'
  is empty.  This makes the join-point more CPR friendly.
  Consider:       let j = if .. then I# 3 else I# 4
                  in case .. of { A -&gt; j; B -&gt; j; C -&gt; ... }

  Now CPR doesn't w/w j because it's a thunk, so
  that means that the enclosing function can't w/w either,
  which is a lose.  Here's the example that happened in practice:
          kgmod :: Int -&gt; Int -&gt; Int
          kgmod x y = if x &gt; 0 &amp;&amp; y &lt; 0 || x &lt; 0 &amp;&amp; y &gt; 0
                      then 78
                      else 5

* Let-no-escape.  We want a join point to turn into a let-no-escape
  so that it is implemented as a jump, and one of the conditions
  for LNE is that it's not updatable.  In CoreToStg, see
  Note [What is a non-escaping let]

* Floating.  Since a join point will be entered once, no sharing is
  gained by floating out, but something might be lost by doing
  so because it might be allocated.

I have seen a case alternative like this:
        True -&gt; \v -&gt; ...
It's a bit silly to add the realWorld dummy arg in this case, making
        $j = \s v -&gt; ...
           True -&gt; $j s
(the \v alone is enough to make CPR happy) but I think it's rare

There's a slight infelicity here: we pass the overall
case_bndr to all the join points if it's used in *any* RHS,
because we don't know its usage in each RHS separately


Note [Duplicating StrictArg]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The original plan had (where E is a big argument)
e.g.    f E [..hole..]
        ==&gt;     let $j = \a -&gt; f E a
                in $j [..hole..]

But this is terrible! Here's an example:
        &amp;&amp; E (case x of { T -&gt; F; F -&gt; T })
Now, &amp;&amp; is strict so we end up simplifying the case with

an ArgOf continuation.  If we let-bind it, we get
        let $j = \v -&gt; &amp;&amp; E v
        in simplExpr (case x of { T -&gt; F; F -&gt; T })
                     (ArgOf (\r -&gt; $j r)
And after simplifying more we get
        let $j = \v -&gt; &amp;&amp; E v
        in case x of { T -&gt; $j F; F -&gt; $j T }
Which is a Very Bad Thing

What we do now is this
        f E [..hole..]
        ==&gt;     let a = E
                in f a [..hole..]
Now if the thing in the hole is a case expression (which is when
we'll call mkDupableCont), we'll push the function call into the
branches, which is what we want.  Now RULES for f may fire, and
call-pattern specialisation.  Here's an example from Trac #3116
     go (n+1) (case l of
                 1  -&gt; bs'
                 _  -&gt; Chunk p fpc (o+1) (l-1) bs')
If we can push the call for 'go' inside the case, we get
call-pattern specialisation for 'go', which is *crucial* for
this program.

Here is the (&amp;&amp;) example:
        &amp;&amp; E (case x of { T -&gt; F; F -&gt; T })
  ==&gt;   let a = E in
        case x of { T -&gt; &amp;&amp; a F; F -&gt; &amp;&amp; a T }
Much better!

Notice that
  * Arguments to f *after* the strict one are handled by
    the ApplyToVal case of mkDupableCont.  Eg
        f [..hole..] E

  * We can only do the let-binding of E because the function
    part of a StrictArg continuation is an explicit syntax
    tree.  In earlier versions we represented it as a function
    (CoreExpr -&gt; CoreEpxr) which we couldn't take apart.

Do *not* duplicate StrictBind and StritArg continuations.  We gain
nothing by propagating them into the expressions, and we do lose a
lot.

The desire not to duplicate is the entire reason that
mkDupableCont returns a pair of continuations.

Note [Duplicating StrictBind]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Unlike StrictArg, there doesn't seem anything to gain from
duplicating a StrictBind continuation, so we don't.


************************************************************************
*                                                                      *
                    Unfoldings
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-3234"></a><span>
</span><a name="line-3235"></a><span class="hs-identifier">simplLetUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span>
</span><a name="line-3236"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-3237"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span>
</span><a name="line-3238"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-3239"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-3240"></a><a name="simplLetUnfolding"><a href="Simplify.html#simplLetUnfolding"><span class="hs-identifier">simplLetUnfolding</span></a></a><span> </span><a name="local-6989586621679789562"><a href="#local-6989586621679789562"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789563"><a href="#local-6989586621679789563"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679789564"><a href="#local-6989586621679789564"><span class="hs-identifier">cont_mb</span></a></a><span> </span><a name="local-6989586621679789565"><a href="#local-6989586621679789565"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621679789566"><a href="#local-6989586621679789566"><span class="hs-identifier">new_rhs</span></a></a><span> </span><a name="local-6989586621679789567"><a href="#local-6989586621679789567"><span class="hs-identifier">unf</span></a></a><span>
</span><a name="line-3241"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a><span> </span><a href="#local-6989586621679789567"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-3242"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Simplify.html#simplUnfolding"><span class="hs-identifier hs-var">simplUnfolding</span></a><span> </span><a href="#local-6989586621679789562"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789563"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621679789564"><span class="hs-identifier hs-var">cont_mb</span></a><span> </span><a href="#local-6989586621679789565"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621679789567"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-3243"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-3244"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789569"><span class="hs-identifier hs-var">is_bottoming</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>  </span><span class="hs-comment">-- See Note [Force bottoming field]</span><span>
</span><a name="line-3245"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789570"><a href="#local-6989586621679789570"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-3246"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreUnfold.html#mkUnfolding"><span class="hs-identifier hs-var">mkUnfolding</span></a><span> </span><a href="#local-6989586621679789570"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CoreSyn.html#InlineRhs"><span class="hs-identifier hs-var">InlineRhs</span></a><span> </span><a href="#local-6989586621679789568"><span class="hs-identifier hs-var">is_top_lvl</span></a><span> </span><a href="#local-6989586621679789569"><span class="hs-identifier hs-var">is_bottoming</span></a><span> </span><a href="#local-6989586621679789566"><span class="hs-identifier hs-var">new_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3247"></a><span>            </span><span class="hs-comment">-- We make an  unfolding *even for loop-breakers*.</span><span>
</span><a name="line-3248"></a><span>            </span><span class="hs-comment">-- Reason: (a) It might be useful to know that they are WHNF</span><span>
</span><a name="line-3249"></a><span>            </span><span class="hs-comment">--         (b) In TidyPgm we currently assume that, if we want to</span><span>
</span><a name="line-3250"></a><span>            </span><span class="hs-comment">--             expose the unfolding then indeed we *have* an unfolding</span><span>
</span><a name="line-3251"></a><span>            </span><span class="hs-comment">--             to expose.  (We could instead use the RHS, but currently</span><span>
</span><a name="line-3252"></a><span>            </span><span class="hs-comment">--             we don't.)  The simple thing is always to have one.</span><span>
</span><a name="line-3253"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3254"></a><span>    </span><a name="local-6989586621679789568"><a href="#local-6989586621679789568"><span class="hs-identifier">is_top_lvl</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a><span> </span><a href="#local-6989586621679789563"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-3255"></a><span>    </span><a name="local-6989586621679789569"><a href="#local-6989586621679789569"><span class="hs-identifier">is_bottoming</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#isBottomingId"><span class="hs-identifier hs-var">isBottomingId</span></a><span> </span><a href="#local-6989586621679789565"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-3256"></a><span>
</span><a name="line-3257"></a><span class="hs-identifier">simplUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span>
</span><a name="line-3258"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-3259"></a><span class="hs-comment">-- Note [Setting the new unfolding]</span><span>
</span><a name="line-3260"></a><a name="simplUnfolding"><a href="Simplify.html#simplUnfolding"><span class="hs-identifier">simplUnfolding</span></a></a><span> </span><a name="local-6989586621679789571"><a href="#local-6989586621679789571"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789572"><a href="#local-6989586621679789572"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621679789573"><a href="#local-6989586621679789573"><span class="hs-identifier">cont_mb</span></a></a><span> </span><a name="local-6989586621679789574"><a href="#local-6989586621679789574"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621679789575"><a href="#local-6989586621679789575"><span class="hs-identifier">unf</span></a></a><span>
</span><a name="line-3261"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679789575"><span class="hs-identifier hs-var">unf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-3262"></a><span>      </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789575"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-3263"></a><span>      </span><a href="CoreSyn.html#BootUnfolding"><span class="hs-identifier hs-var">BootUnfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789575"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-3264"></a><span>      </span><a href="CoreSyn.html#OtherCon"><span class="hs-identifier hs-var">OtherCon</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789575"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-3265"></a><span>
</span><a name="line-3266"></a><span>      </span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789580"><a href="#local-6989586621679789580"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_con</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789581"><a href="#local-6989586621679789581"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789582"><a href="#local-6989586621679789582"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3267"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789583"><a href="#local-6989586621679789583"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789584"><a href="#local-6989586621679789584"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplBinders"><span class="hs-identifier hs-var">simplBinders</span></a><span> </span><a href="#local-6989586621679789579"><span class="hs-identifier hs-var">rule_env</span></a><span> </span><a href="#local-6989586621679789580"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-3268"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789585"><a href="#local-6989586621679789585"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><a href="#local-6989586621679789583"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789582"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-3269"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreUnfold.html#mkDFunUnfolding"><span class="hs-identifier hs-var">mkDFunUnfolding</span></a><span> </span><a href="#local-6989586621679789584"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621679789581"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621679789585"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3270"></a><span>
</span><a name="line-3271"></a><span>      </span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789586"><a href="#local-6989586621679789586"><span class="hs-identifier">expr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789587"><a href="#local-6989586621679789587"><span class="hs-identifier">src</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_guidance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789588"><a href="#local-6989586621679789588"><span class="hs-identifier">guide</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3272"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span> </span><a href="#local-6989586621679789587"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-3273"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789590"><a href="#local-6989586621679789590"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a><span> </span><a href="#local-6989586621679789574"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-3274"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679789589"><a href="#local-6989586621679789589"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789573"><span class="hs-identifier hs-var">cont_mb</span></a><span>
</span><a name="line-3275"></a><span>                                 </span><span class="hs-keyword">in</span><span> </span><a href="Simplify.html#simplJoinRhs"><span class="hs-identifier hs-var">simplJoinRhs</span></a><span> </span><a href="#local-6989586621679789579"><span class="hs-identifier hs-var">rule_env</span></a><span> </span><a href="#local-6989586621679789574"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621679789586"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679789589"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-3276"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><a href="#local-6989586621679789579"><span class="hs-identifier hs-var">rule_env</span></a><span> </span><a href="#local-6989586621679789586"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-3277"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679789588"><span class="hs-identifier hs-var">guide</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-3278"></a><span>                  </span><a href="CoreSyn.html#UnfWhen"><span class="hs-identifier hs-var">UnfWhen</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ug_arity</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789591"><a href="#local-6989586621679789591"><span class="hs-identifier">arity</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ug_unsat_ok</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789592"><a href="#local-6989586621679789592"><span class="hs-identifier">sat_ok</span></a></a><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- Happens for INLINE things</span><span>
</span><a name="line-3279"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789593"><a href="#local-6989586621679789593"><span class="hs-identifier">guide'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#UnfWhen"><span class="hs-identifier hs-var">UnfWhen</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ug_arity</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789591"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ug_unsat_ok</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789592"><span class="hs-identifier hs-var">sat_ok</span></a><span>
</span><a name="line-3280"></a><span>                                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ug_boring_ok</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUnfold.html#inlineBoringOk"><span class="hs-identifier hs-var">inlineBoringOk</span></a><span> </span><a href="#local-6989586621679789590"><span class="hs-identifier hs-var">expr'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3281"></a><span>                        </span><span class="hs-comment">-- Refresh the boring-ok flag, in case expr'</span><span>
</span><a name="line-3282"></a><span>                        </span><span class="hs-comment">-- has got small. This happens, notably in the inlinings</span><span>
</span><a name="line-3283"></a><span>                        </span><span class="hs-comment">-- for dfuns for single-method classes; see</span><span>
</span><a name="line-3284"></a><span>                        </span><span class="hs-comment">-- Note [Single-method classes] in TcInstDcls.</span><span>
</span><a name="line-3285"></a><span>                        </span><span class="hs-comment">-- A test case is Trac #4138</span><span>
</span><a name="line-3286"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreUnfold.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a><span> </span><a href="#local-6989586621679789587"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621679789576"><span class="hs-identifier hs-var">is_top_lvl</span></a><span> </span><a href="#local-6989586621679789590"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621679789593"><span class="hs-identifier hs-var">guide'</span></a><span class="hs-special">)</span><span>
</span><a name="line-3287"></a><span>                            </span><span class="hs-comment">-- See Note [Top-level flag on inline rules] in CoreUnfold</span><span>
</span><a name="line-3288"></a><span>
</span><a name="line-3289"></a><span>                  </span><a name="local-6989586621679789594"><a href="#local-6989586621679789594"><span class="hs-identifier">_other</span></a></a><span>              </span><span class="hs-comment">-- Happens for INLINABLE things</span><span>
</span><a name="line-3290"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679789577"><span class="hs-identifier hs-var">is_bottoming</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-comment">-- See Note [Force bottoming field]</span><span>
</span><a name="line-3291"></a><span>                        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789595"><a href="#local-6989586621679789595"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-3292"></a><span>                           </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="CoreUnfold.html#mkUnfolding"><span class="hs-identifier hs-var">mkUnfolding</span></a><span> </span><a href="#local-6989586621679789595"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679789587"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621679789576"><span class="hs-identifier hs-var">is_top_lvl</span></a><span> </span><a href="#local-6989586621679789577"><span class="hs-identifier hs-var">is_bottoming</span></a><span> </span><a href="#local-6989586621679789590"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3293"></a><span>                </span><span class="hs-comment">-- If the guidance is UnfIfGoodArgs, this is an INLINABLE</span><span>
</span><a name="line-3294"></a><span>                </span><span class="hs-comment">-- unfolding, and we need to make sure the guidance is kept up</span><span>
</span><a name="line-3295"></a><span>                </span><span class="hs-comment">-- to date with respect to any changes in the unfolding.</span><span>
</span><a name="line-3296"></a><span>
</span><a name="line-3297"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="CoreSyn.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a><span>   </span><span class="hs-comment">-- Discard unstable unfoldings</span><span>
</span><a name="line-3298"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3299"></a><span>    </span><a name="local-6989586621679789576"><a href="#local-6989586621679789576"><span class="hs-identifier">is_top_lvl</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a><span> </span><a href="#local-6989586621679789572"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-3300"></a><span>    </span><a name="local-6989586621679789577"><a href="#local-6989586621679789577"><span class="hs-identifier">is_bottoming</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#isBottomingId"><span class="hs-identifier hs-var">isBottomingId</span></a><span> </span><a href="#local-6989586621679789574"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-3301"></a><span>    </span><a name="local-6989586621679789578"><a href="#local-6989586621679789578"><span class="hs-identifier">act</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-6989586621679789574"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-3302"></a><span>    </span><a name="local-6989586621679789579"><a href="#local-6989586621679789579"><span class="hs-identifier">rule_env</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#updMode"><span class="hs-identifier hs-var">updMode</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#updModeForStableUnfoldings"><span class="hs-identifier hs-var">updModeForStableUnfoldings</span></a><span> </span><a href="#local-6989586621679789578"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789571"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-3303"></a><span>         </span><span class="hs-comment">-- See Note [Simplifying inside stable unfoldings] in SimplUtils</span><span>
</span><a name="line-3304"></a><span>
</span><a name="line-3305"></a><span class="hs-comment">{-
Note [Force bottoming field]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to force bottoming, or the new unfolding holds
on to the old unfolding (which is part of the id).

Note [Setting the new unfolding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* If there's an INLINE pragma, we simplify the RHS gently.  Maybe we
  should do nothing at all, but simplifying gently might get rid of
  more crap.

* If not, we make an unfolding from the new RHS.  But *only* for
  non-loop-breakers. Making loop breakers not have an unfolding at all
  means that we can avoid tests in exprIsConApp, for example.  This is
  important: if exprIsConApp says 'yes' for a recursive thing, then we
  can get into an infinite loop

If there's an stable unfolding on a loop breaker (which happens for
INLINABLE), we hang on to the inlining.  It's pretty dodgy, but the
user did say 'INLINE'.  May need to revisit this choice.

************************************************************************
*                                                                      *
                    Rules
*                                                                      *
************************************************************************

Note [Rules in a letrec]
~~~~~~~~~~~~~~~~~~~~~~~~
After creating fresh binders for the binders of a letrec, we
substitute the RULES and add them back onto the binders; this is done
*before* processing any of the RHSs.  This is important.  Manuel found
cases where he really, really wanted a RULE for a recursive function
to apply in that function's own right-hand side.

See Note [Forming Rec groups] in OccurAnal
-}</span><span>
</span><a name="line-3343"></a><span>
</span><a name="line-3344"></a><span class="hs-identifier">addBndrRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-3345"></a><span class="hs-comment">-- Rules are added back into the bin</span><span>
</span><a name="line-3346"></a><a name="addBndrRules"><a href="Simplify.html#addBndrRules"><span class="hs-identifier">addBndrRules</span></a></a><span> </span><a name="local-6989586621679789596"><a href="#local-6989586621679789596"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789597"><a href="#local-6989586621679789597"><span class="hs-identifier">in_id</span></a></a><span> </span><a name="local-6989586621679789598"><a href="#local-6989586621679789598"><span class="hs-identifier">out_id</span></a></a><span>
</span><a name="line-3347"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621679789599"><span class="hs-identifier hs-var">old_rules</span></a><span>
</span><a name="line-3348"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789596"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789598"><span class="hs-identifier hs-var">out_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-3349"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-3350"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679789600"><a href="#local-6989586621679789600"><span class="hs-identifier">new_rules</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplRules"><span class="hs-identifier hs-var">simplRules</span></a><span> </span><a href="#local-6989586621679789596"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-6989586621679789598"><span class="hs-identifier hs-var">out_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789599"><span class="hs-identifier hs-var">old_rules</span></a><span>
</span><a name="line-3351"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789601"><a href="#local-6989586621679789601"><span class="hs-identifier">final_id</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789598"><span class="hs-identifier hs-var">out_id</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdSpecialisation"><span class="hs-identifier hs-var">setIdSpecialisation</span></a><span class="hs-special">`</span><span> </span><a href="Rules.html#mkRuleInfo"><span class="hs-identifier hs-var">mkRuleInfo</span></a><span> </span><a href="#local-6989586621679789600"><span class="hs-identifier hs-var">new_rules</span></a><span>
</span><a name="line-3352"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a><span> </span><a href="#local-6989586621679789596"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789601"><span class="hs-identifier hs-var">final_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679789601"><span class="hs-identifier hs-var">final_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3353"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3354"></a><span>    </span><a name="local-6989586621679789599"><a href="#local-6989586621679789599"><span class="hs-identifier">old_rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#ruleInfoRules"><span class="hs-identifier hs-var">ruleInfoRules</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idSpecialisation"><span class="hs-identifier hs-var">idSpecialisation</span></a><span> </span><a href="#local-6989586621679789597"><span class="hs-identifier hs-var">in_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-3355"></a><span>
</span><a name="line-3356"></a><span class="hs-identifier">simplRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-3357"></a><a name="simplRules"><a href="Simplify.html#simplRules"><span class="hs-identifier">simplRules</span></a></a><span> </span><a name="local-6989586621679789602"><a href="#local-6989586621679789602"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679789603"><a href="#local-6989586621679789603"><span class="hs-identifier">mb_new_nm</span></a></a><span> </span><a name="local-6989586621679789604"><a href="#local-6989586621679789604"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-3358"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="#local-6989586621679789605"><span class="hs-identifier hs-var">simpl_rule</span></a><span> </span><a href="#local-6989586621679789604"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-3359"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3360"></a><span>    </span><a name="local-6989586621679789605"><a href="#local-6989586621679789605"><span class="hs-identifier">simpl_rule</span></a></a><span> </span><a name="local-6989586621679789606"><a href="#local-6989586621679789606"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-3361"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679789606"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-3362"></a><span>
</span><a name="line-3363"></a><span>    </span><span class="hs-identifier">simpl_rule</span><span> </span><a name="local-6989586621679789607"><a href="#local-6989586621679789607"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789608"><a href="#local-6989586621679789608"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789609"><a href="#local-6989586621679789609"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-3364"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789610"><a href="#local-6989586621679789610"><span class="hs-identifier">fn_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679789611"><a href="#local-6989586621679789611"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-3365"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679789612"><a href="#local-6989586621679789612"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679789613"><a href="#local-6989586621679789613"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplEnv.html#simplBinders"><span class="hs-identifier hs-var">simplBinders</span></a><span> </span><a href="#local-6989586621679789602"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679789608"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-3366"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679789614"><a href="#local-6989586621679789614"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621679789612"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621679789611"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-3367"></a><span>                 </span><a name="local-6989586621679789615"><a href="#local-6989586621679789615"><span class="hs-identifier">rule_cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span> </span><a href="#local-6989586621679789614"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-3368"></a><span>                 </span><a name="local-6989586621679789616"><a href="#local-6989586621679789616"><span class="hs-identifier">rule_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#updMode"><span class="hs-identifier hs-var">updMode</span></a><span> </span><a href="SimplUtils.html#updModeForRules"><span class="hs-identifier hs-var">updModeForRules</span></a><span> </span><a href="#local-6989586621679789612"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-3369"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789617"><a href="#local-6989586621679789617"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><a href="#local-6989586621679789616"><span class="hs-identifier hs-var">rule_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679789609"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-3370"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621679789618"><a href="#local-6989586621679789618"><span class="hs-identifier">rhs'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a><span> </span><a href="#local-6989586621679789616"><span class="hs-identifier hs-var">rule_env</span></a><span> </span><a href="#local-6989586621679789611"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679789615"><span class="hs-identifier hs-var">rule_cont</span></a><span>
</span><a name="line-3371"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679789607"><span class="hs-identifier hs-var">rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789613"><span class="hs-identifier hs-var">bndrs'</span></a><span>
</span><a name="line-3372"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_fn</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789603"><span class="hs-identifier hs-var">mb_new_nm</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679789610"><span class="hs-identifier hs-var">fn_name</span></a><span>
</span><a name="line-3373"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789617"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-3374"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679789618"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3375"></a></pre></body></html>